
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>我的FTP Server——ftp.py - EverET.org</title>
  <meta name="author" content="Stupid ET">

  
  <meta name="description" content="在上文中，我们简要地学习了下FTP协议，链接 http://everet.org/2012/03/ftp-protocol.html。 有兴趣的同学们可以去围观下。 因为最近偶看了下FTP协议，所以决定写个FTP Server玩玩。毕竟一直写的都是应用程序，于是乎想写下服务器端的程序。 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://everet.org/2012/03/ftp-server.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="EverET.org" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-28529727-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">EverET.org</a></h1>
  
    <h2>Yesterday is a history. Tomorrow is a mystery. Only Today is a gift.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:everet.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/archives">Archives</a></li>
  <li><a href="/my-works">Works</a></li>
  <li><a href="http://414112390.qzone.qq.com/#!app=4" target="_blank">Albums</a></li>
  <li><a href="/liuyana">Msg Board</a></li>
  <li><a href="/about-me">About Me</a></li>
  <li><a href="http://github.com/cedricporter">et@github</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">我的FTP Server——ftp.py</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-24T10:35:06+08:00" pubdate data-updated="true">2012-03-24</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content">
  <p>在上文中，我们简要地学习了下FTP协议，链接 <a href="http://everet.org/2012/03/ftp-protocol.html">http://everet.org/2012/03/ftp-protocol.html</a>。</p>

<p>有兴趣的同学们可以去围观下。</p>

<p>因为最近偶看了下FTP协议，所以决定写个FTP Server玩玩。毕竟一直写的都是应用程序，于是乎想写下服务器端的程序。</p>

<p>结果就有了ftp.py，名字灵感来源于web.py。</p>

<h2 id="ftppy">ftp.py</h2>

<p>ftp.py由Python 2.x实现。目前有部署到我的服务器上。支持Windows、Unix和类Unix系统。支持多线程模式和多进程模式，不过在Windows上仅支持多线程模式。支持虚拟用户。</p>

<p>其中多进程模式支持以其他用户身份运行，加强了安全性。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>bash  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">usage: ftp.py <span class="o">[</span>-d<span class="o">]</span> <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>-p port<span class="o">]</span> <span class="o">[</span>-o<span class="o">]</span> <span class="o">[</span>-t<span class="o">]</span>
</span><span class="line">    -d become a daemon
</span><span class="line">    -h <span class="nb">help</span>
</span><span class="line">    -p listen port
</span><span class="line">    -o output log to stdout, by default, it outputs to a log file.
</span><span class="line">    -t thread mode, fork model by default
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>其中用户设置写在ftp.py.config中，如果文件不存在则默认使用anonymous账户。</p>

<p>用户设置文件ftp.py.config格式如下：</p>

<blockquote>
  <p>account_info = {
‘et’:{‘pass’:’123456789’, ‘home_dir’:’/root/’},
‘lst’:{‘pass’:’987654321’, ‘home_dir’:’/tmp/’}
}</p>
</blockquote>

<p>也就是账户名+密码+家目录路径。</p>

<h2 id="ftppyconfig">ftp.py.config</h2>

<p>我们还可以在ftp.py的同级目录中通过ftp.py.config设置我们的FTP Server。</p>

<p>最大用户连接数 limit_connection_number </p>

<p>&#8220;超时时间（单位：秒）timeout</p>

<p>&#8220;默认家目录：default_home_dir</p>

<p>日志文件：logfile</p>

<p>运行的用户身份：runas_user</p>

<h3 id="section">默认值为：</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>python  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">limit_connection_number</span> <span class="o">=</span> <span class="mi">5</span>     <span class="c"># max client number</span>
</span><span class="line"><span class="n">timeout</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">3</span>                <span class="c"># timeout in second</span>
</span><span class="line"><span class="n">default_home_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">)</span>
</span><span class="line"><span class="n">logfile</span> <span class="o">=</span> <span class="s">&#39;/var/log/ftp.py.log&#39;</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;posix&#39;</span> <span class="k">else</span> <span class="n">default_home_dir</span> <span class="o">+</span> <span class="s">&#39;ftp.py.log&#39;</span>
</span><span class="line"><span class="n">runas_user</span> <span class="o">=</span> <span class="s">&#39;www-data&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="more---">源码如下：<!-- more --></h3>

<p>最新的源码请见Git: <a href="https://github.com/cedricporter/ftp.py">https://github.com/cedricporter/ftp.py</a></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>python  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
<span class="line-number">81</span>
<span class="line-number">82</span>
<span class="line-number">83</span>
<span class="line-number">84</span>
<span class="line-number">85</span>
<span class="line-number">86</span>
<span class="line-number">87</span>
<span class="line-number">88</span>
<span class="line-number">89</span>
<span class="line-number">90</span>
<span class="line-number">91</span>
<span class="line-number">92</span>
<span class="line-number">93</span>
<span class="line-number">94</span>
<span class="line-number">95</span>
<span class="line-number">96</span>
<span class="line-number">97</span>
<span class="line-number">98</span>
<span class="line-number">99</span>
<span class="line-number">100</span>
<span class="line-number">101</span>
<span class="line-number">102</span>
<span class="line-number">103</span>
<span class="line-number">104</span>
<span class="line-number">105</span>
<span class="line-number">106</span>
<span class="line-number">107</span>
<span class="line-number">108</span>
<span class="line-number">109</span>
<span class="line-number">110</span>
<span class="line-number">111</span>
<span class="line-number">112</span>
<span class="line-number">113</span>
<span class="line-number">114</span>
<span class="line-number">115</span>
<span class="line-number">116</span>
<span class="line-number">117</span>
<span class="line-number">118</span>
<span class="line-number">119</span>
<span class="line-number">120</span>
<span class="line-number">121</span>
<span class="line-number">122</span>
<span class="line-number">123</span>
<span class="line-number">124</span>
<span class="line-number">125</span>
<span class="line-number">126</span>
<span class="line-number">127</span>
<span class="line-number">128</span>
<span class="line-number">129</span>
<span class="line-number">130</span>
<span class="line-number">131</span>
<span class="line-number">132</span>
<span class="line-number">133</span>
<span class="line-number">134</span>
<span class="line-number">135</span>
<span class="line-number">136</span>
<span class="line-number">137</span>
<span class="line-number">138</span>
<span class="line-number">139</span>
<span class="line-number">140</span>
<span class="line-number">141</span>
<span class="line-number">142</span>
<span class="line-number">143</span>
<span class="line-number">144</span>
<span class="line-number">145</span>
<span class="line-number">146</span>
<span class="line-number">147</span>
<span class="line-number">148</span>
<span class="line-number">149</span>
<span class="line-number">150</span>
<span class="line-number">151</span>
<span class="line-number">152</span>
<span class="line-number">153</span>
<span class="line-number">154</span>
<span class="line-number">155</span>
<span class="line-number">156</span>
<span class="line-number">157</span>
<span class="line-number">158</span>
<span class="line-number">159</span>
<span class="line-number">160</span>
<span class="line-number">161</span>
<span class="line-number">162</span>
<span class="line-number">163</span>
<span class="line-number">164</span>
<span class="line-number">165</span>
<span class="line-number">166</span>
<span class="line-number">167</span>
<span class="line-number">168</span>
<span class="line-number">169</span>
<span class="line-number">170</span>
<span class="line-number">171</span>
<span class="line-number">172</span>
<span class="line-number">173</span>
<span class="line-number">174</span>
<span class="line-number">175</span>
<span class="line-number">176</span>
<span class="line-number">177</span>
<span class="line-number">178</span>
<span class="line-number">179</span>
<span class="line-number">180</span>
<span class="line-number">181</span>
<span class="line-number">182</span>
<span class="line-number">183</span>
<span class="line-number">184</span>
<span class="line-number">185</span>
<span class="line-number">186</span>
<span class="line-number">187</span>
<span class="line-number">188</span>
<span class="line-number">189</span>
<span class="line-number">190</span>
<span class="line-number">191</span>
<span class="line-number">192</span>
<span class="line-number">193</span>
<span class="line-number">194</span>
<span class="line-number">195</span>
<span class="line-number">196</span>
<span class="line-number">197</span>
<span class="line-number">198</span>
<span class="line-number">199</span>
<span class="line-number">200</span>
<span class="line-number">201</span>
<span class="line-number">202</span>
<span class="line-number">203</span>
<span class="line-number">204</span>
<span class="line-number">205</span>
<span class="line-number">206</span>
<span class="line-number">207</span>
<span class="line-number">208</span>
<span class="line-number">209</span>
<span class="line-number">210</span>
<span class="line-number">211</span>
<span class="line-number">212</span>
<span class="line-number">213</span>
<span class="line-number">214</span>
<span class="line-number">215</span>
<span class="line-number">216</span>
<span class="line-number">217</span>
<span class="line-number">218</span>
<span class="line-number">219</span>
<span class="line-number">220</span>
<span class="line-number">221</span>
<span class="line-number">222</span>
<span class="line-number">223</span>
<span class="line-number">224</span>
<span class="line-number">225</span>
<span class="line-number">226</span>
<span class="line-number">227</span>
<span class="line-number">228</span>
<span class="line-number">229</span>
<span class="line-number">230</span>
<span class="line-number">231</span>
<span class="line-number">232</span>
<span class="line-number">233</span>
<span class="line-number">234</span>
<span class="line-number">235</span>
<span class="line-number">236</span>
<span class="line-number">237</span>
<span class="line-number">238</span>
<span class="line-number">239</span>
<span class="line-number">240</span>
<span class="line-number">241</span>
<span class="line-number">242</span>
<span class="line-number">243</span>
<span class="line-number">244</span>
<span class="line-number">245</span>
<span class="line-number">246</span>
<span class="line-number">247</span>
<span class="line-number">248</span>
<span class="line-number">249</span>
<span class="line-number">250</span>
<span class="line-number">251</span>
<span class="line-number">252</span>
<span class="line-number">253</span>
<span class="line-number">254</span>
<span class="line-number">255</span>
<span class="line-number">256</span>
<span class="line-number">257</span>
<span class="line-number">258</span>
<span class="line-number">259</span>
<span class="line-number">260</span>
<span class="line-number">261</span>
<span class="line-number">262</span>
<span class="line-number">263</span>
<span class="line-number">264</span>
<span class="line-number">265</span>
<span class="line-number">266</span>
<span class="line-number">267</span>
<span class="line-number">268</span>
<span class="line-number">269</span>
<span class="line-number">270</span>
<span class="line-number">271</span>
<span class="line-number">272</span>
<span class="line-number">273</span>
<span class="line-number">274</span>
<span class="line-number">275</span>
<span class="line-number">276</span>
<span class="line-number">277</span>
<span class="line-number">278</span>
<span class="line-number">279</span>
<span class="line-number">280</span>
<span class="line-number">281</span>
<span class="line-number">282</span>
<span class="line-number">283</span>
<span class="line-number">284</span>
<span class="line-number">285</span>
<span class="line-number">286</span>
<span class="line-number">287</span>
<span class="line-number">288</span>
<span class="line-number">289</span>
<span class="line-number">290</span>
<span class="line-number">291</span>
<span class="line-number">292</span>
<span class="line-number">293</span>
<span class="line-number">294</span>
<span class="line-number">295</span>
<span class="line-number">296</span>
<span class="line-number">297</span>
<span class="line-number">298</span>
<span class="line-number">299</span>
<span class="line-number">300</span>
<span class="line-number">301</span>
<span class="line-number">302</span>
<span class="line-number">303</span>
<span class="line-number">304</span>
<span class="line-number">305</span>
<span class="line-number">306</span>
<span class="line-number">307</span>
<span class="line-number">308</span>
<span class="line-number">309</span>
<span class="line-number">310</span>
<span class="line-number">311</span>
<span class="line-number">312</span>
<span class="line-number">313</span>
<span class="line-number">314</span>
<span class="line-number">315</span>
<span class="line-number">316</span>
<span class="line-number">317</span>
<span class="line-number">318</span>
<span class="line-number">319</span>
<span class="line-number">320</span>
<span class="line-number">321</span>
<span class="line-number">322</span>
<span class="line-number">323</span>
<span class="line-number">324</span>
<span class="line-number">325</span>
<span class="line-number">326</span>
<span class="line-number">327</span>
<span class="line-number">328</span>
<span class="line-number">329</span>
<span class="line-number">330</span>
<span class="line-number">331</span>
<span class="line-number">332</span>
<span class="line-number">333</span>
<span class="line-number">334</span>
<span class="line-number">335</span>
<span class="line-number">336</span>
<span class="line-number">337</span>
<span class="line-number">338</span>
<span class="line-number">339</span>
<span class="line-number">340</span>
<span class="line-number">341</span>
<span class="line-number">342</span>
<span class="line-number">343</span>
<span class="line-number">344</span>
<span class="line-number">345</span>
<span class="line-number">346</span>
<span class="line-number">347</span>
<span class="line-number">348</span>
<span class="line-number">349</span>
<span class="line-number">350</span>
<span class="line-number">351</span>
<span class="line-number">352</span>
<span class="line-number">353</span>
<span class="line-number">354</span>
<span class="line-number">355</span>
<span class="line-number">356</span>
<span class="line-number">357</span>
<span class="line-number">358</span>
<span class="line-number">359</span>
<span class="line-number">360</span>
<span class="line-number">361</span>
<span class="line-number">362</span>
<span class="line-number">363</span>
<span class="line-number">364</span>
<span class="line-number">365</span>
<span class="line-number">366</span>
<span class="line-number">367</span>
<span class="line-number">368</span>
<span class="line-number">369</span>
<span class="line-number">370</span>
<span class="line-number">371</span>
<span class="line-number">372</span>
<span class="line-number">373</span>
<span class="line-number">374</span>
<span class="line-number">375</span>
<span class="line-number">376</span>
<span class="line-number">377</span>
<span class="line-number">378</span>
<span class="line-number">379</span>
<span class="line-number">380</span>
<span class="line-number">381</span>
<span class="line-number">382</span>
<span class="line-number">383</span>
<span class="line-number">384</span>
<span class="line-number">385</span>
<span class="line-number">386</span>
<span class="line-number">387</span>
<span class="line-number">388</span>
<span class="line-number">389</span>
<span class="line-number">390</span>
<span class="line-number">391</span>
<span class="line-number">392</span>
<span class="line-number">393</span>
<span class="line-number">394</span>
<span class="line-number">395</span>
<span class="line-number">396</span>
<span class="line-number">397</span>
<span class="line-number">398</span>
<span class="line-number">399</span>
<span class="line-number">400</span>
<span class="line-number">401</span>
<span class="line-number">402</span>
<span class="line-number">403</span>
<span class="line-number">404</span>
<span class="line-number">405</span>
<span class="line-number">406</span>
<span class="line-number">407</span>
<span class="line-number">408</span>
<span class="line-number">409</span>
<span class="line-number">410</span>
<span class="line-number">411</span>
<span class="line-number">412</span>
<span class="line-number">413</span>
<span class="line-number">414</span>
<span class="line-number">415</span>
<span class="line-number">416</span>
<span class="line-number">417</span>
<span class="line-number">418</span>
<span class="line-number">419</span>
<span class="line-number">420</span>
<span class="line-number">421</span>
<span class="line-number">422</span>
<span class="line-number">423</span>
<span class="line-number">424</span>
<span class="line-number">425</span>
<span class="line-number">426</span>
<span class="line-number">427</span>
<span class="line-number">428</span>
<span class="line-number">429</span>
<span class="line-number">430</span>
<span class="line-number">431</span>
<span class="line-number">432</span>
<span class="line-number">433</span>
<span class="line-number">434</span>
<span class="line-number">435</span>
<span class="line-number">436</span>
<span class="line-number">437</span>
<span class="line-number">438</span>
<span class="line-number">439</span>
<span class="line-number">440</span>
<span class="line-number">441</span>
<span class="line-number">442</span>
<span class="line-number">443</span>
<span class="line-number">444</span>
<span class="line-number">445</span>
<span class="line-number">446</span>
<span class="line-number">447</span>
<span class="line-number">448</span>
<span class="line-number">449</span>
<span class="line-number">450</span>
<span class="line-number">451</span>
<span class="line-number">452</span>
<span class="line-number">453</span>
<span class="line-number">454</span>
<span class="line-number">455</span>
<span class="line-number">456</span>
<span class="line-number">457</span>
<span class="line-number">458</span>
<span class="line-number">459</span>
<span class="line-number">460</span>
<span class="line-number">461</span>
<span class="line-number">462</span>
<span class="line-number">463</span>
<span class="line-number">464</span>
<span class="line-number">465</span>
<span class="line-number">466</span>
<span class="line-number">467</span>
<span class="line-number">468</span>
<span class="line-number">469</span>
<span class="line-number">470</span>
<span class="line-number">471</span>
<span class="line-number">472</span>
<span class="line-number">473</span>
<span class="line-number">474</span>
<span class="line-number">475</span>
<span class="line-number">476</span>
<span class="line-number">477</span>
<span class="line-number">478</span>
<span class="line-number">479</span>
<span class="line-number">480</span>
<span class="line-number">481</span>
<span class="line-number">482</span>
<span class="line-number">483</span>
<span class="line-number">484</span>
<span class="line-number">485</span>
<span class="line-number">486</span>
<span class="line-number">487</span>
<span class="line-number">488</span>
<span class="line-number">489</span>
<span class="line-number">490</span>
<span class="line-number">491</span>
<span class="line-number">492</span>
<span class="line-number">493</span>
<span class="line-number">494</span>
<span class="line-number">495</span>
<span class="line-number">496</span>
<span class="line-number">497</span>
<span class="line-number">498</span>
<span class="line-number">499</span>
<span class="line-number">500</span>
<span class="line-number">501</span>
<span class="line-number">502</span>
<span class="line-number">503</span>
<span class="line-number">504</span>
<span class="line-number">505</span>
<span class="line-number">506</span>
<span class="line-number">507</span>
<span class="line-number">508</span>
<span class="line-number">509</span>
<span class="line-number">510</span>
<span class="line-number">511</span>
<span class="line-number">512</span>
<span class="line-number">513</span>
<span class="line-number">514</span>
<span class="line-number">515</span>
<span class="line-number">516</span>
<span class="line-number">517</span>
<span class="line-number">518</span>
<span class="line-number">519</span>
<span class="line-number">520</span>
<span class="line-number">521</span>
<span class="line-number">522</span>
<span class="line-number">523</span>
<span class="line-number">524</span>
<span class="line-number">525</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c">#!/usr/bin/env python</span>
</span><span class="line"><span class="c"># author:  Hua Liang [ Stupid ET ]</span>
</span><span class="line"><span class="c"># email:   et@everet.org</span>
</span><span class="line"><span class="c"># website: http://EverET.org</span>
</span><span class="line"><span class="c">#</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">socket</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">stat</span><span class="o">,</span> <span class="nn">threading</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">struct</span><span class="o">,</span> <span class="nn">getopt</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">signal</span><span class="o">,</span> <span class="nn">select</span><span class="o">,</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">logging.handlers</span>
</span><span class="line">
</span><span class="line"><span class="n">host</span> <span class="o">=</span> <span class="s">&#39;0.0.0.0&#39;</span>
</span><span class="line"><span class="n">port</span> <span class="o">=</span> <span class="mi">21</span>
</span><span class="line"><span class="n">limit_connection_number</span> <span class="o">=</span> <span class="mi">5</span>     <span class="c"># max client number</span>
</span><span class="line"><span class="n">timeout</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">3</span>                <span class="c"># timeout in second</span>
</span><span class="line"><span class="n">default_home_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">)</span>
</span><span class="line"><span class="n">logfile</span> <span class="o">=</span> <span class="s">&#39;/var/log/ftp.py.log&#39;</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;posix&#39;</span> <span class="k">else</span> <span class="n">default_home_dir</span> <span class="o">+</span> <span class="s">&#39;ftp.py.log&#39;</span>
</span><span class="line">
</span><span class="line"><span class="n">runas_user</span> <span class="o">=</span> <span class="s">&#39;www-data&#39;</span>
</span><span class="line"><span class="n">global_options</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;run_mode&#39;</span><span class="p">:</span><span class="s">&#39;fork&#39;</span><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="c"># current working directory</span>
</span><span class="line"><span class="n">account_info</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">    <span class="s">&#39;anonymous&#39;</span><span class="p">:{</span><span class="s">&#39;pass&#39;</span><span class="p">:</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;home_dir&#39;</span><span class="p">:</span><span class="n">default_home_dir</span><span class="p">,</span> <span class="s">&#39;runas_user&#39;</span><span class="p">:</span><span class="n">runas_user</span><span class="p">},</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">runas</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
</span><span class="line">    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s">&#39;posix&#39;</span><span class="p">:</span> <span class="k">return</span>
</span><span class="line">    <span class="n">uid</span> <span class="o">=</span> <span class="n">get_uid</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
</span><span class="line">    <span class="n">os</span><span class="o">.</span><span class="n">setgid</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
</span><span class="line">    <span class="n">os</span><span class="o">.</span><span class="n">setuid</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">FTPConnection</span><span class="p">:</span>
</span><span class="line">    <span class="sd">&#39;&#39;&#39;You can add handle func by startswith handle_ prefix.</span>
</span><span class="line"><span class="sd">    When the connection receives CWD command, it&#39;ll use handle_CWD to handle it.</span>
</span><span class="line"><span class="sd">    &#39;&#39;&#39;</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">remote_ip</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">fd</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;pasv&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;utf8&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">data_host</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">data_port</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">localhost</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">home_dir</span> <span class="o">=</span> <span class="n">default_home_dir</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">curr_dir</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">handler</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span class="line">            <span class="p">[(</span><span class="n">method</span><span class="p">[</span><span class="mi">7</span><span class="p">:],</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">))</span> \
</span><span class="line">            <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> \
</span><span class="line">            <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;handle_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">))])</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="k">try</span><span class="p">:</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">say_welcome</span><span class="p">()</span>
</span><span class="line">            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
</span><span class="line">                <span class="n">success</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">arg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span><span class="line">                <span class="n">command</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span class="line">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;utf8&#39;</span><span class="p">]:</span>
</span><span class="line">                    <span class="n">arg</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&#39;utf8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">())</span>
</span><span class="line">                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;[ &#39;</span> <span class="o">+</span> <span class="n">command</span> <span class="o">+</span> <span class="s">&#39; ] &#39;</span> <span class="o">+</span> <span class="n">arg</span><span class="p">)</span>
</span><span class="line">                <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
</span><span class="line">                    <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&quot;Failed&quot;</span><span class="p">)</span>
</span><span class="line">                    <span class="k">continue</span>
</span><span class="line">                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
</span><span class="line">                    <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&quot;Command Not Found&quot;</span><span class="p">)</span>
</span><span class="line">                    <span class="k">continue</span>
</span><span class="line">                <span class="k">try</span><span class="p">:</span>
</span><span class="line">                    <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="p">[</span><span class="n">command</span><span class="p">](</span><span class="n">arg</span><span class="p">)</span>
</span><span class="line">                <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class="line">                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class="line">                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;in start&quot;</span><span class="p">)</span>
</span><span class="line">                    <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&#39;Permission denied&#39;</span><span class="p">)</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">say_bye</span><span class="p">()</span>
</span><span class="line">        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class="line">            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class="line">            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;in start&quot;</span><span class="p">)</span>
</span><span class="line">        <span class="k">finally</span><span class="p">:</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;FTP connnection done.&quot;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">        <span class="k">return</span> <span class="bp">True</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">send_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span class="line">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;utf8&#39;</span><span class="p">]:</span>
</span><span class="line">            <span class="n">msg</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">())</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span>
</span><span class="line">        <span class="n">message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">msg</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">fd</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">recv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="sd">&#39;&#39;&#39;returns 3 tuples, success, command, arg&#39;&#39;&#39;</span>
</span><span class="line">        <span class="k">try</span><span class="p">:</span>
</span><span class="line">            <span class="n">success</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">arg</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span>
</span><span class="line">            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class="line">                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fd</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
</span><span class="line">                <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span> <span class="ow">or</span> <span class="n">data</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span class="line">                    <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class="line">                    <span class="n">success</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class="line">                    <span class="k">break</span>
</span><span class="line">                <span class="n">buf</span> <span class="o">+=</span> <span class="n">data</span>
</span><span class="line">                <span class="k">if</span> <span class="n">buf</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">:</span> <span class="k">break</span>
</span><span class="line">            <span class="n">split</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
</span><span class="line">            <span class="n">command</span><span class="p">,</span> <span class="n">arg</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[:</span><span class="n">split</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="n">split</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">if</span> <span class="n">split</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
</span><span class="line">        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class="line">            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class="line">            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;in recv&quot;</span><span class="p">)</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class="line">            <span class="n">success</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class="line">
</span><span class="line">        <span class="k">return</span> <span class="n">success</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">arg</span>
</span><span class="line">
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">say_welcome</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">220</span><span class="p">,</span> <span class="s">&quot;Welcome to EverET.org FTP&quot;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">say_bye</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">handle_BYE</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">data_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="sd">&#39;&#39;&#39;establish data connection&#39;&#39;&#39;</span>
</span><span class="line">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&quot;no data connection&quot;</span><span class="p">)</span>
</span><span class="line">            <span class="k">return</span> <span class="bp">False</span>
</span><span class="line">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;pasv&#39;</span><span class="p">]:</span>
</span><span class="line">            <span class="n">fd</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span> <span class="o">=</span> <span class="n">fd</span>
</span><span class="line">        <span class="k">else</span><span class="p">:</span>
</span><span class="line">            <span class="k">try</span><span class="p">:</span>
</span><span class="line">                <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_port</span><span class="p">))</span>
</span><span class="line">            <span class="k">except</span><span class="p">:</span>
</span><span class="line">                <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&quot;failed to connect&quot;</span><span class="p">)</span>
</span><span class="line">                <span class="k">return</span> <span class="bp">False</span>
</span><span class="line">        <span class="k">return</span> <span class="bp">True</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">close_data_fd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">parse_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
</span><span class="line">        <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span> <span class="n">path</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span>
</span><span class="line">        <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;/&#39;</span><span class="p">:</span> <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_dir</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">path</span>
</span><span class="line">        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;parse_path &#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
</span><span class="line">        <span class="n">split_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
</span><span class="line">        <span class="n">remote</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class="line">        <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">home_dir</span>
</span><span class="line">        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">split_path</span><span class="p">:</span>
</span><span class="line">            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;..&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">item</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span> <span class="k">continue</span> <span class="c"># ignore parent directory</span>
</span><span class="line">            <span class="n">remote</span> <span class="o">+=</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">item</span>
</span><span class="line">            <span class="n">local</span> <span class="o">+=</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">item</span>
</span><span class="line">        <span class="k">if</span> <span class="n">remote</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span> <span class="n">remote</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span>
</span><span class="line">        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">split_path</span><span class="p">)</span>
</span><span class="line">        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;remote: </span><span class="si">%s</span><span class="s">  local: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="n">local</span><span class="p">))</span>
</span><span class="line">        <span class="k">return</span> <span class="n">remote</span><span class="p">,</span> <span class="n">local</span>
</span><span class="line">
</span><span class="line">    <span class="c"># Command Handlers</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_USER</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class="line">        <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">account_info</span><span class="p">:</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">arg</span>
</span><span class="line">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s">&#39;anonymous&#39;</span><span class="p">:</span>
</span><span class="line">                <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">230</span><span class="p">,</span> <span class="s">&#39;OK&#39;</span><span class="p">)</span>
</span><span class="line">            <span class="k">else</span><span class="p">:</span>
</span><span class="line">                <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">331</span><span class="p">,</span> <span class="s">&quot;Need password&quot;</span><span class="p">)</span>
</span><span class="line">        <span class="k">else</span><span class="p">:</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&quot;Invalid User&quot;</span><span class="p">)</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_PASS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class="line">        <span class="k">if</span> <span class="n">arg</span> <span class="o">==</span> <span class="n">account_info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">][</span><span class="s">&#39;pass&#39;</span><span class="p">]:</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">home_dir</span> <span class="o">=</span> <span class="n">account_info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">][</span><span class="s">&#39;home_dir&#39;</span><span class="p">]</span>
</span><span class="line">            <span class="k">if</span> <span class="n">account_info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">]</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;runas_user&#39;</span><span class="p">):</span>
</span><span class="line">                <span class="n">user</span> <span class="o">=</span> <span class="n">account_info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">][</span><span class="s">&#39;runas_user&#39;</span><span class="p">]</span>
</span><span class="line">            <span class="k">else</span><span class="p">:</span>
</span><span class="line">                <span class="n">user</span> <span class="o">=</span> <span class="s">&#39;www-data&#39;</span>
</span><span class="line">            <span class="n">runas</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class="line">            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">home_dir</span><span class="p">):</span>
</span><span class="line">                <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">230</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class="line">                <span class="k">return</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">530</span><span class="p">,</span> <span class="s">&quot;Password is not corrected&quot;</span><span class="p">)</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_QUIT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">handle_BYE</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_BYE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_CDUP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">handle_CWD</span><span class="p">(</span><span class="s">&#39;..&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_XPWD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">handle_PWD</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_PWD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class="line">        <span class="n">remote</span><span class="p">,</span> <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_dir</span><span class="p">)</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">257</span><span class="p">,</span> <span class="s">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">remote</span> <span class="o">+</span> <span class="s">&#39;&quot;&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_CWD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class="line">        <span class="n">remote</span><span class="p">,</span> <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_path</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class="line">        <span class="k">try</span><span class="p">:</span>
</span><span class="line">            <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">curr_dir</span> <span class="o">=</span> <span class="n">remote</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class="line">        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class="line">            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class="line">            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;in cwd&quot;</span><span class="p">)</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&quot;Change directory failed!&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_SIZE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class="line">        <span class="n">remote</span><span class="p">,</span> <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_dir</span><span class="p">)</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">231</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">local</span><span class="p">)))</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_SYST</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">215</span><span class="p">,</span> <span class="s">&quot;UNIX&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_STOR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class="line">        <span class="n">remote</span><span class="p">,</span> <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_path</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class="line">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_connect</span><span class="p">():</span> <span class="k">return</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">125</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class="line">        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
</span><span class="line">        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class="line">            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">8192</span><span class="p">)</span>
</span><span class="line">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">break</span>
</span><span class="line">            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class="line">        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">close_data_fd</span><span class="p">()</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">226</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_RETR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class="line">        <span class="n">remote</span><span class="p">,</span> <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_path</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class="line">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_connect</span><span class="p">():</span> <span class="k">return</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">125</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class="line">        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
</span><span class="line">        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class="line">            <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8192</span><span class="p">)</span>
</span><span class="line">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">break</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class="line">        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">close_data_fd</span><span class="p">()</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">226</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_TYPE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">220</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_RNFR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class="line">        <span class="n">remote</span><span class="p">,</span> <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_path</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">rename_tmp_path</span> <span class="o">=</span> <span class="n">local</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">350</span><span class="p">,</span> <span class="s">&#39;rename from &#39;</span> <span class="o">+</span> <span class="n">remote</span><span class="p">)</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_RNTO</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class="line">        <span class="n">remote</span><span class="p">,</span> <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_path</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class="line">        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rename_tmp_path</span><span class="p">,</span> <span class="n">local</span><span class="p">)</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="s">&#39;rename to &#39;</span> <span class="o">+</span> <span class="n">remote</span><span class="p">)</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_NLST</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class="line">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_connect</span><span class="p">():</span> <span class="k">return</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">125</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class="line">        <span class="n">remote</span><span class="p">,</span> <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_dir</span><span class="p">)</span>
</span><span class="line">        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">local</span><span class="p">):</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">226</span><span class="p">,</span> <span class="s">&quot;Limit&quot;</span><span class="p">)</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">close_data_fd</span><span class="p">()</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_XMKD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">handle_MKD</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_MKD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class="line">        <span class="n">remote</span><span class="p">,</span> <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_path</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class="line">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local</span><span class="p">):</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&quot;Folder is already existed&quot;</span><span class="p">)</span>
</span><span class="line">            <span class="k">return</span>
</span><span class="line">        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">257</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_XRMD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">handle_RMD</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_RMD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class="line">        <span class="n">remote</span><span class="p">,</span> <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_path</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class="line">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local</span><span class="p">):</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&quot;Folder is not existed&quot;</span><span class="p">)</span>
</span><span class="line">            <span class="k">return</span>
</span><span class="line">        <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_LIST</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class="line">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_connect</span><span class="p">():</span> <span class="k">return</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">125</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class="line">        <span class="n">template</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s%s%s</span><span class="s">------- </span><span class="si">%04u</span><span class="s"> </span><span class="si">%8s</span><span class="s"> </span><span class="si">%8s</span><span class="s"> </span><span class="si">%8lu</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="se">\r\n</span><span class="s">&quot;</span>
</span><span class="line">        <span class="n">remote</span><span class="p">,</span> <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_dir</span><span class="p">)</span>
</span><span class="line">        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">local</span><span class="p">):</span>
</span><span class="line">            <span class="n">path</span> <span class="o">=</span> <span class="n">local</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">filename</span>
</span><span class="line">            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="c"># ignores link or block file</span>
</span><span class="line">                <span class="n">status</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class="line">                <span class="n">msg</span> <span class="o">=</span> <span class="n">template</span> <span class="o">%</span> <span class="p">(</span>
</span><span class="line">                    <span class="s">&#39;d&#39;</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">else</span> <span class="s">&#39;-&#39;</span><span class="p">,</span>
</span><span class="line">                    <span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;0&#39;</span><span class="p">,</span> <span class="s">&#39;0&#39;</span><span class="p">,</span>
</span><span class="line">                    <span class="n">status</span><span class="p">[</span><span class="n">stat</span><span class="o">.</span><span class="n">ST_SIZE</span><span class="p">],</span>
</span><span class="line">                    <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%b </span><span class="si">%d</span><span class="s">  %Y&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="n">stat</span><span class="o">.</span><span class="n">ST_MTIME</span><span class="p">])),</span>
</span><span class="line">                    <span class="n">filename</span><span class="p">)</span>
</span><span class="line">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;utf8&#39;</span><span class="p">]:</span> <span class="n">msg</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">())</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span>
</span><span class="line">                <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">226</span><span class="p">,</span> <span class="s">&quot;Limit&quot;</span><span class="p">)</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">close_data_fd</span><span class="p">()</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_PASV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;pasv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class="line">        <span class="k">try</span><span class="p">:</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">localhost</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">            <span class="n">ip</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">227</span><span class="p">,</span> <span class="s">&#39;Enter Passive Mode (</span><span class="si">%s</span><span class="s">,</span><span class="si">%u</span><span class="s">,</span><span class="si">%u</span><span class="s">).&#39;</span> <span class="o">%</span>
</span><span class="line">                    <span class="p">(</span><span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ip</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)),</span> <span class="p">(</span><span class="n">port</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="p">(</span><span class="n">port</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)))</span>
</span><span class="line">        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class="line">            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class="line">            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;in pasv&quot;</span><span class="p">)</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&#39;passive mode failed&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_PORT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class="line">        <span class="k">try</span><span class="p">:</span>
</span><span class="line">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="p">:</span>
</span><span class="line">                <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class="line">            <span class="n">t</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">data_host</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">data_port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class="line">        <span class="k">except</span><span class="p">:</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&quot;PORT failed&quot;</span><span class="p">)</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_DELE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class="line">        <span class="n">remote</span><span class="p">,</span> <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_path</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class="line">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local</span><span class="p">):</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">450</span><span class="p">,</span> <span class="s">&quot;File not exist&quot;</span><span class="p">)</span>
</span><span class="line">            <span class="k">return</span>
</span><span class="line">        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="s">&#39;File deleted&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_OPTS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class="line">        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;UTF8 ON&quot;</span><span class="p">:</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;utf8&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class="line">        <span class="k">elif</span> <span class="n">arg</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;UTF8 OFF&quot;</span><span class="p">:</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;utf8&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class="line">        <span class="k">else</span><span class="p">:</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&quot;Invalid argument&quot;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">FTPThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
</span><span class="line">    <span class="sd">&#39;&#39;&#39;FTPConnection Thread Wrapper&#39;&#39;&#39;</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">remote_ip</span><span class="p">):</span>
</span><span class="line">        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span> <span class="o">=</span> <span class="n">FTPConnection</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">remote_ip</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span class="line">        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Thread done&quot;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">FTPThreadServer</span><span class="p">:</span>
</span><span class="line">    <span class="sd">&#39;&#39;&#39;FTP Server which is using thread&#39;&#39;&#39;</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">serve_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="n">listen_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
</span><span class="line">        <span class="n">listen_fd</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class="line">        <span class="n">listen_fd</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span><span class="line">        <span class="n">listen_fd</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class="line">        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class="line">            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;new server&#39;</span><span class="p">)</span>
</span><span class="line">            <span class="n">client_fd</span><span class="p">,</span> <span class="n">client_addr</span> <span class="o">=</span> <span class="n">listen_fd</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
</span><span class="line">            <span class="n">handler</span> <span class="o">=</span> <span class="n">FTPThread</span><span class="p">(</span><span class="n">client_fd</span><span class="p">,</span> <span class="n">client_addr</span><span class="p">)</span>
</span><span class="line">            <span class="n">handler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">FTPForkServer</span><span class="p">:</span>
</span><span class="line">    <span class="sd">&#39;&#39;&#39;FTP Fork Server, use process per user&#39;&#39;&#39;</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">child_main</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_fd</span><span class="p">,</span> <span class="n">client_addr</span><span class="p">,</span> <span class="n">write_end</span><span class="p">):</span>
</span><span class="line">        <span class="sd">&#39;&#39;&#39;never return&#39;&#39;&#39;</span>
</span><span class="line">        <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_fds</span><span class="p">:</span>
</span><span class="line">            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">read_fds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class="line">
</span><span class="line">        <span class="k">try</span><span class="p">:</span>
</span><span class="line">            <span class="n">handler</span> <span class="o">=</span> <span class="n">FTPConnection</span><span class="p">(</span><span class="n">client_fd</span><span class="p">,</span> <span class="n">client_addr</span><span class="p">)</span>
</span><span class="line">            <span class="n">handler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span class="line">        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class="line">            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class="line">            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;in child_main&quot;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">        <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">write_end</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">write_end</span><span class="p">))</span>
</span><span class="line">
</span><span class="line">        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">serve_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="n">listen_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class="line">        <span class="n">listen_fd</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class="line">        <span class="n">listen_fd</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span><span class="line">        <span class="n">listen_fd</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">read_fds</span> <span class="o">=</span> <span class="p">[</span><span class="n">listen_fd</span><span class="p">]</span>
</span><span class="line">        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class="line">            <span class="n">rlist</span><span class="p">,</span> <span class="n">wlist</span><span class="p">,</span> <span class="n">xlist</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_fds</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[])</span>
</span><span class="line">
</span><span class="line">            <span class="k">if</span> <span class="n">listen_fd</span> <span class="ow">in</span> <span class="n">rlist</span><span class="p">:</span>
</span><span class="line">                <span class="n">client_fd</span><span class="p">,</span> <span class="n">client_addr</span> <span class="o">=</span> <span class="n">listen_fd</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
</span><span class="line">                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_fds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">limit_connection_number</span><span class="p">:</span>
</span><span class="line">                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;reject client: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">client_addr</span><span class="p">))</span>
</span><span class="line">                    <span class="n">client_fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class="line">                    <span class="k">continue</span>
</span><span class="line">                <span class="k">try</span><span class="p">:</span>
</span><span class="line">                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;new client: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">client_addr</span><span class="p">))</span>
</span><span class="line">                    <span class="n">read_end</span><span class="p">,</span> <span class="n">write_end</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span>
</span><span class="line">                    <span class="bp">self</span><span class="o">.</span><span class="n">read_fds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">read_end</span><span class="p">)</span>
</span><span class="line">                    <span class="n">fork_result</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
</span><span class="line">                    <span class="k">if</span> <span class="n">fork_result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># child process</span>
</span><span class="line">                        <span class="n">listen_fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class="line">                        <span class="bp">self</span><span class="o">.</span><span class="n">read_fds</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">)</span>
</span><span class="line">                        <span class="bp">self</span><span class="o">.</span><span class="n">child_main</span><span class="p">(</span><span class="n">client_fd</span><span class="p">,</span> <span class="n">client_addr</span><span class="p">,</span> <span class="n">write_end</span><span class="p">)</span> <span class="c"># never return</span>
</span><span class="line">                    <span class="k">else</span><span class="p">:</span>
</span><span class="line">                        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">write_end</span><span class="p">)</span>
</span><span class="line">                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class="line">                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class="line">                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Fork failed&#39;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">            <span class="k">for</span> <span class="n">read_fd</span> <span class="ow">in</span> <span class="n">rlist</span><span class="p">:</span>
</span><span class="line">                <span class="k">if</span> <span class="n">read_fd</span> <span class="o">==</span> <span class="n">listen_fd</span><span class="p">:</span> <span class="k">continue</span>
</span><span class="line">                <span class="n">data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">read_fd</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
</span><span class="line">                <span class="bp">self</span><span class="o">.</span><span class="n">read_fds</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">read_fd</span><span class="p">)</span>
</span><span class="line">                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">read_fd</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">get_uid</span><span class="p">(</span><span class="n">username</span> <span class="o">=</span> <span class="s">&#39;www-data&#39;</span><span class="p">):</span>
</span><span class="line">    <span class="sd">&#39;&#39;&#39;get uid by username, I don&#39;t know whether there&#39;s a</span>
</span><span class="line"><span class="sd">    function can get it, so I wrote this function.&#39;&#39;&#39;</span>
</span><span class="line">    <span class="n">pwd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/etc/passwd&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">username</span> <span class="o">+</span> <span class="s">&#39;:.*?:(.*?):.*?&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">pwd</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
</span><span class="line">        <span class="k">try</span><span class="p">:</span>
</span><span class="line">            <span class="n">uid</span> <span class="o">=</span> <span class="n">pat</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">        <span class="k">except</span><span class="p">:</span> <span class="k">continue</span>
</span><span class="line">        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">get_logger</span><span class="p">(</span><span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()):</span>
</span><span class="line">    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
</span><span class="line">    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%(asctime)s</span><span class="s"> </span><span class="si">%(levelname)s</span><span class="s"> </span><span class="si">%(message)s</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
</span><span class="line">    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
</span><span class="line">    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">)</span>
</span><span class="line">    <span class="k">return</span> <span class="n">logger</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">daemonize</span><span class="p">(</span><span class="n">stdin</span><span class="o">=</span><span class="s">&#39;/dev/null&#39;</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="s">&#39;/dev/null&#39;</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="s">&#39;/dev/null&#39;</span><span class="p">):</span>
</span><span class="line">    <span class="sd">&#39;&#39;&#39;becomes a daemon&#39;&#39;&#39;</span>
</span><span class="line">    <span class="k">try</span><span class="p">:</span>
</span><span class="line">        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
</span><span class="line">        <span class="k">if</span> <span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class="line">    <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class="line">        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;fork #1 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class="line">        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class="line">    <span class="n">os</span><span class="o">.</span><span class="n">setsid</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">    <span class="k">try</span><span class="p">:</span>
</span><span class="line">        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
</span><span class="line">        <span class="k">if</span> <span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class="line">    <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class="line">        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;fork #2 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class="line">        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span class="line">    <span class="n">si</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="n">so</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&#39;a+&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="n">se</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;a+&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span class="line">    <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>  <span class="c"># 0</span>
</span><span class="line">    <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">so</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span> <span class="c"># 1</span>
</span><span class="line">    <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">se</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span> <span class="c"># 2</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">serve_forever</span><span class="p">():</span>
</span><span class="line">    <span class="k">global</span> <span class="n">global_options</span>
</span><span class="line">    <span class="k">print</span> <span class="n">global_options</span>
</span><span class="line">    <span class="k">if</span> <span class="n">global_options</span><span class="p">[</span><span class="s">&#39;run_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;fork&#39;</span><span class="p">:</span>
</span><span class="line">        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGCHLD</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_IGN</span><span class="p">)</span>
</span><span class="line">        <span class="n">server</span> <span class="o">=</span> <span class="n">FTPForkServer</span><span class="p">()</span>
</span><span class="line">    <span class="k">else</span><span class="p">:</span>
</span><span class="line">        <span class="n">server</span> <span class="o">=</span> <span class="n">FTPThreadServer</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">usage</span><span class="p">():</span>
</span><span class="line">    <span class="k">print</span> <span class="s">&#39;&#39;&#39;usage: </span><span class="si">%s</span><span class="s"> [-d] [-h] [-p port] [-o] [-t]</span>
</span><span class="line"><span class="s">    -d become a daemon</span>
</span><span class="line"><span class="s">    -h help</span>
</span><span class="line"><span class="s">    -p listen port</span>
</span><span class="line"><span class="s">    -o output log to stdout, by default, it outputs to a log file.</span>
</span><span class="line"><span class="s">    -t thread mode, fork model by default</span>
</span><span class="line">
</span><span class="line"><span class="s">Waring:</span>
</span><span class="line"><span class="s">    The Thread Mode is not complete.</span>
</span><span class="line">
</span><span class="line"><span class="s">Author:</span>
</span><span class="line"><span class="s">    Hua Liang [ Stupid ET ] &lt;et@everet.org&gt;</span>
</span><span class="line"><span class="s">    http://EverET.org </span>
</span><span class="line"><span class="s">&#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">param_handler</span><span class="p">(</span><span class="n">opts</span><span class="p">):</span>
</span><span class="line">    <span class="k">global</span> <span class="n">port</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">global_options</span>
</span><span class="line">    <span class="n">be_daemon</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class="line">    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">logfile</span><span class="p">))</span>
</span><span class="line">    <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
</span><span class="line">        <span class="k">if</span> <span class="n">o</span> <span class="o">==</span> <span class="s">&#39;-h&#39;</span><span class="p">:</span>
</span><span class="line">            <span class="n">usage</span><span class="p">()</span>
</span><span class="line">            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class="line">        <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="s">&#39;-d&#39;</span><span class="p">:</span>
</span><span class="line">            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;posix&#39;</span><span class="p">:</span>
</span><span class="line">                <span class="k">print</span> <span class="s">&#39;Only support the os with posix specifications.&#39;</span>
</span><span class="line">                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">            <span class="n">be_daemon</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class="line">        <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="s">&#39;-o&#39;</span><span class="p">:</span>
</span><span class="line">            <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>
</span><span class="line">        <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="s">&#39;-p&#39;</span><span class="p">:</span>
</span><span class="line">            <span class="k">try</span><span class="p">:</span> <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span class="line">            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class="line">                <span class="n">usage</span><span class="p">()</span>
</span><span class="line">                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class="line">        <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="s">&#39;-t&#39;</span><span class="p">:</span>
</span><span class="line">            <span class="n">global_options</span><span class="p">[</span><span class="s">&#39;run_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;thread&#39;</span>
</span><span class="line">
</span><span class="line">    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s">&#39;posix&#39;</span> <span class="ow">and</span> <span class="n">global_options</span><span class="p">[</span><span class="s">&#39;run_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;fork&#39;</span><span class="p">:</span>
</span><span class="line">        <span class="k">print</span> <span class="s">&quot;You can NOT run fork mode in a non posix os,</span><span class="se">\</span>
</span><span class="line"><span class="s"> please use -t options to run in thread mode&quot;</span>
</span><span class="line">        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="n">be_daemon</span><span class="p">:</span> <span class="n">daemonize</span><span class="p">()</span>
</span><span class="line">
</span><span class="line"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class="line">    <span class="k">try</span><span class="p">:</span>
</span><span class="line">        <span class="n">opts</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">getopt</span><span class="o">.</span><span class="n">getopt</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s">&#39;hdp:ot&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="k">except</span> <span class="n">getopt</span><span class="o">.</span><span class="n">GetoptError</span><span class="p">:</span>
</span><span class="line">        <span class="n">usage</span><span class="p">()</span>
</span><span class="line">        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="n">param_handler</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="sd">&#39;&#39;&#39;You can write your account_info in ftp.py.config&#39;&#39;&#39;</span>
</span><span class="line">    <span class="k">try</span><span class="p">:</span> <span class="nb">execfile</span><span class="p">(</span><span class="s">&#39;ftp.py.config&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="n">serve_forever</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>



  <span>本文链接: <a href="http://everet.org/2012/03/ftp-server.html">http://everet.org/2012/03/ftp-server.html</a></span>
  <hr/>
    <h3>您可能也喜欢</h3>
    <ul>
    
        <li>
        <a href="/2012/03/ftp-protocol.html">Mission: FTP Protocol</a>
        </li>
    
        <li>
        <a href="/2012/01/gitweb-password.html">给Gitweb加上访问密码，保护我们的私有项目</a>
        </li>
    
        <li>
        <a href="/2012/03/vim.html">我的Vim配置</a>
        </li>
    
        <li>
        <a href="/2012/03/python-forwarding-redirecting-tcp-monitor.html">Python端口转发及重定向实现Eclipse的TCP/IP Monitor</a>
        </li>
    
        <li>
        <a href="/2012/05/errno-table.html">errno表</a>
        </li>
    
    </ul>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Stupid ET</span></span>

      








  


<time datetime="2012-03-24T10:35:06+08:00" pubdate data-updated="true">2012-03-24</time>
      

<span class="categories">
  
    <a class='category' href='/category/my-code/'>My Code</a>, <a class='category' href='/category/web/'>Web</a>
  
</span>


      

<span class="categories">
  Tags:&nbsp
  
    <a class='tag' href='/tag/python/'>Python</a>, <a class='tag' href='/tag/web/'>Web</a>
  
</span>



    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2012/03/python-forwarding-redirecting-tcp-monitor.html" title="Previous Post: Python端口转发及重定向实现Eclipse的TCP/IP Monitor">&laquo; Python端口转发及重定向实现Eclipse的TCP/IP Monitor</a>
      
      
        <a class="basic-alignment right" href="/2012/03/vim.html" title="Next Post: 我的Vim配置">我的Vim配置 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p>Cedric Porter is Stupid ET.</p>
  <p>EverET.org is provided by Stupid ET.</p>
</section>
<section>
  <h1>Tags</h1>
  <ul class="tag-cloud">
    <a style="font-size: 112%" href="/tag/android/">Android</a>
<a style="font-size: 131%" href="/tag/apache/">Apache</a>
<a style="font-size: 80%" href="/tag/boost/">Boost</a>
<a style="font-size: 80%" href="/tag/bugzilla/">Bugzilla</a>
<a style="font-size: 177%" href="/tag/c-/">C++</a>
<a style="font-size: 131%" href="/tag/captcha/">Captcha</a>
<a style="font-size: 80%" href="/tag/chrome/">Chrome</a>
<a style="font-size: 164%" href="/tag/clover/">Clover</a>
<a style="font-size: 112%" href="/tag/datastructure/">DataStructure</a>
<a style="font-size: 80%" href="/tag/design/">Design</a>
<a style="font-size: 155%" href="/tag/emacs/">Emacs</a>
<a style="font-size: 80%" href="/tag/english/">English</a>
<a style="font-size: 171%" href="/tag/git/">Git</a>
<a style="font-size: 80%" href="/tag/gitosis/">Gitosis</a>
<a style="font-size: 112%" href="/tag/gitweb/">Gitweb</a>
<a style="font-size: 112%" href="/tag/http/">HTTP</a>
<a style="font-size: 183%" href="/tag/image-processing/">Image Processing</a>
<a style="font-size: 80%" href="/tag/imagination-factory/">Imagination Factory</a>
<a style="font-size: 80%" href="/tag/irrlicht/">Irrlicht</a>
<a style="font-size: 80%" href="/tag/lnmp/">LNMP</a>
<a style="font-size: 207%" href="/tag/linux/">Linux</a>
<a style="font-size: 131%" href="/tag/lisp/">Lisp</a>
<a style="font-size: 80%" href="/tag/markdown/">Markdown</a>
<a style="font-size: 80%" href="/tag/moinmoin/">MoinMoin</a>
<a style="font-size: 131%" href="/tag/mysql/">Mysql</a>
<a style="font-size: 145%" href="/tag/nginx/">Nginx</a>
<a style="font-size: 155%" href="/tag/ogre/">OGRE</a>
<a style="font-size: 80%" href="/tag/octopress/">Octopress</a>
<a style="font-size: 131%" href="/tag/php/">PHP</a>
<a style="font-size: 131%" href="/tag/pil/">PIL</a>
<a style="font-size: 250%" href="/tag/python/">Python</a>
<a style="font-size: 80%" href="/tag/qq/">QQ</a>
<a style="font-size: 80%" href="/tag/ruby/">Ruby</a>
<a style="font-size: 80%" href="/tag/svn/">SVN</a>
<a style="font-size: 112%" href="/tag/scar/">Scar</a>
<a style="font-size: 112%" href="/tag/tortoisegit/">TortoiseGit</a>
<a style="font-size: 164%" href="/tag/ubuntu/">Ubuntu</a>
<a style="font-size: 145%" href="/tag/ultrademo/">UltraDemo</a>
<a style="font-size: 80%" href="/tag/vpn/">VPN</a>
<a style="font-size: 112%" href="/tag/vim/">Vim</a>
<a style="font-size: 112%" href="/tag/wpf/">WPF</a>
<a style="font-size: 183%" href="/tag/web/">Web</a>
<a style="font-size: 164%" href="/tag/wordpress/">Wordpress</a>
<a style="font-size: 171%" href="/tag/compile/">compile</a>
<a style="font-size: 80%" href="/tag/curl/">curl</a>
<a style="font-size: 80%" href="/tag/cygwin/">cygwin</a>
<a style="font-size: 80%" href="/tag/ppp/">ppp</a>
<a style="font-size: 80%" href="/tag/pptpd/">pptpd</a>
<a style="font-size: 80%" href="/tag/rsync/">rsync</a>
<a style="font-size: 80%" href="/tag/sendmail/">sendmail</a>
<a style="font-size: 80%" href="/tag/ssh/">ssh</a>
<a style="font-size: 80%" href="/tag/uwsgi/">uWSGI</a>
<a style="font-size: 80%" href="/tag/virtual-memory/">virtual memory</a>

  </ul>
</section>
<section>
  <h1>Friends</h1>
    <a href="http://www.kidsang.com/" target="_blank">树桑小朋友的自留地</a>
    | <a href="http://xiaoxia.org/" target="_blank">XIAOXIA[PG]</a>
    | <a href="http://huanghuachao.cn/" target="_blank">Richard Huang's Blog</a>
    | <a href="http://jiafei.org/" target="_blank">jiafei</a>
    | <a href="http://xuyufish.com/" target="_blank">Fish</a>
    | <a href="http://zhke.name/" target="_blank">汗青-home</a>
    | <a href="http://www.dorgel.net/blog" target="_blank">Dorgel&#039;s Blog</a>
    | <a href="http://spead.everet.org" title="俊杰的空间" target="_blank">Spead&#039;s Blog</a>
</section>
<section>
  <h1>Recent Comments</h1>
  <div id="dsq-recentcomments" class="dsq-widget"><script type="text/javascript" src="http://disqus.com/forums/everet/recent_comments_widget.js?hide_avatars=0&num_items=5&excerpt_length=100"></script></div>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2013/01/customize-emacs-gud-many-windows.html">定制Emacs GDB调试窗口布局</a>
      </li>
    
      <li class="post">
        <a href="/2013/01/http-status-206-partial-content.html">[学习HTTP] 206 Partial Content</a>
      </li>
    
      <li class="post">
        <a href="/2013/01/chrome-edit-with-emacs.html">Chrome Edit With Emacs</a>
      </li>
    
      <li class="post">
        <a href="/2013/01/keep-learning.html">Keep Learning</a>
      </li>
    
      <li class="post">
        <a href="/2012/12/tt.html">由TT引发的思考</a>
      </li>
    
  </ul>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Stupid ET -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'everet';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://everet.org/2012/03/ftp-server.html';
        var disqus_url = 'http://everet.org/2012/03/ftp-server.html';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
