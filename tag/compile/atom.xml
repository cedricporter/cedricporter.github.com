<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Tag: compile | EverET.org]]></title>
  <link href="http://everet.org/tag/compile/atom.xml" rel="self"/>
  <link href="http://everet.org/"/>
  <updated>2013-01-08T13:10:35+08:00</updated>
  <id>http://everet.org/</id>
  <author>
    <name><![CDATA[Stupid ET]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[走进Python: 为Python增加新语法]]></title>
    <link href="http://everet.org/2012/07/add-new-grammer-to-python.html"/>
    <updated>2012-07-26T05:43:28+08:00</updated>
    <id>http://everet.org/2012/07/add-new-grammer-to-python</id>
    <content type="html"><![CDATA[<p><strong>原文地址：</strong><a href="http://eli.thegreenplace.net/2010/06/30/python-internals-adding-a-new-statement-to-python/">http://eli.thegreenplace.net/2010/06/30/python-internals-adding-a-new-statement-to-python/</a></p>

<p><strong>译文地址：</strong><a href="http://everet.org/2012/07/add-new-grammer-to-python.html">http://everet.org/2012/07/add-new-grammer-to-python.html</a></p>

<p><strong>译者：</strong><a href="http://EverET.org">Stupid ET</a></p>

<p>翻译得比较仓储，里面会有些语句不通顺，请见谅，日后会慢慢重构。
修改后的Python请见：<a href="https://github.com/cedricporter/python2.7-mod/tags">https://github.com/cedricporter/python2.7-mod/tags</a> ，在Ubuntu下可以正常编译。</p>

<hr />

<p>本文的目的是试图更好地理解Python的前端是如何工作的。如果我们仅仅是阅读文档和源代码，那么可能有点无聊，所以我将亲手实践：为Python添加一个until语句。</p>

<p>这篇文章中的所有的编码,是针对最新的Py3k分支<a href="http://code.python.org/hg/branches/py3k/">Python Mercurial repository mirror</a>。</p>

<h3 id="until">until语句</h3>

<p>有些语言，像Ruby，拥有until语句，用来补充while语句 (until num == 0 等价与 while num != 0)。在Ruby总，我可以这样写：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>python  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">num</span> <span class="o">=</span> <span class="mi">3</span>
</span><span class='line'><span class="n">until</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">0</span> <span class="n">do</span>
</span><span class='line'>  <span class="n">puts</span> <span class="n">num</span>
</span><span class='line'>  <span class="n">num</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span class='line'><span class="n">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>它会输出</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>python  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="mi">3</span>
</span><span class='line'><span class="mi">2</span>
</span><span class='line'><span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>所以,我想要添加一个类似的功能到Python。也就是说,能够写成这样:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>python  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">num</span> <span class="o">=</span> <span class="mi">3</span>
</span><span class='line'><span class="n">until</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>  <span class="k">print</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
</span><span class='line'>  <span class="n">num</span> <span class="o">-=</span> <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<!-- more -->

<h3 id="a-language-advocacy-digression">A language-advocacy digression（不知如何翻译）</h3>

<p>本文并没有企图建议添加一个Until语句到Python。虽然我认为这样的语句会让一些代码清晰,而且这篇文章也展示了这是多么容易为Python添加这样的语句，但我非常尊重Python的简约主义的哲学。所以我在这里做的一切，仅仅是为了更能了解Python的内部工作原理。</p>

<h3 id="section">修改语法</h3>

<p>Python使用一个自定义解析器生成器pgen。这是一个LL(1)的解析器，用于将Python源代码转换成一个解析树。解析器生成器的输入文件  Grammar/Grammar <a href="http://eli.thegreenplace.net/2010/06/30/python-internals-adding-a-new-statement-to-python/#id4">[1]</a>。这是一个简单的文本文件，用于定义Python的语法。 我们对这个语法文件进行了两处修改。第一个是添加until语句的定义。我发现那里的while语句定义为(while_stmt),于是我们在下面补充until_stmt[2]:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>python  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">compound_stmt</span><span class="p">:</span> <span class="n">if_stmt</span> <span class="o">|</span> <span class="n">while_stmt</span> <span class="o">|</span> <span class="n">until_stmt</span> <span class="o">|</span> <span class="n">for_stmt</span> <span class="o">|</span> <span class="n">try_stmt</span> <span class="o">|</span> <span class="n">with_stmt</span> <span class="o">|</span> <span class="n">funcdef</span> <span class="o">|</span> <span class="n">classdef</span> <span class="o">|</span> <span class="n">decorated</span>
</span><span class='line'><span class="n">if_stmt</span><span class="p">:</span> <span class="err">‘</span><span class="k">if</span><span class="err">’</span> <span class="n">test</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="n">suite</span> <span class="p">(</span><span class="err">‘</span><span class="k">elif</span><span class="err">’</span> <span class="n">test</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="n">suite</span><span class="p">)</span><span class="o">*</span> <span class="p">[</span><span class="err">‘</span><span class="k">else</span><span class="err">’</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="n">suite</span><span class="p">]</span>
</span><span class='line'><span class="n">while_stmt</span><span class="p">:</span> <span class="err">‘</span><span class="k">while</span><span class="err">’</span> <span class="n">test</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="n">suite</span> <span class="p">[</span><span class="err">‘</span><span class="k">else</span><span class="err">’</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="n">suite</span><span class="p">]</span>
</span><span class='line'><span class="n">until_stmt</span><span class="p">:</span> <span class="err">‘</span><span class="n">until</span><span class="err">’</span> <span class="n">test</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="n">suite</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>注意，我决定了从我定义的until语句中去掉else子句，只是为了让他们有点不同（因为，坦率地说，我不喜欢循环的else子句，认为它有悖于the Zen of Python）。
第二个变化是修改规则compound_stmt，正如上面你所见到的那样，让它可以推导成until_stmt。我们把它放在while_stmt的右边。
当您在修改完<strong>Grammar/Grammar</strong>后准备运行make时注意运行pgen程序运行时重新生成Include/graminit.h以及Python/graminit.c再重新编译。
<strong>（译注：cedricporter@Stupid-ET:~/projects/python2.7-2.7.2/Parser$ ./pgen ../Grammar/Grammar graminit.h graminit.c）</strong></p>

<h3 id="ast">修改AST生成代码</h3>

<p>在Python的解析器创建了一个解析树后,这棵树被转换成一个AST（译注：抽象语法树），因为AST让后续的编译流程更简单。</p>

<p>所以,我们打开Parser/Python.asdl，它定义了结构的Python的抽象语法树，我们在那里为我们新增的until语句添加一个AST节点，又放在while的右后方:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>python  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">|</span> <span class="n">While</span><span class="p">(</span><span class="n">expr</span> <span class="n">test</span><span class="p">,</span> <span class="n">stmt</span><span class="o">*</span> <span class="n">body</span><span class="p">,</span> <span class="n">stmt</span><span class="o">*</span> <span class="n">orelse</span><span class="p">)</span>
</span><span class='line'><span class="o">|</span> <span class="n">Until</span><span class="p">(</span><span class="n">expr</span> <span class="n">test</span><span class="p">,</span> <span class="n">stmt</span><span class="o">*</span> <span class="n">body</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>If you now run make, notice that before compiling a bunch of files, Parser/asdl_c.py is run to generate C code from the AST definition file. This (like Grammar/Grammar) is another example of the Python source-code using a mini-language (in other words, a DSL) to simplify programming. Also note that since Parser/asdl_c.py is a Python script, this is a kind of <a href="http://en.wikipedia.org/wiki/Bootstrapping_%28compilers%29">bootstrapping</a> – to build Python from scratch, Python already has to be available.
如果你现在运行make,请注意在编译一堆文件之前, 运行Parser/asdl_c.py根据AST定义文件生成的C代码。这(如Grammar/Grammar)是另一个Python源代码使用迷你语言(换句话说,一个DSL)来简化编程的例子。还请注意,由于Parser/asdl_c.py是一个Python脚本,这是一种自举——从原型中构建Python。Python已经拥有自举的能力了。</p>

<p>虽然<strong>Parser/asdl_c.py</strong>生成的代码管理着我们的新定义的AST节点(生成到文件<strong>Include/Python-ast.h</strong>和<strong>Python/Python-ast.c中</strong>)，我们仍然需要编写的代码,将一个相关的解析树节点转换成我们新定义的AST节点。</p>

<p><strong>（译注：cedricporter@Stupid-ET:~/projects/python2.7-2.7.2/Parser$ ./asdl_c.py -h ../Include/ Python.asdl ）</strong></p>

<p>这些工作在 <strong>Python/ast.c</strong>中完成。在那里,一个叫做 ast_for_stmt的函数将解析树节点转换为AST节点。我们再次在我们的老朋友while的引导下，进入处理compound_stmt的庞大的switch中，为until增加一个子块：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>c  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="n">while_stmt</span>:
</span><span class='line'>    <span class="k">return</span> <span class="n">ast_for_while_stmt</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
</span><span class='line'><span class="k">case</span> <span class="n">until_stmt</span>:
</span><span class='line'>    <span class="k">return</span> <span class="n">ast_for_until_stmt</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>现在我们要实现ast_for_until_stmt：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>c  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="n">stmt_ty</span>
</span><span class='line'><span class="nf">ast_for_until_stmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">compiling</span> <span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">c</span><span class="p">,</span> <span class="k">const</span> <span class="n">node</span> <span class="o">*</span><span class="n">n</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="o">/&lt;/</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">until_stmt</span><span class="o">:</span> <span class="err">‘</span><span class="n">until</span><span class="err">’</span> <span class="n">test</span> <span class="err">‘</span><span class="o">:</span><span class="err">’</span> <span class="n">suite</span> <span class="err">*/</span>
</span><span class='line'>    <span class="n">REQ</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">until_stmt</span><span class="p">);</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">if</span> <span class="p">(</span><span class="n">NCH</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">expr_ty</span> <span class="n">expression</span><span class="p">;</span>
</span><span class='line'>    <span class="n">asdl_seq</span> <span class="o">*</span><span class="n">suite_seq</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">expression</span> <span class="o">=</span> <span class="n">ast_for_expr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">CHILD</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">expression</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="n">suite_seq</span> <span class="o">=</span> <span class="n">ast_for_suite</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">CHILD</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">suite_seq</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">Until</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">suite_seq</span><span class="p">,</span> <span class="n">LINENO</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">n</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">n_col_offset</span><span class="p">,</span> <span class="n">c</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">c_arena</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">PyErr_Format</span><span class="p">(</span><span class="n">PyExc_SystemError</span><span class="p">,</span>
</span><span class='line'>             <span class="s">&quot;wrong number of tokens for &#39;until&#39; statement: %d&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="n">NCH</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
</span><span class='line'><span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
</code></pre>

<p>再一次,这是看起来像ast_for_while_stmt，不过不同的是，它不支持else子句。也正如预期的那样，在until语句的主体中使用其他AST创建函数像ast_for_expr对于条件表达式和 ast_for_suite来递归地创建AST。最后，一个until新节点被创建返回。</p>

<p>注意,我们通过一些宏，像NCH和CHILD来访问解析树节点。这些都是值得我们去理解——他们的代码在<strong>Include/node.h</strong>.</p>

<h3 id="ast-1">题外话：AST组合</h3>

<p>我选择创建一个新until类型的AST,但实际上这是没有必要的。虽然我能通过实现组合现有的AST节点来节省一些工作:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>python  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">until</span> <span class="n">condition</span><span class="p">:</span>
</span><span class='line'>   <span class="c"># do stuff</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>功能上等价于:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>python  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">while</span> <span class="ow">not</span> <span class="n">condition</span><span class="p">:</span>
</span><span class='line'>  <span class="c"># do stuff</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>与其在ast_until_stmt里面创建一个新的Until节点，我可以创建一个Not节点下面挂上While节点。因为AST解释器已经知道如何处理这些节点，所以下一步可以跳过了。</p>

<h3 id="ast-2">将AST变成字节码</h3>

<p>The next step is compiling the AST into Python bytecode. The compilation has an intermediate result which is a CFG (Control Flow Graph), but since the same code handles it I will ignore this detail for now and leave it for another article.</p>

<p>下一步是将AST解析成字节码。编译过程中有一个中间结果CFG(控制流图)，但由于有相同的代码处理它，所以我暂时先忽略这一细节，留到另一篇文章再讲解。</p>

<p>下一步，们将看看Python/compile.c。在while的带领下，我们找到负责将语句编译成字节码的函数compiler_visit_stmt。在这里，我们为Until添加一个子句:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>c  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="n">While_kind</span>:
</span><span class='line'>    <span class="k">return</span> <span class="n">compiler_while</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
</span><span class='line'><span class="k">case</span> <span class="n">Until_kind</span>:
</span><span class='line'>    <span class="k">return</span> <span class="n">compiler_until</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>想必你也想知道Until_kind是什么，它是一个根据AST定义自动生成到Include/Python-ast.h的常量(实际上是一个_stmt_kind的枚举)。当然，我们调用的compiler_until还不存在。我等等就会实现它。</p>

<p>如果你好奇的像我一样,你会注意到compiler_visit_stmt非常特别。再多的 grep平源树能揭示它叫。在这种情况下,只有一个选择仍然macro-fu - C。事实上,一个简短的调查使我们进入了 访问宏定义在 Python / compile.c:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>c  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define VISIT(C, TYPE, V) {\</span>
</span><span class='line'><span class="cp">    if (!compiler_visit_ ## TYPE((C), (V))) \</span>
</span><span class='line'><span class="cp">        return 0; \</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>在compiler_body中，它是用来调用compiler_visit_stmt的。</p>

<p>正如之前说的那样，我们在这里给出compiler_until:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>c  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">compiler_until</span><span class="p">(</span><span class="k">struct</span> <span class="n">compiler</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">stmt_ty</span> <span class="n">s</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">basicblock</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="n">anchor</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">constant</span> <span class="o">=</span> <span class="n">expr_constant</span><span class="p">(</span><span class="n">s</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">v</span><span class="p">.</span><span class="n">Until</span><span class="p">.</span><span class="n">test</span><span class="p">);</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">if</span> <span class="p">(</span><span class="n">constant</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">loop</span> <span class="o">=</span> <span class="n">compiler_new_block</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span><span class='line'><span class="n">end</span> <span class="o">=</span> <span class="n">compiler_new_block</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">constant</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">anchor</span> <span class="o">=</span> <span class="n">compiler_new_block</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">anchor</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">loop</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">end</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">ADDOP_JREL</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">SETUP_LOOP</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
</span><span class='line'><span class="n">compiler_use_next_block</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">loop</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">compiler_push_fblock</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">LOOP</span><span class="p">,</span> <span class="n">loop</span><span class="p">))</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">constant</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">VISIT</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">s</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">v</span><span class="p">.</span><span class="n">Until</span><span class="p">.</span><span class="n">test</span><span class="p">);</span>
</span><span class='line'>    <span class="n">ADDOP_JABS</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">POP_JUMP_IF_TRUE</span><span class="p">,</span> <span class="n">anchor</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">VISIT_SEQ</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">stmt</span><span class="p">,</span> <span class="n">s</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">v</span><span class="p">.</span><span class="n">Until</span><span class="p">.</span><span class="n">body</span><span class="p">);</span>
</span><span class='line'><span class="n">ADDOP_JABS</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">JUMP_ABSOLUTE</span><span class="p">,</span> <span class="n">loop</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">constant</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">compiler_use_next_block</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">anchor</span><span class="p">);</span>
</span><span class='line'>    <span class="n">ADDOP</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">POP_BLOCK</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">compiler_pop_fblock</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">LOOP</span><span class="p">,</span> <span class="n">loop</span><span class="p">);</span>
</span><span class='line'><span class="n">compiler_use_next_block</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
</code></pre>

<p>我必须得承认，这些代码是在我没有深刻理解Python字节码的前提下编写的。就像接下来的文章那样，它仅仅是模仿它的亲戚函数compiler_while。我们通过仔细阅读，知道Python虚拟机是基于栈的，大致看了一下dis模块的文档，发现那里有<a href="http://docs.python.org/py3k/library/dis.html">一系列Python字节码的描述</a>.</p>

<h3 id="section-1">嗯！我们完成了，不是吗？</h3>

<p>在修改完后，我们运行make，然后我们运行我们新编译出来的Python来测试我们新增的until语句：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>python  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">»</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">until</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'><span class="err">…</span>   <span class="k">print</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
</span><span class='line'><span class="err">…</span>   <span class="n">num</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span class='line'><span class="err">…</span>
</span><span class='line'><span class="mi">3</span>
</span><span class='line'><span class="mi">2</span>
</span><span class='line'><span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>瞧！它能够工作！我们通过dis模块来看看新语句的字节码：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>python  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">dis</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">myfoo</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
</span><span class='line'>    <span class="n">until</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
</span><span class='line'>        <span class="n">num</span> <span class="o">-=</span> <span class="mi">1</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">myfoo</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Here’s the result:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>python  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="mi">4</span>           <span class="mi">0</span> <span class="n">SETUP_LOOP</span>              <span class="mi">36</span> <span class="p">(</span><span class="n">to</span> <span class="mi">39</span><span class="p">)</span>
</span><span class='line'>     <span class="err"> »</span>    <span class="mi">3</span> <span class="n">LOAD_FAST</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">num</span><span class="p">)</span>
</span><span class='line'>            <span class="mi">6</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>            <span class="mi">9</span> <span class="n">COMPARE_OP</span>               <span class="mi">2</span> <span class="p">(</span><span class="o">==</span><span class="p">)</span>
</span><span class='line'>           <span class="mi">12</span> <span class="n">POP_JUMP_IF_TRUE</span>        <span class="mi">38</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="mi">5</span>          <span class="mi">15</span> <span class="n">LOAD_NAME</span>                <span class="mi">0</span> <span class="p">(</span><span class="k">print</span><span class="p">)</span>
</span><span class='line'>           <span class="mi">18</span> <span class="n">LOAD_FAST</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">num</span><span class="p">)</span>
</span><span class='line'>           <span class="mi">21</span> <span class="n">CALL_FUNCTION</span>            <span class="mi">1</span>
</span><span class='line'>           <span class="mi">24</span> <span class="n">POP_TOP</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="mi">6</span>          <span class="mi">25</span> <span class="n">LOAD_FAST</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">num</span><span class="p">)</span>
</span><span class='line'>           <span class="mi">28</span> <span class="n">LOAD_CONST</span>               <span class="mi">2</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>           <span class="mi">31</span> <span class="n">INPLACE_SUBTRACT</span>
</span><span class='line'>           <span class="mi">32</span> <span class="n">STORE_FAST</span>               <span class="mi">0</span> <span class="p">(</span><span class="n">num</span><span class="p">)</span>
</span><span class='line'>           <span class="mi">35</span> <span class="n">JUMP_ABSOLUTE</span>            <span class="mi">3</span>
</span><span class='line'>     <span class="err"> »</span>   <span class="mi">38</span> <span class="n">POP_BLOCK</span>
</span><span class='line'>     <span class="err"> »</span>   <span class="mi">39</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="bp">None</span><span class="p">)</span>
</span><span class='line'>           <span class="mi">42</span> <span class="n">RETURN_VALUE</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>最有趣的是编号12的字节码：如果条件为真，我们跳转到循环的后面。这个符合until的语义。如果jump没有被执行，循环体就继续运行，直到它跳转到编号35的字节码。</p>

<p>我对我的修改自我感觉良好，于是我继续测试这个函数（执行myfoo(3)），结果并不令人振奋：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>python  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
</span><span class='line'>  <span class="n">File</span> <span class="err">“</span><span class="n">zy</span><span class="o">.</span><span class="n">py</span><span class="err">”</span><span class="p">,</span> <span class="n">line</span> <span class="mi">9</span><span class="p">,</span> <span class="ow">in</span>
</span><span class='line'>    <span class="n">myfoo</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'>  <span class="n">File</span> <span class="err">“</span><span class="n">zy</span><span class="o">.</span><span class="n">py</span><span class="err">”</span><span class="p">,</span> <span class="n">line</span> <span class="mi">5</span><span class="p">,</span> <span class="ow">in</span> <span class="n">myfoo</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
</span><span class='line'><span class="ne">SystemError</span><span class="p">:</span> <span class="n">no</span> <span class="nb">locals</span> <span class="n">when</span> <span class="n">loading</span> <span class="err">‘</span><span class="k">print</span><span class="err">’</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>哇…这个真是悲剧。究竟哪里出错了？</p>

<h3 id="section-2">丢失符号</h3>

<p>在解析AST的时候，Python解析器执行的步骤之一是构建符号表。通过在PyAST_Compile里面调用PySymtable_Build（Python/symtable.c）来遍历AST。拥有每一个作用域的符号表有助于编译器找出一些关键的信息，就像哪些变量是全局的，哪些变量是局部的。</p>

<p>我们需要修改Python/symtable.c下的symtable_visit_stmt来解决这个问题，我们添加一些处理until语句的代码，放在相似的while语句的代码后面 <a href="http://eli.thegreenplace.net/2010/06/30/python-internals-adding-a-new-statement-to-python/#id6">[3]</a>:：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>c  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="n">While_kind</span>:
</span><span class='line'>    <span class="n">VISIT</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">s</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">v</span><span class="p">.</span><span class="n">While</span><span class="p">.</span><span class="n">test</span><span class="p">);</span>
</span><span class='line'>    <span class="n">VISIT_SEQ</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">stmt</span><span class="p">,</span> <span class="n">s</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">v</span><span class="p">.</span><span class="n">While</span><span class="p">.</span><span class="n">body</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">v</span><span class="p">.</span><span class="n">While</span><span class="p">.</span><span class="n">orelse</span><span class="p">)</span>
</span><span class='line'>        <span class="n">VISIT_SEQ</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">stmt</span><span class="p">,</span> <span class="n">s</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">v</span><span class="p">.</span><span class="n">While</span><span class="p">.</span><span class="n">orelse</span><span class="p">);</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="k">case</span> <span class="n">Until_kind</span>:
</span><span class='line'>    <span class="n">VISIT</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">s</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">v</span><span class="p">.</span><span class="n">Until</span><span class="p">.</span><span class="n">test</span><span class="p">);</span>
</span><span class='line'>    <span class="n">VISIT_SEQ</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">stmt</span><span class="p">,</span> <span class="n">s</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">v</span><span class="p">.</span><span class="n">Until</span><span class="p">.</span><span class="n">body</span><span class="p">);</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>现在，我们真的完成了。修改后的源码可以在myfoo(3)运行正常。</p>

<h3 id="section-3">结论</h3>

<p>在本文中，我展示了如何为Python增加一个新语句。尽管需要比较多处的修改Python编译器，但是这些修改并不难，因为我跟随着一个相似的语句来修改。</p>

<p>Python编译器适宜隔非常复杂的程序，我不想自称专家。然而，我真的对Python内部实现相当感兴趣，特别是前端。因此，我发现这种练习是一个编译理论与实践的结合。它将作为后续文章的基础来更深层次地探究编译器。</p>

<h3 id="section-4">参考</h3>
<p>I used a few excellent references for the construction of this article. Here they are, in no particular order:</p>

<ul>
  <li><a href="http://www.python.org/dev/peps/pep-0339/">PEP 339: Design of the CPython compiler</a> – probably the most important and comprehensive piece of <em>official</em> documentation for the Python compiler. Being very short, it painfully displays the scarcity of good documentation of the internals of Python.</li>
  <li>“Python Compiler Internals” – an article by Thomas Lee</li>
  <li>“Python: Design and Implementation” – a presentation by Guido van Rossum</li>
  <li>Python (2.5) Virtual Machine, A guided tour – a presentation by Peter Tröger</li>
</ul>

<p><a href="http://eli.thegreenplace.net/2010/06/30/python-internals-adding-a-new-statement-to-python/#id1">[1]</a> From here on, references to files in the Python source are given relatively to the root of the source tree, which is the directory where you run configure and make to build Python.</p>

<p><a href="http://eli.thegreenplace.net/2010/06/30/python-internals-adding-a-new-statement-to-python/#id2">[2]</a> This demonstrates a common technique I use when modifying source code I’m not familiar with: <em>work by similarity</em>. This principle won’t solve all your problems, but it can definitely ease the process. Since everything that has to be done forwhile also has to be done for until, it serves as a pretty good guideline.</p>

<p><a href="http://eli.thegreenplace.net/2010/06/30/python-internals-adding-a-new-statement-to-python/#id3">[3]</a> By the way, without this code there’s a compiler warning for Python/symtable.c. The compiler notices that theUntil_kind enumeration value isn’t handled in the switch statement of symtable_visit_stmt and complains. It’s always important to check for compiler warnings!</p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Python使用spark模块构造计算器]]></title>
    <link href="http://everet.org/2012/05/python-spark-calculator.html"/>
    <updated>2012-05-16T06:24:58+08:00</updated>
    <id>http://everet.org/2012/05/python-spark-calculator</id>
    <content type="html"><![CDATA[<h2 id="spark">Spark简介</h2>

<p>Spark 解析器与 EBNF 语法有一些共同之处，但它将解析／处理过程分成了比传统的 EBNF 语法所允许的更小的组件。Spark 的优点在于，它对整个过程中每一步操作的控制都进行了微调，还提供了将定制代码插入到过程中的能力。</p>

<p>Spark的最新版是10年前发布的，真是非常的长寿，可见设计精良。其中的采用的设计模式有Reflection Pattern、Visitor Pattern、Pipes and Filters Pattern和Strategy Pattern。</p>

<h2 id="spark-1">初识Spark</h2>

<p>第一次知道Spark这个模块是在IBM的网站<a href="http://everet.org/2012/05/python-spark-calculator.html#reference-everet-3">[3]</a>上看到的。</p>

<p>第一次激起我学习这个模块的兴趣是在看Python源码的时候，发现Python的编译器是用The Zephyr Abstract Syntax Description Language(Parser/Python.asdl)来定义的语法，然后通过(Parser/asdl.py、Parser/asdl_c.py、Parser/spark.py)根据Parser/Python.asdl生成C语言解析器。其中仅用了1000多行就实现了一个yacc。这个是非常地强大。<!-- more --></p>

<h2 id="section">计算器</h2>

<p>对于计算器的构造，我们在<a href="http://everet.org/2012/05/calculator-by-recursive-descent-parser.html">上文中</a>使用LL(1)递归下降的方法构造了一个。但是Spark更加强大，Spark是用Earley语法分析算法，能够解析所有的上下文无关文法，这比LL和LR要更强，当然代价是更慢。</p>

<p>我们来看用Spark实现的计算器：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>python  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;usrbinenv-python&quot;</span><span class="o">&gt;</span><span class="err">!</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">env</span> <span class="n">python</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c"># author:  Hua Liang [ Stupid ET ]</span>
</span><span class='line'><span class="c"># email:   et@everet.org</span>
</span><span class='line'><span class="c"># website: http://EverET.org</span>
</span><span class='line'><span class="c">#&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;grammar&quot;</span><span class="o">&gt;</span><span class="n">Grammar</span><span class="p">:</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c">#     expr    ::= expr addop term | term</span>
</span><span class='line'><span class="c">#     term    ::= term mulop factor | factor</span>
</span><span class='line'><span class="c">#     factor  ::= number | ( expr )</span>
</span><span class='line'><span class="c">#     addop   ::= + | -</span>
</span><span class='line'><span class="c">#     mulop   ::= * | /&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="kn">from</span> <span class="nn">spark</span> <span class="kn">import</span> <span class="n">GenericParser</span><span class="p">,</span> <span class="n">GenericScanner</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">class</span> <span class="nc">Token</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="k">def</span> <span class="err">&lt;</span><span class="nf">strong</span><span class="o">&gt;</span><span class="n">init</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="err">’’</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">attr</span> <span class="o">=</span> <span class="n">attr</span>
</span><span class='line'>    <span class="k">def</span> <span class="err">&lt;</span><span class="nf">strong</span><span class="o">&gt;</span><span class="nb">cmp</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
</span><span class='line'>    <span class="k">def</span> <span class="err">&lt;</span><span class="nf">strong</span><span class="o">&gt;</span><span class="nb">str</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span>
</span><span class='line'>    <span class="k">def</span> <span class="err">&lt;</span><span class="nf">strong</span><span class="o">&gt;</span><span class="nb">repr</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">class</span> <span class="nc">SimpleScanner</span><span class="p">(</span><span class="n">GenericScanner</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="k">def</span> <span class="err">&lt;</span><span class="nf">strong</span><span class="o">&gt;</span><span class="n">init</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="n">GenericScanner</span><span class="o">.&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">init</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">rv</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>    <span class="n">GenericScanner</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rv</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">t_whitespace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
</span><span class='line'>    <span class="s">r&#39; \s+ &#39;</span>
</span><span class='line'>    <span class="k">pass</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">t_op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
</span><span class='line'>    <span class="s">r&#39; \+ | \- | \* | / | \( | \) &#39;</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">rv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Token</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">s</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">t_number</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
</span><span class='line'>    <span class="s">r&#39; \d+ &#39;</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">rv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Token</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;number&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">s</span><span class="p">))</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">class</span> <span class="nc">ExprParser</span><span class="p">(</span><span class="n">GenericParser</span><span class="p">):</span>
</span><span class='line'>    <span class="k">def</span> <span class="err">&lt;</span><span class="nf">strong</span><span class="o">&gt;</span><span class="n">init</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="err">’</span><span class="n">expr</span><span class="err">’</span><span class="p">):</span>
</span><span class='line'>        <span class="n">GenericParser</span><span class="o">.&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">init</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">p_expr_term_0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)):</span>
</span><span class='line'>    <span class="sd">&#39;&#39;&#39;</span>
</span><span class='line'><span class="sd">        expr ::= expr addop term</span>
</span><span class='line'><span class="sd">        term ::= term mulop factor</span>
</span><span class='line'><span class="sd">    &#39;&#39;&#39;</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rhs</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">p_expr_term_factor_1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">)):</span>
</span><span class='line'>    <span class="sd">&#39;&#39;&#39;</span>
</span><span class='line'><span class="sd">        expr ::= term</span>
</span><span class='line'><span class="sd">        term ::= factor</span>
</span><span class='line'><span class="sd">    &#39;&#39;&#39;</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">v</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">p_factor_1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">)):</span>
</span><span class='line'>    <span class="s">&#39; factor ::= number &#39;</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">attr</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">p_factor_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">_0</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">_1</span><span class="p">)):</span>
</span><span class='line'>    <span class="s">&#39; factor ::= ( expr ) &#39;</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">expr</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">p_addop_mulop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="p">)):</span>
</span><span class='line'>    <span class="sd">&#39;&#39;&#39;</span>
</span><span class='line'><span class="sd">        addop ::= +</span>
</span><span class='line'><span class="sd">        addop ::= -</span>
</span><span class='line'><span class="sd">        mulop ::= *</span>
</span><span class='line'><span class="sd">        mulop ::= /</span>
</span><span class='line'><span class="sd">    &#39;&#39;&#39;</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">op</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
</span><span class='line'>    <span class="n">scanner</span> <span class="o">=</span> <span class="n">SimpleScanner</span><span class="p">()</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">scanner</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">code</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
</span><span class='line'>    <span class="n">parser</span> <span class="o">=</span> <span class="n">ExprParser</span><span class="p">()</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">if</span> <span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">name</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span> <span class="o">==</span> <span class="err">‘</span><span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">main</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span><span class="err">’</span><span class="p">:</span>
</span><span class='line'>    <span class="n">text</span> <span class="o">=</span> <span class="err">‘</span> <span class="mi">7</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="err">’</span>
</span><span class='line'>    <span class="k">print</span> <span class="n">parse</span><span class="p">(</span><span class="n">scan</span><span class="p">(</span><span class="n">text</span><span class="p">))</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>源码请见：<a href="https://github.com/cedricporter/et-python/tree/master/compilers/simple-cal">https://github.com/cedricporter/et-python/tree/master/compilers/simple-cal</a></p>

<h2 id="section-1">参考</h2>

<p>[1] Language Implementation Patterns</p>

<p>[2] Compiling Little Languages in Python</p>

<p>[3] <a href="https://www.ibm.com/developerworks/cn/linux/sdk/python/charm-27/">可爱的 Python: 使用 Spark 模块解析</a></p>

<p>[4] <a href="http://everet.org/2012/05/calculator-by-recursive-descent-parser.html">用LL(1)递归下降语法器构造一个计算器</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用LL(1)递归下降语法器构造一个计算器]]></title>
    <link href="http://everet.org/2012/05/calculator-by-recursive-descent-parser.html"/>
    <updated>2012-05-16T06:00:04+08:00</updated>
    <id>http://everet.org/2012/05/calculator-by-recursive-descent-parser</id>
    <content type="html"><![CDATA[<h2 id="ll1">LL(1)</h2>

<p>何为LL(1)？通俗来说就是向前看一个词法单元的自顶向下解析器。两个L都代表left-to-right，第一个L表示解析器按“从左到右”的顺序解析输入内容；第二个L表示下降解析时也是按“从左到右”的顺序遍历子节点。而(1)表示它使用一个向前看 词法单元。</p>

<p>我们从一个简单的计算器来看看递归下降的语法器如何构造。</p>

<p>对于 2 + 3 * 5 的抽象语法树如下：<!-- more --></p>

<p><a href="http://everet.org/wp-content/uploads/2012/05/Screenshot-from-2012-05-15-213202.png"><img src="http://everet.org/wp-content/uploads/2012/05/Screenshot-from-2012-05-15-213202.png" alt="" /></a></p>

<p>我们可以使用如下文法表示计算表达式：</p>

<p><code>
# expr ::= expr addop term | term
# term ::= term mulop factor | factor
# factor ::= number | ( expr )
# addop ::= + | -
# mulop ::= * | /
</code></p>

<h2 id="section">例子</h2>

<p>我们用Python构造一个递归下降实现的计算器。</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>python  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;usrbinenv-python&quot;</span><span class="o">&gt;</span><span class="err">!</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">env</span> <span class="n">python</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c"># author:  Hua Liang [ Stupid ET ]</span>
</span><span class='line'><span class="c"># email:   et@everet.org</span>
</span><span class='line'><span class="c"># website: http://EverET.org</span>
</span><span class='line'><span class="c">#&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;grammar&quot;</span><span class="o">&gt;</span><span class="n">Grammar</span><span class="p">:</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c">#     expr    ::= expr addop term | term</span>
</span><span class='line'><span class="c">#     term    ::= term mulop factor | factor</span>
</span><span class='line'><span class="c">#     factor  ::= number | ( expr )</span>
</span><span class='line'><span class="c">#     addop   ::= + | -</span>
</span><span class='line'><span class="c">#     mulop   ::= * | /&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="kn">import</span> <span class="nn">tokenize</span><span class="o">,</span> <span class="nn">StringIO</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">tokens</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'><span class="n">cur_tok</span> <span class="o">=</span> <span class="bp">None</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
</span><span class='line'>    <span class="n">g</span> <span class="o">=</span> <span class="n">tokenize</span><span class="o">.</span><span class="n">generate_tokens</span><span class="p">(</span>
</span><span class='line'>        <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">readline</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">((</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">get_token</span><span class="p">():</span>
</span><span class='line'>    <span class="k">global</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">cur_tok</span>
</span><span class='line'>    <span class="n">cur_tok</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
</span><span class='line'>    <span class="c">#print cur_tok</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">cur_tok</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="err">‘’</span><span class="p">):</span>
</span><span class='line'>    <span class="k">global</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">cur_tok</span>
</span><span class='line'>    <span class="n">t</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">cur_tok</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="nb">type</span> <span class="ow">or</span> <span class="n">t</span> <span class="o">==</span> <span class="n">tokenize</span><span class="o">.</span><span class="n">OP</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">==</span> <span class="n">val</span><span class="p">:</span>
</span><span class='line'>        <span class="n">get_token</span><span class="p">()</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="k">raise</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">expr</span><span class="p">():</span>
</span><span class='line'>    <span class="k">global</span> <span class="n">cur_tok</span>
</span><span class='line'>    <span class="n">tmp</span> <span class="o">=</span> <span class="n">term</span><span class="p">()</span>
</span><span class='line'>    <span class="n">t</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">cur_tok</span>
</span><span class='line'>    <span class="k">while</span> <span class="n">v</span> <span class="o">==</span> <span class="err">‘</span><span class="o">+</span><span class="err">’</span> <span class="ow">or</span> <span class="n">v</span> <span class="o">==</span> <span class="err">‘</span><span class="o">-</span><span class="err">‘</span><span class="p">:</span>
</span><span class='line'>        <span class="n">match</span><span class="p">(</span><span class="n">tokenize</span><span class="o">.</span><span class="n">OP</span><span class="p">)</span>
</span><span class='line'>        <span class="n">rhs</span> <span class="o">=</span> <span class="n">term</span><span class="p">()</span>
</span><span class='line'>        <span class="n">e</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span>
</span><span class='line'>        <span class="n">tmp</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class='line'>        <span class="k">print</span> <span class="n">e</span><span class="p">,</span> <span class="err">‘</span><span class="o">=</span><span class="err">’</span><span class="p">,</span> <span class="n">tmp</span>
</span><span class='line'>        <span class="n">t</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">cur_tok</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">tmp</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">term</span><span class="p">():</span>
</span><span class='line'>    <span class="k">global</span> <span class="n">cur_tok</span>
</span><span class='line'>    <span class="n">tmp</span> <span class="o">=</span> <span class="n">factor</span><span class="p">()</span>
</span><span class='line'>    <span class="n">t</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">cur_tok</span>
</span><span class='line'>    <span class="k">while</span> <span class="n">v</span> <span class="o">==</span> <span class="err">‘</span><span class="o">*</span><span class="err">’</span> <span class="ow">or</span> <span class="n">v</span> <span class="o">==</span> <span class="err">‘</span><span class="o">/</span><span class="err">’</span><span class="p">:</span>
</span><span class='line'>        <span class="n">match</span><span class="p">(</span><span class="n">tokenize</span><span class="o">.</span><span class="n">OP</span><span class="p">)</span>
</span><span class='line'>        <span class="n">rhs</span> <span class="o">=</span> <span class="n">factor</span><span class="p">()</span>
</span><span class='line'>        <span class="n">e</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span>
</span><span class='line'>        <span class="n">tmp</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class='line'>        <span class="k">print</span> <span class="n">e</span><span class="p">,</span> <span class="err">‘</span><span class="o">=</span><span class="err">’</span><span class="p">,</span> <span class="n">tmp</span>
</span><span class='line'>        <span class="n">t</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">cur_tok</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">tmp</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">factor</span><span class="p">():</span>
</span><span class='line'>    <span class="k">global</span> <span class="n">cur_tok</span>
</span><span class='line'>    <span class="n">t</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">cur_tok</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">tokenize</span><span class="o">.</span><span class="n">NUMBER</span><span class="p">:</span>
</span><span class='line'>        <span class="n">match</span><span class="p">(</span><span class="n">tokenize</span><span class="o">.</span><span class="n">NUMBER</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span class='line'>    <span class="k">elif</span> <span class="n">v</span> <span class="o">==</span> <span class="err">‘</span><span class="p">(</span><span class="err">‘</span><span class="p">:</span>
</span><span class='line'>        <span class="n">match</span><span class="p">(</span><span class="n">tokenize</span><span class="o">.</span><span class="n">OP</span><span class="p">,</span> <span class="err">‘</span><span class="p">(</span><span class="err">‘</span><span class="p">)</span>
</span><span class='line'>        <span class="n">tmp</span> <span class="o">=</span> <span class="n">expr</span><span class="p">()</span>
</span><span class='line'>        <span class="n">match</span><span class="p">(</span><span class="n">tokenize</span><span class="o">.</span><span class="n">OP</span><span class="p">,</span> <span class="err">‘</span><span class="p">)</span><span class="err">’</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">tmp</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="k">raise</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">if</span> <span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">name</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span> <span class="o">==</span> <span class="err">‘</span><span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">main</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span><span class="err">’</span><span class="p">:</span>
</span><span class='line'>    <span class="n">text</span> <span class="o">=</span> <span class="err">‘</span><span class="mi">12</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">5</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">)</span><span class="err">’</span>
</span><span class='line'>    <span class="n">tokens</span> <span class="o">=</span> <span class="n">scan</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span class='line'>    <span class="n">get_token</span><span class="p">()</span>
</span><span class='line'>    <span class="n">res</span> <span class="o">=</span> <span class="n">expr</span><span class="p">()</span>
</span><span class='line'>    <span class="k">print</span> <span class="n">text</span><span class="p">,</span> <span class="err">‘</span><span class="o">=</span><span class="err">’</span><span class="p">,</span> <span class="n">res</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>对于12 + 2 * ( 5 + 6 )，运行结果如下：
<a href="http://everet.org/wp-content/uploads/2012/05/Screenshot-from-2012-05-15-214802.png"><img src="http://everet.org/wp-content/uploads/2012/05/Screenshot-from-2012-05-15-214802.png" alt="" /></a></p>

<p>源码请见：<a href="https://github.com/cedricporter/et-python/blob/master/compilers/func-cal/main.py">https://github.com/cedricporter/et-python/blob/master/compilers/func-cal/main.py</a></p>

<h2 id="section-1">参考</h2>

<p>[1] Language Implementation Patterns</p>

<p>[2] Compiling Little Languages in Python</p>

<p>[3] <a href="http://everet.org/2012/05/python-spark-calculator.html">Python使用spark模块构造计算器</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[构建LL(1)递归下降语法解析器]]></title>
    <link href="http://everet.org/2012/05/building-recursive-descent-parser.html"/>
    <updated>2012-05-16T05:59:07+08:00</updated>
    <id>http://everet.org/2012/05/building-recursive-descent-parser</id>
    <content type="html"><![CDATA[<p>不管什么语言应用，识别语言这一步都很重要。</p>

<p>在小学时，大家都学习过如何分辨句子中的不同语言成分，例如动词和名词等。识别计算机语言也是如此（我们称之为语法分析）。</p>

<h2 id="section">小例子</h2>

<p>我们来看一下：</p>

<blockquote>
  <p>return x + 1;</p>
</blockquote>

<p>语法图：<!-- more --></p>

<p><a href="http://everet.org/wp-content/uploads/2012/05/Screenshot-from-2012-05-15-210601.png"><img src="http://everet.org/wp-content/uploads/2012/05/Screenshot-from-2012-05-15-210601.png" alt="" /></a></p>

<p>解析树：</p>

<p><a href="http://everet.org/wp-content/uploads/2012/05/Screenshot-from-2012-05-15-210616.png"><img src="http://everet.org/wp-content/uploads/2012/05/Screenshot-from-2012-05-15-210616.png" alt="" /></a></p>

<p>树上的叶节点是词法单元，分子节点表示推导式中的子结构。</p>

<p>我们来看一下手工编写语言解析器。</p>

<p>为了验证语句的是否合法，解析器需要识别语句的解析树。但是，解析器不一定在内存中构造这么一个树状结构。一般情况下，我们只需要在遇到子结构时采用适当的操作即可。也就是说，解析器的任务是“遇到某些结构，就执行某些操作”。</p>

<p>为了避免构造解析树，我们通过函数调用序列隐私地得到他们的信息。我们要做的事情就是为每一个子结构构造一个函数。</p>

<p><code>
stat  ::= returnstat
returnstat ::= "return" expr ";"
expr ::= "x" "+" "1"
</code></p>

<p>构造出来的函数：</p>

<p><code>
/** To parse a statement, call stat(); */
void stat()
{ returnstat(); }
void returnstat() { match("return" ); expr(); match(";" ); }
void expr()
{ match("x" ); match("+" ); match("1" ); }
</code></p>

<p>如何解析if、return和赋值语句呢？</p>

<p>我们可以将stat实现成这样。</p>

<p><code>
void stat() {
 if ( «lookahead token is return » )               returnstat();
 else if ( «lookahead token is identifier » ) assign();
 else if ( «lookahead token is if » )                ifstat();
 else «parse error »
}
</code></p>

<p>如果要手写这种解析器，头几个可能挺好玩的，但是这样的活多干几次就会觉得很无聊了。</p>

<h2 id="section-1">例子</h2>

<ul>
  <li><a href="http://everet.org/2012/05/calculator-by-recursive-descent-parser.html">用Python实现的LL(1)递归下降语法器计算器</a></li>
  <li><a href="http://everet.org/2012/05/python-spark-calculator.html">Python使用spark模块构造计算器</a></li>
</ul>

<h2 id="section-2">参考</h2>

<p>[1] Language Implementation Patterns</p>

<p>[2] Compiling Little Languages in Python</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Python文法]]></title>
    <link href="http://everet.org/2012/05/python-grammar.html"/>
    <updated>2012-05-15T03:09:29+08:00</updated>
    <id>http://everet.org/2012/05/python-grammar</id>
    <content type="html"><![CDATA[<p>文法以一种简洁的形式描述着语言的语法。</p>

<p>以下是Python的文法，摘自Python源码目录下的Grammar/Grammar。</p>

<p>Python的编译器的设计：<a href="http://www.python.org/dev/peps/pep-0339/">http://www.python.org/dev/peps/pep-0339/</a></p>

<p><a href="http://everet.org/wp-content/uploads/2012/05/The-Zephyr-Abstract-Syntax-Description-Language.pdf">The Zephyr Abstract Syntax Description Language.pdf</a></p>

<!-- more -->

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>python  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;start-symbols-for-the-grammar&quot;</span><span class="o">&gt;</span><span class="n">Start</span> <span class="n">symbols</span> <span class="k">for</span> <span class="n">the</span> <span class="n">grammar</span><span class="p">:</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c">#       single_input is a single interactive statement;</span>
</span><span class='line'><span class="c">#       file_input is a module or sequence of commands read from an input file;</span>
</span><span class='line'><span class="c">#       eval_input is the input for the eval() and input() functions.</span>
</span><span class='line'><span class="c"># NB: compound_stmt in single_input is followed by extra NEWLINE!</span>
</span><span class='line'><span class="n">single_input</span><span class="p">:</span> <span class="n">NEWLINE</span> <span class="o">|</span> <span class="n">simple_stmt</span> <span class="o">|</span> <span class="n">compound_stmt</span> <span class="n">NEWLINE</span>
</span><span class='line'><span class="n">file_input</span><span class="p">:</span> <span class="p">(</span><span class="n">NEWLINE</span> <span class="o">|</span> <span class="n">stmt</span><span class="p">)</span><span class="o">*</span> <span class="n">ENDMARKER</span>
</span><span class='line'><span class="n">eval_input</span><span class="p">:</span> <span class="n">testlist</span> <span class="n">NEWLINE</span><span class="o">*</span> <span class="n">ENDMARKER</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">decorator</span><span class="p">:</span> <span class="err">‘@’</span> <span class="n">dotted_name</span> <span class="p">[</span> <span class="err">‘</span><span class="p">(</span><span class="err">‘</span> <span class="p">[</span><span class="n">arglist</span><span class="p">]</span> <span class="err">‘</span><span class="p">)</span><span class="err">’</span> <span class="p">]</span> <span class="n">NEWLINE</span>
</span><span class='line'><span class="n">decorators</span><span class="p">:</span> <span class="n">decorator</span><span class="o">+</span>
</span><span class='line'><span class="n">decorated</span><span class="p">:</span> <span class="n">decorators</span> <span class="p">(</span><span class="n">classdef</span> <span class="o">|</span> <span class="n">funcdef</span><span class="p">)</span>
</span><span class='line'><span class="n">funcdef</span><span class="p">:</span> <span class="err">‘</span><span class="n">def</span><span class="err">’</span> <span class="n">NAME</span> <span class="n">parameters</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="n">suite</span>
</span><span class='line'><span class="n">parameters</span><span class="p">:</span> <span class="err">‘</span><span class="p">(</span><span class="err">‘</span> <span class="p">[</span><span class="n">varargslist</span><span class="p">]</span> <span class="err">‘</span><span class="p">)</span><span class="err">’</span>
</span><span class='line'><span class="n">varargslist</span><span class="p">:</span> <span class="p">((</span><span class="n">fpdef</span> <span class="p">[</span><span class="err">’</span><span class="o">=</span><span class="err">’</span> <span class="n">test</span><span class="p">]</span> <span class="err">‘</span><span class="p">,</span><span class="err">’</span><span class="p">)</span><span class="o">*</span>
</span><span class='line'>              <span class="p">(</span><span class="err">‘</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="err">’</span> <span class="n">NAME</span> <span class="p">[</span><span class="err">’</span><span class="p">,</span><span class="err">’</span> <span class="err">‘</span><span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="err">’</span> <span class="n">NAME</span><span class="p">]</span> <span class="o">|</span> <span class="err">‘</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span><span class="err">’</span> <span class="n">NAME</span><span class="p">)</span> <span class="o">|</span>
</span><span class='line'>              <span class="n">fpdef</span> <span class="p">[</span><span class="err">’</span><span class="o">=</span><span class="err">’</span> <span class="n">test</span><span class="p">]</span> <span class="p">(</span><span class="err">‘</span><span class="p">,</span><span class="err">’</span> <span class="n">fpdef</span> <span class="p">[</span><span class="err">’</span><span class="o">=</span><span class="err">’</span> <span class="n">test</span><span class="p">])</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span> <span class="p">[</span><span class="err">’</span><span class="p">,</span><span class="err">’</span><span class="p">])</span>
</span><span class='line'><span class="n">fpdef</span><span class="p">:</span> <span class="n">NAME</span> <span class="o">|</span> <span class="err">‘</span><span class="p">(</span><span class="err">‘</span> <span class="n">fplist</span> <span class="err">‘</span><span class="p">)</span><span class="err">’</span>
</span><span class='line'><span class="n">fplist</span><span class="p">:</span> <span class="n">fpdef</span> <span class="p">(</span><span class="err">‘</span><span class="p">,</span><span class="err">’</span> <span class="n">fpdef</span><span class="p">)</span><span class="o">*</span> <span class="p">[</span><span class="err">’</span><span class="p">,</span><span class="err">’</span><span class="p">]</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">stmt</span><span class="p">:</span> <span class="n">simple_stmt</span> <span class="o">|</span> <span class="n">compound_stmt</span>
</span><span class='line'><span class="n">simple_stmt</span><span class="p">:</span> <span class="n">small_stmt</span> <span class="p">(</span><span class="err">‘</span><span class="p">;</span><span class="err">’</span> <span class="n">small_stmt</span><span class="p">)</span><span class="o">*</span> <span class="p">[</span><span class="err">’</span><span class="p">;</span><span class="err">’</span><span class="p">]</span> <span class="n">NEWLINE</span>
</span><span class='line'><span class="n">small_stmt</span><span class="p">:</span> <span class="p">(</span><span class="n">expr_stmt</span> <span class="o">|</span> <span class="n">print_stmt</span>  <span class="o">|</span> <span class="n">del_stmt</span> <span class="o">|</span> <span class="n">pass_stmt</span> <span class="o">|</span> <span class="n">flow_stmt</span> <span class="o">|</span>
</span><span class='line'>             <span class="n">import_stmt</span> <span class="o">|</span> <span class="n">global_stmt</span> <span class="o">|</span> <span class="n">exec_stmt</span> <span class="o">|</span> <span class="n">assert_stmt</span><span class="p">)</span>
</span><span class='line'><span class="n">expr_stmt</span><span class="p">:</span> <span class="n">testlist</span> <span class="p">(</span><span class="n">augassign</span> <span class="p">(</span><span class="n">yield_expr</span><span class="o">|</span><span class="n">testlist</span><span class="p">)</span> <span class="o">|</span>
</span><span class='line'>                     <span class="p">(</span><span class="err">‘</span><span class="o">=</span><span class="err">’</span> <span class="p">(</span><span class="n">yield_expr</span><span class="o">|</span><span class="n">testlist</span><span class="p">))</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="p">)</span>
</span><span class='line'><span class="n">augassign</span><span class="p">:</span> <span class="p">(</span><span class="err">‘</span><span class="o">+=</span><span class="err">’</span> <span class="o">|</span> <span class="err">‘</span><span class="o">-=</span><span class="err">’</span> <span class="o">|</span> <span class="err">‘</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;=</span><span class="err">’</span> <span class="o">|</span> <span class="err">‘</span><span class="o">/=</span><span class="err">’</span> <span class="o">|</span> <span class="err">‘</span><span class="o">%=</span><span class="err">’</span> <span class="o">|</span> <span class="err">‘</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">=</span><span class="err">’</span> <span class="o">|</span> <span class="err">‘</span><span class="o">|=</span><span class="err">’</span> <span class="o">|</span> <span class="err">‘</span><span class="o">^=</span><span class="err">’</span> <span class="o">|</span>
</span><span class='line'>            <span class="err">‘</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="c"># For normal assignments,</span>
</span><span class='line'><span class="c"># additional restrictions enforced by the interpreter</span>
</span><span class='line'><span class="n">print_stmt</span><span class="p">:</span> <span class="err">‘</span><span class="k">print</span><span class="err">’</span> <span class="p">(</span> <span class="p">[</span> <span class="n">test</span> <span class="p">(</span><span class="err">‘</span><span class="p">,</span><span class="err">’</span> <span class="n">test</span><span class="p">)</span><span class="o">*</span> <span class="p">[</span><span class="err">’</span><span class="p">,</span><span class="err">’</span><span class="p">]</span> <span class="p">]</span> <span class="o">|</span>
</span><span class='line'>                      <span class="err">‘»’</span> <span class="n">test</span> <span class="p">[</span> <span class="p">(</span><span class="err">‘</span><span class="p">,</span><span class="err">’</span> <span class="n">test</span><span class="p">)</span><span class="o">+</span> <span class="p">[</span><span class="err">’</span><span class="p">,</span><span class="err">’</span><span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
</span><span class='line'><span class="n">del_stmt</span><span class="p">:</span> <span class="err">‘</span><span class="k">del</span><span class="err">’</span> <span class="n">exprlist</span>
</span><span class='line'><span class="n">pass_stmt</span><span class="p">:</span> <span class="err">‘</span><span class="k">pass</span><span class="err">’</span>
</span><span class='line'><span class="n">flow_stmt</span><span class="p">:</span> <span class="n">break_stmt</span> <span class="o">|</span> <span class="n">continue_stmt</span> <span class="o">|</span> <span class="n">return_stmt</span> <span class="o">|</span> <span class="n">raise_stmt</span> <span class="o">|</span> <span class="n">yield_stmt</span>
</span><span class='line'><span class="n">break_stmt</span><span class="p">:</span> <span class="err">‘</span><span class="k">break</span><span class="err">’</span>
</span><span class='line'><span class="n">continue_stmt</span><span class="p">:</span> <span class="err">‘</span><span class="k">continue</span><span class="err">’</span>
</span><span class='line'><span class="n">return_stmt</span><span class="p">:</span> <span class="err">‘</span><span class="k">return</span><span class="err">’</span> <span class="p">[</span><span class="n">testlist</span><span class="p">]</span>
</span><span class='line'><span class="n">yield_stmt</span><span class="p">:</span> <span class="n">yield_expr</span>
</span><span class='line'><span class="n">raise_stmt</span><span class="p">:</span> <span class="err">‘</span><span class="k">raise</span><span class="err">’</span> <span class="p">[</span><span class="n">test</span> <span class="p">[</span><span class="err">’</span><span class="p">,</span><span class="err">’</span> <span class="n">test</span> <span class="p">[</span><span class="err">’</span><span class="p">,</span><span class="err">’</span> <span class="n">test</span><span class="p">]]]</span>
</span><span class='line'><span class="n">import_stmt</span><span class="p">:</span> <span class="n">import_name</span> <span class="o">|</span> <span class="n">import_from</span>
</span><span class='line'><span class="n">import_name</span><span class="p">:</span> <span class="err">‘</span><span class="n">import</span><span class="err">’</span> <span class="n">dotted_as_names</span>
</span><span class='line'><span class="n">import_from</span><span class="p">:</span> <span class="p">(</span><span class="err">‘</span><span class="n">from</span><span class="err">’</span> <span class="p">(</span><span class="err">‘</span><span class="o">.</span><span class="err">’</span><span class="o">*</span> <span class="n">dotted_name</span> <span class="o">|</span> <span class="err">‘</span><span class="o">.</span><span class="err">’</span><span class="o">+</span><span class="p">)</span>
</span><span class='line'>              <span class="err">‘</span><span class="n">import</span><span class="err">’</span> <span class="p">(</span><span class="err">‘</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="err">’</span> <span class="o">|</span> <span class="err">‘</span><span class="p">(</span><span class="err">‘</span> <span class="n">import_as_names</span> <span class="err">‘</span><span class="p">)</span><span class="err">’</span> <span class="o">|</span> <span class="n">import_as_names</span><span class="p">))</span>
</span><span class='line'><span class="n">import_as_name</span><span class="p">:</span> <span class="n">NAME</span> <span class="p">[</span><span class="err">‘</span><span class="k">as</span><span class="err">’</span> <span class="n">NAME</span><span class="p">]</span>
</span><span class='line'><span class="n">dotted_as_name</span><span class="p">:</span> <span class="n">dotted_name</span> <span class="p">[</span><span class="err">‘</span><span class="k">as</span><span class="err">’</span> <span class="n">NAME</span><span class="p">]</span>
</span><span class='line'><span class="n">import_as_names</span><span class="p">:</span> <span class="n">import_as_name</span> <span class="p">(</span><span class="err">‘</span><span class="p">,</span><span class="err">’</span> <span class="n">import_as_name</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span> <span class="p">[</span><span class="err">’</span><span class="p">,</span><span class="err">’</span><span class="p">]</span>
</span><span class='line'><span class="n">dotted_as_names</span><span class="p">:</span> <span class="n">dotted_as_name</span> <span class="p">(</span><span class="err">‘</span><span class="p">,</span><span class="err">’</span> <span class="n">dotted_as_name</span><span class="p">)</span><span class="o">*</span>
</span><span class='line'><span class="n">dotted_name</span><span class="p">:</span> <span class="n">NAME</span> <span class="p">(</span><span class="err">‘</span><span class="o">.</span><span class="err">’</span> <span class="n">NAME</span><span class="p">)</span><span class="o">*</span>
</span><span class='line'><span class="n">global_stmt</span><span class="p">:</span> <span class="err">‘</span><span class="k">global</span><span class="err">’</span> <span class="n">NAME</span> <span class="p">(</span><span class="err">‘</span><span class="p">,</span><span class="err">’</span> <span class="n">NAME</span><span class="p">)</span><span class="o">*</span>
</span><span class='line'><span class="n">exec_stmt</span><span class="p">:</span> <span class="err">‘</span><span class="k">exec</span><span class="err">’</span> <span class="n">expr</span> <span class="p">[</span><span class="err">‘</span><span class="ow">in</span><span class="err">’</span> <span class="n">test</span> <span class="p">[</span><span class="err">’</span><span class="p">,</span><span class="err">’</span> <span class="n">test</span><span class="p">]]</span>
</span><span class='line'><span class="n">assert_stmt</span><span class="p">:</span> <span class="err">‘</span><span class="k">assert</span><span class="err">’</span> <span class="n">test</span> <span class="p">[</span><span class="err">’</span><span class="p">,</span><span class="err">’</span> <span class="n">test</span><span class="p">]</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">compound_stmt</span><span class="p">:</span> <span class="n">if_stmt</span> <span class="o">|</span> <span class="n">while_stmt</span> <span class="o">|</span> <span class="n">for_stmt</span> <span class="o">|</span> <span class="n">try_stmt</span> <span class="o">|</span> <span class="n">with_stmt</span> <span class="o">|</span> <span class="n">funcdef</span> <span class="o">|</span> <span class="n">classdef</span> <span class="o">|</span> <span class="n">decorated</span>
</span><span class='line'><span class="n">if_stmt</span><span class="p">:</span> <span class="err">‘</span><span class="k">if</span><span class="err">’</span> <span class="n">test</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="n">suite</span> <span class="p">(</span><span class="err">‘</span><span class="k">elif</span><span class="err">’</span> <span class="n">test</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="n">suite</span><span class="p">)</span><span class="o">*</span> <span class="p">[</span><span class="err">‘</span><span class="k">else</span><span class="err">’</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="n">suite</span><span class="p">]</span>
</span><span class='line'><span class="n">while_stmt</span><span class="p">:</span> <span class="err">‘</span><span class="k">while</span><span class="err">’</span> <span class="n">test</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="n">suite</span> <span class="p">[</span><span class="err">‘</span><span class="k">else</span><span class="err">’</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="n">suite</span><span class="p">]</span>
</span><span class='line'><span class="n">for_stmt</span><span class="p">:</span> <span class="err">‘</span><span class="k">for</span><span class="err">’</span> <span class="n">exprlist</span> <span class="err">‘</span><span class="ow">in</span><span class="err">’</span> <span class="n">testlist</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="n">suite</span> <span class="p">[</span><span class="err">‘</span><span class="k">else</span><span class="err">’</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="n">suite</span><span class="p">]</span>
</span><span class='line'><span class="n">try_stmt</span><span class="p">:</span> <span class="p">(</span><span class="err">‘</span><span class="k">try</span><span class="err">’</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="n">suite</span>
</span><span class='line'>           <span class="p">((</span><span class="n">except_clause</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="n">suite</span><span class="p">)</span><span class="o">+</span>
</span><span class='line'>            <span class="p">[</span><span class="err">‘</span><span class="k">else</span><span class="err">’</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="n">suite</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="err">‘</span><span class="k">finally</span><span class="err">’</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="n">suite</span><span class="p">]</span> <span class="o">|</span>
</span><span class='line'>           <span class="err">‘</span><span class="k">finally</span><span class="err">’</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="n">suite</span><span class="p">))</span>
</span><span class='line'><span class="n">with_stmt</span><span class="p">:</span> <span class="err">‘</span><span class="k">with</span><span class="err">’</span> <span class="n">with_item</span> <span class="p">(</span><span class="err">‘</span><span class="p">,</span><span class="err">’</span> <span class="n">with_item</span><span class="p">)</span><span class="o">*</span>  <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="n">suite</span>
</span><span class='line'><span class="n">with_item</span><span class="p">:</span> <span class="n">test</span> <span class="p">[</span><span class="err">‘</span><span class="k">as</span><span class="err">’</span> <span class="n">expr</span><span class="p">]</span>
</span><span class='line'><span class="c"># NB compile.c makes sure that the default except clause is last</span>
</span><span class='line'><span class="n">except_clause</span><span class="p">:</span> <span class="err">‘</span><span class="k">except</span><span class="err">’</span> <span class="p">[</span><span class="n">test</span> <span class="p">[(</span><span class="err">‘</span><span class="k">as</span><span class="err">’</span> <span class="o">|</span> <span class="err">‘</span><span class="p">,</span><span class="err">’</span><span class="p">)</span> <span class="n">test</span><span class="p">]]</span>
</span><span class='line'><span class="n">suite</span><span class="p">:</span> <span class="n">simple_stmt</span> <span class="o">|</span> <span class="n">NEWLINE</span> <span class="n">INDENT</span> <span class="n">stmt</span><span class="o">+</span> <span class="n">DEDENT</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;backward-compatibility-cruft-to-support&quot;</span><span class="o">&gt;</span><span class="n">Backward</span> <span class="n">compatibility</span> <span class="n">cruft</span> <span class="n">to</span> <span class="n">support</span><span class="p">:</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c"># [ x for x in lambda: True, lambda: False if x() ]</span>
</span><span class='line'><span class="c"># even while also allowing:</span>
</span><span class='line'><span class="c"># lambda x: 5 if x else 2</span>
</span><span class='line'><span class="c"># (But not a mix of the two)</span>
</span><span class='line'><span class="n">testlist_safe</span><span class="p">:</span> <span class="n">old_test</span> <span class="p">[(</span><span class="err">‘</span><span class="p">,</span><span class="err">’</span> <span class="n">old_test</span><span class="p">)</span><span class="o">+</span> <span class="p">[</span><span class="err">’</span><span class="p">,</span><span class="err">’</span><span class="p">]]</span>
</span><span class='line'><span class="n">old_test</span><span class="p">:</span> <span class="n">or_test</span> <span class="o">|</span> <span class="n">old_lambdef</span>
</span><span class='line'><span class="n">old_lambdef</span><span class="p">:</span> <span class="err">‘</span><span class="k">lambda</span><span class="err">’</span> <span class="p">[</span><span class="n">varargslist</span><span class="p">]</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="n">old_test</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">test</span><span class="p">:</span> <span class="n">or_test</span> <span class="p">[</span><span class="err">‘</span><span class="k">if</span><span class="err">’</span> <span class="n">or_test</span> <span class="err">‘</span><span class="k">else</span><span class="err">’</span> <span class="n">test</span><span class="p">]</span> <span class="o">|</span> <span class="n">lambdef</span>
</span><span class='line'><span class="n">or_test</span><span class="p">:</span> <span class="n">and_test</span> <span class="p">(</span><span class="err">‘</span><span class="ow">or</span><span class="err">’</span> <span class="n">and_test</span><span class="p">)</span><span class="o">*</span>
</span><span class='line'><span class="n">and_test</span><span class="p">:</span> <span class="n">not_test</span> <span class="p">(</span><span class="err">‘</span><span class="ow">and</span><span class="err">’</span> <span class="n">not_test</span><span class="p">)</span><span class="o">*</span>
</span><span class='line'><span class="n">not_test</span><span class="p">:</span> <span class="err">‘</span><span class="ow">not</span><span class="err">’</span> <span class="n">not_test</span> <span class="o">|</span> <span class="n">comparison</span>
</span><span class='line'><span class="n">comparison</span><span class="p">:</span> <span class="n">expr</span> <span class="p">(</span><span class="n">comp_op</span> <span class="n">expr</span><span class="p">)</span><span class="o">*</span>
</span><span class='line'><span class="n">comp_op</span><span class="p">:</span> <span class="err">‘’</span><span class="o">|</span><span class="err">’</span><span class="o">==</span><span class="err">’</span><span class="o">|</span><span class="err">’</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">=</span><span class="err">’</span><span class="o">|</span><span class="err">’’</span><span class="o">|</span><span class="err">’</span><span class="o">!=</span><span class="err">’</span><span class="o">|</span><span class="err">’</span><span class="ow">in</span><span class="err">’</span><span class="o">|</span><span class="err">’</span><span class="ow">not</span><span class="err">’</span> <span class="err">‘</span><span class="ow">in</span><span class="err">’</span><span class="o">|</span><span class="err">’</span><span class="ow">is</span><span class="err">’</span><span class="o">|</span><span class="err">’</span><span class="ow">is</span><span class="err">’</span> <span class="err">‘</span><span class="ow">not</span><span class="err">’</span>
</span><span class='line'><span class="n">expr</span><span class="p">:</span> <span class="n">xor_expr</span> <span class="p">(</span><span class="err">‘</span><span class="o">|</span><span class="err">’</span> <span class="n">xor_expr</span><span class="p">)</span><span class="o">*</span>
</span><span class='line'><span class="n">xor_expr</span><span class="p">:</span> <span class="n">and_expr</span> <span class="p">(</span><span class="err">‘</span><span class="o">^</span><span class="err">’</span> <span class="n">and_expr</span><span class="p">)</span><span class="o">*</span>
</span><span class='line'><span class="n">and_expr</span><span class="p">:</span> <span class="n">shift_expr</span> <span class="p">(</span><span class="err">‘</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="err">’</span> <span class="n">shift_expr</span><span class="p">)</span><span class="o">*</span>
</span><span class='line'><span class="n">shift_expr</span><span class="p">:</span> <span class="n">arith_expr</span> <span class="p">((</span><span class="err">‘</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="err">’</span><span class="p">)</span> <span class="n">arith_expr</span><span class="p">)</span><span class="o">*</span>
</span><span class='line'><span class="n">arith_expr</span><span class="p">:</span> <span class="n">term</span> <span class="p">((</span><span class="err">‘</span><span class="o">+</span><span class="err">’</span><span class="o">|</span><span class="err">’</span><span class="o">-</span><span class="err">‘</span><span class="p">)</span> <span class="n">term</span><span class="p">)</span><span class="o">*</span>
</span><span class='line'><span class="n">term</span><span class="p">:</span> <span class="n">factor</span> <span class="p">((</span><span class="err">‘</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="err">’</span><span class="o">|</span><span class="err">’</span><span class="o">/</span><span class="err">’</span><span class="o">|</span><span class="err">’</span><span class="o">%</span><span class="err">’</span><span class="o">|</span><span class="err">’</span><span class="o">//</span><span class="err">’</span><span class="p">)</span> <span class="n">factor</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">factor</span><span class="p">:</span> <span class="p">(</span><span class="err">‘</span><span class="o">+</span><span class="err">’</span><span class="o">|</span><span class="err">’</span><span class="o">-</span><span class="err">‘</span><span class="o">|</span><span class="err">’</span><span class="o">~</span><span class="err">’</span><span class="p">)</span> <span class="n">factor</span> <span class="o">|</span> <span class="n">power</span>
</span><span class='line'><span class="n">power</span><span class="p">:</span> <span class="n">atom</span> <span class="n">trailer</span><span class="o">*</span> <span class="p">[</span><span class="err">’</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;*</span><span class="err">’</span> <span class="n">factor</span><span class="p">]</span>
</span><span class='line'><span class="n">atom</span><span class="p">:</span> <span class="p">(</span><span class="err">‘</span><span class="p">(</span><span class="err">‘</span> <span class="p">[</span><span class="n">yield_expr</span><span class="o">|</span><span class="n">testlist_comp</span><span class="p">]</span> <span class="err">‘</span><span class="p">)</span><span class="err">’</span> <span class="o">|</span>
</span><span class='line'>       <span class="err">‘</span><span class="p">[</span><span class="err">’</span> <span class="p">[</span><span class="n">listmaker</span><span class="p">]</span> <span class="err">‘</span><span class="p">]</span><span class="err">’</span> <span class="o">|</span>
</span><span class='line'>       <span class="err">‘</span><span class="p">{</span><span class="err">‘</span> <span class="p">[</span><span class="n">dictorsetmaker</span><span class="p">]</span> <span class="err">‘</span><span class="p">}</span><span class="err">’</span> <span class="o">|</span>
</span><span class='line'>       <span class="err">‘</span><span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="s">&#39; testlist1 &#39;</span><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span><span class="err">’</span> <span class="o">|</span>
</span><span class='line'>       <span class="n">NAME</span> <span class="o">|</span> <span class="n">NUMBER</span> <span class="o">|</span> <span class="n">STRING</span><span class="o">+</span><span class="p">)</span>
</span><span class='line'><span class="n">listmaker</span><span class="p">:</span> <span class="n">test</span> <span class="p">(</span> <span class="n">list_for</span> <span class="o">|</span> <span class="p">(</span><span class="err">‘</span><span class="p">,</span><span class="err">’</span> <span class="n">test</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span> <span class="p">[</span><span class="err">’</span><span class="p">,</span><span class="err">’</span><span class="p">]</span> <span class="p">)</span>
</span><span class='line'><span class="n">testlist_comp</span><span class="p">:</span> <span class="n">test</span> <span class="p">(</span> <span class="n">comp_for</span> <span class="o">|</span> <span class="p">(</span><span class="err">‘</span><span class="p">,</span><span class="err">’</span> <span class="n">test</span><span class="p">)</span><span class="o">*</span> <span class="p">[</span><span class="err">’</span><span class="p">,</span><span class="err">’</span><span class="p">]</span> <span class="p">)</span>
</span><span class='line'><span class="n">lambdef</span><span class="p">:</span> <span class="err">‘</span><span class="k">lambda</span><span class="err">’</span> <span class="p">[</span><span class="n">varargslist</span><span class="p">]</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="n">test</span>
</span><span class='line'><span class="n">trailer</span><span class="p">:</span> <span class="err">‘</span><span class="p">(</span><span class="err">‘</span> <span class="p">[</span><span class="n">arglist</span><span class="p">]</span> <span class="err">‘</span><span class="p">)</span><span class="err">’</span> <span class="o">|</span> <span class="err">‘</span><span class="p">[</span><span class="err">’</span> <span class="n">subscriptlist</span> <span class="err">‘</span><span class="p">]</span><span class="err">’</span> <span class="o">|</span> <span class="err">‘</span><span class="o">.</span><span class="err">’</span> <span class="n">NAME</span>
</span><span class='line'><span class="n">subscriptlist</span><span class="p">:</span> <span class="n">subscript</span> <span class="p">(</span><span class="err">‘</span><span class="p">,</span><span class="err">’</span> <span class="n">subscript</span><span class="p">)</span><span class="o">*</span> <span class="p">[</span><span class="err">’</span><span class="p">,</span><span class="err">’</span><span class="p">]</span>
</span><span class='line'><span class="n">subscript</span><span class="p">:</span> <span class="err">‘</span><span class="o">.</span><span class="err">’</span> <span class="err">‘</span><span class="o">.</span><span class="err">’</span> <span class="err">‘</span><span class="o">.</span><span class="err">’</span> <span class="o">|</span> <span class="n">test</span> <span class="o">|</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span> <span class="p">[</span><span class="n">sliceop</span><span class="p">]</span>
</span><span class='line'><span class="n">sliceop</span><span class="p">:</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span>
</span><span class='line'><span class="n">exprlist</span><span class="p">:</span> <span class="n">expr</span> <span class="p">(</span><span class="err">‘</span><span class="p">,</span><span class="err">’</span> <span class="n">expr</span><span class="p">)</span><span class="o">*</span> <span class="p">[</span><span class="err">’</span><span class="p">,</span><span class="err">’</span><span class="p">]</span>
</span><span class='line'><span class="n">testlist</span><span class="p">:</span> <span class="n">test</span> <span class="p">(</span><span class="err">‘</span><span class="p">,</span><span class="err">’</span> <span class="n">test</span><span class="p">)</span><span class="o">*</span> <span class="p">[</span><span class="err">’</span><span class="p">,</span><span class="err">’</span><span class="p">]</span>
</span><span class='line'><span class="n">dictorsetmaker</span><span class="p">:</span> <span class="p">(</span> <span class="p">(</span><span class="n">test</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="n">test</span> <span class="p">(</span><span class="n">comp_for</span> <span class="o">|</span> <span class="p">(</span><span class="err">‘</span><span class="p">,</span><span class="err">’</span> <span class="n">test</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="n">test</span><span class="p">)</span><span class="o">*</span> <span class="p">[</span><span class="err">’</span><span class="p">,</span><span class="err">’</span><span class="p">]))</span> <span class="o">|</span>
</span><span class='line'>                  <span class="p">(</span><span class="n">test</span> <span class="p">(</span><span class="n">comp_for</span> <span class="o">|</span> <span class="p">(</span><span class="err">‘</span><span class="p">,</span><span class="err">’</span> <span class="n">test</span><span class="p">)</span><span class="o">*</span> <span class="p">[</span><span class="err">’</span><span class="p">,</span><span class="err">’</span><span class="p">]))</span> <span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">classdef</span><span class="p">:</span> <span class="err">‘</span><span class="n">class</span><span class="err">’</span> <span class="n">NAME</span> <span class="p">[</span><span class="err">’</span><span class="p">(</span><span class="err">‘</span> <span class="p">[</span><span class="n">testlist</span><span class="p">]</span> <span class="err">‘</span><span class="p">)</span><span class="err">’</span><span class="p">]</span> <span class="err">‘</span><span class="p">:</span><span class="err">’</span> <span class="n">suite</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">arglist</span><span class="p">:</span> <span class="p">(</span><span class="n">argument</span> <span class="err">‘</span><span class="p">,</span><span class="err">’</span><span class="p">)</span><span class="o">*</span> <span class="p">(</span><span class="n">argument</span> <span class="p">[</span><span class="err">’</span><span class="p">,</span><span class="err">’</span><span class="p">]</span>
</span><span class='line'>                         <span class="o">|</span><span class="err">’</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="err">’</span> <span class="n">test</span> <span class="p">(</span><span class="err">‘</span><span class="p">,</span><span class="err">’</span> <span class="n">argument</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span> <span class="p">[</span><span class="err">’</span><span class="p">,</span><span class="err">’</span> <span class="err">‘</span><span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="err">’</span> <span class="n">test</span><span class="p">]</span>
</span><span class='line'>                         <span class="o">|</span><span class="err">’</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span><span class="err">’</span> <span class="n">test</span><span class="p">)</span>
</span><span class='line'><span class="c"># The reason that keywords are test nodes instead of NAME is that using NAME</span>
</span><span class='line'><span class="c"># results in an ambiguity. ast.c makes sure it’s a NAME.</span>
</span><span class='line'><span class="n">argument</span><span class="p">:</span> <span class="n">test</span> <span class="p">[</span><span class="n">comp_for</span><span class="p">]</span> <span class="o">|</span> <span class="n">test</span> <span class="err">‘</span><span class="o">=</span><span class="err">’</span> <span class="n">test</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">list_iter</span><span class="p">:</span> <span class="n">list_for</span> <span class="o">|</span> <span class="n">list_if</span>
</span><span class='line'><span class="n">list_for</span><span class="p">:</span> <span class="err">‘</span><span class="k">for</span><span class="err">’</span> <span class="n">exprlist</span> <span class="err">‘</span><span class="ow">in</span><span class="err">’</span> <span class="n">testlist_safe</span> <span class="p">[</span><span class="n">list_iter</span><span class="p">]</span>
</span><span class='line'><span class="n">list_if</span><span class="p">:</span> <span class="err">‘</span><span class="k">if</span><span class="err">’</span> <span class="n">old_test</span> <span class="p">[</span><span class="n">list_iter</span><span class="p">]</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">comp_iter</span><span class="p">:</span> <span class="n">comp_for</span> <span class="o">|</span> <span class="n">comp_if</span>
</span><span class='line'><span class="n">comp_for</span><span class="p">:</span> <span class="err">‘</span><span class="k">for</span><span class="err">’</span> <span class="n">exprlist</span> <span class="err">‘</span><span class="ow">in</span><span class="err">’</span> <span class="n">or_test</span> <span class="p">[</span><span class="n">comp_iter</span><span class="p">]</span>
</span><span class='line'><span class="n">comp_if</span><span class="p">:</span> <span class="err">‘</span><span class="k">if</span><span class="err">’</span> <span class="n">old_test</span> <span class="p">[</span><span class="n">comp_iter</span><span class="p">]</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">testlist1</span><span class="p">:</span> <span class="n">test</span> <span class="p">(</span><span class="err">‘</span><span class="p">,</span><span class="err">’</span> <span class="n">test</span><span class="p">)</span><span class="o">*&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;not-used-in-grammar-but-may-appear-in-node-passed-from-parser-to-compiler&quot;</span><span class="o">&gt;</span><span class="ow">not</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">grammar</span><span class="p">,</span> <span class="n">but</span> <span class="n">may</span> <span class="n">appear</span> <span class="ow">in</span> <span class="err">“</span><span class="n">node</span><span class="err">”</span> <span class="n">passed</span> <span class="kn">from</span> <span class="nn">Parser</span> <span class="nn">to</span> <span class="nn">Compiler</span><span class="err">&lt;/</span><span class="nn">h1</span><span class="err">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">encoding_decl</span><span class="p">:</span> <span class="n">NAME</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">yield_expr</span><span class="p">:</span> <span class="err">‘</span><span class="k">yield</span><span class="err">’</span> <span class="p">[</span><span class="n">testlist</span><span class="p">]</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

]]></content>
  </entry>
  
</feed>
