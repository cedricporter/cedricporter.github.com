<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Tag: Web | EverET.org]]></title>
  <link href="http://everet.org/tag/web/atom.xml" rel="self"/>
  <link href="http://everet.org/"/>
  <updated>2012-12-27T02:45:08+08:00</updated>
  <id>http://everet.org/</id>
  <author>
    <name><![CDATA[Stupid ET]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[猜想祖国的伟大的围墙的原理]]></title>
    <link href="http://everet.org/2012/05/gfw.html"/>
    <updated>2012-05-06T03:18:34+08:00</updated>
    <id>http://everet.org/2012/05/gfw</id>
    <content type="html"><![CDATA[<h2 id="section">防民之口，甚于防川。</h2>

<p>引用自百度百科的对于“防民之口，甚于防川”的启示：</p>

<blockquote>
  <p>中国历史上有很多统治者荒淫无道，但他们又怕人民议论，就采取了压制社会言论的措施，以为可以高枕无忧、平安无事。实际上这是最愚蠢的作法，它不仅使下情无法上达，错误的政策得不到纠正，加剧社会矛盾。更可怕的在于虽然民众口上不说，但心里却充满了仇恨，只要社会矛盾到达临界点，大规模的暴乱必然爆发，给社会生产力造成极大破坏。正可谓“防民之口，甚于防川。”中国人是世界上最能忍受暴政的民族，但也是爆发起义最多的国家。</p>
</blockquote>

<p>无逻辑的舆论的控制，究竟会引发什么后果呢？或许多年后答案便自己浮现。</p>

<p>暂且不谈论我们伟大的围墙的对于人民生活的影响，我们来看看它的技术方面的实现。<!-- more --></p>

<h2 id="section-1">景德镇的国域网</h2>

<p>景德镇的国域网对外的出口线路不多，只要在这些出口处架设好强大的过滤器，便可以保障国民思想安全性。这样过滤不会太麻烦，因为出口就这么几个，派兵守住就好。</p>

<p>在网络课上，刘孜文老师给我们讲了一个他的经历，<a href="http://everet.org/2012/05/gfw.html">我</a>大致复述一下（语文很差，希望不会扭曲原意）：</p>

<p>老师的一个同学在收到领导指示，要弄一个省级的防火墙，这样可以方便警察叔叔将一些骗子网站、黄色网站过滤掉。于是他的同学开始鸭梨巨大了，因为一个省的对外的线路有很多很多条，很难在每一条出口安上防火墙，因为线路太多了。</p>

<p>这个例子说明，一个国家级的要比一个省级的围墙容易得多，原因是关口少，不像省与省之间的线路四通八达。</p>

<p>那么我们知道了在国域网对外的出口处有各种Cisco等强大的怪兽守住，我们来探讨一下这些怪兽的机制。</p>

<h2 id="section-2">工作机制</h2>

<p>在普遍的看法，我们伟大的围墙工作机制主要包括IP黑名单、内容过滤和DNS劫持。</p>

<h3 id="ip">IP黑名单</h3>

<p>怪兽手里肯定把握着一份黑名单，上面写着Facebook、twitter、youtube等的ip地址，一旦发现镇民发往黑名单中地址的请求数据包，就直接无情地丢弃，当镇民等到花儿都谢了都没有收到服务器发回的包，他便生了一种叫超时的病而放弃了。</p>

<p>温总理曾说过：中国财富再多，除以13亿人，就少得可怜了；中国问题再小，乘以13亿人，也就很大了。</p>

<p>一个秒钟一个请求*13亿，就是一个很大的请求了。请问怪兽如何可以高速地在IP黑名单中查询这个ip在不在呢？</p>

<p>对于ipv4，每个ip地址32位，可以看作32位无符号整形。也就是2^32个ip地址。黑名单应该也不小，怎么也有几千几万几十万吧。那么怪兽怎么处理呢？</p>

<ul>
  <li>
    <p>怪兽如果很2B的话，它会拿着收到数据包的ip一个一个地和黑名单中的ip比较，如果在黑名单里面就将其丢弃，不在那就放过它。这样怪兽花的时间是O(n)，n为黑名单的大小。</p>
  </li>
  <li>
    <p>怪兽智商稍微高一点的话，它会将黑名单中的排好序，然后使用伟大的二分查找法术，就可以花O(log(n))的时间判断那个ip在不在黑名单里面。</p>
  </li>
  <li>
    <p>怪事如果智商不错的话，它会构建一个4G个单位的哈希表blacklist，然后直接将ip作为索引，初始化哈希表blacklist，blacklist[ip] = 1, if ip in ip_blacklist，这样，在一个请求过来的时候，怪兽只需要花费O(1)的时间就可以知道ip在不在黑名单里面。</p>
  </li>
</ul>

<p>对于一个4G个单位的ip黑名单hash table，我们可以一个bit来表示一个ip是不是属于特殊对待ip。于是我们的ip hash table大小为：</p>

<blockquote>
  <p>4G bit = 4 / 8 G Byte = 0.5 GB = 512 MB</p>
</blockquote>

<p>怪兽只需要有512MB的空闲内存就可以构建这么一个hash表，然后无论是多线程模式的还是多进程模式的设计都可以共享这块放hash表的内存，中途如果有新增或者取消话都可以直接更新hash表，当然可能会因为有缓存而导致不一致，但是在这个大环境下也不一那么较真，让正确率100%，所以连锁都可以不用加，这样怪兽的负担会轻很多。不过bitmap在ipv6下是不那么实际的，因为使用内存会非常巨大，2^128bit，会消耗39614081257132168796771975168GB的内存来放bitmap。可能这也是怪兽没有对ipv6下手的原因。</p>

<p>我们来看一段代码，描述了高效判断是否在黑名单的方法。</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>cpp  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span> <span class="n">id</span><span class="o">=</span><span class="s">&quot;include-stringh&quot;</span><span class="o">&gt;</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">string</span><span class="p">.</span><span class="n">h</span> <span class="o">/&gt;&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">stdlib</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &amp;lt;sys/socket.h&amp;gt;</span>
</span><span class='line'><span class="cp">#include &amp;lt;sys/types.h&amp;gt;</span>
</span><span class='line'><span class="cp">#include &amp;lt;arpa/inet.h&amp;gt;&lt;/stdio.h&gt;&lt;/stdlib.h&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span> <span class="n">id</span><span class="o">=</span><span class="s">&quot;define-bitsperword-32&quot;</span><span class="o">&gt;</span><span class="n">define</span> <span class="n">BITSPERWORD</span> <span class="mi">32</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="err">#</span><span class="n">define</span> <span class="n">SHIFT</span> <span class="mi">5</span>			<span class="c1">// 2 ^ 5 = 32</span>
</span><span class='line'><span class="cp">#define MASK 0x1F		</span><span class="c1">// 0x1F = (11111)b</span>
</span><span class='line'><span class="cp">#define SET(a, i) ((a)[(i)»SHIFT] |= (1«((i) &amp;amp; MASK)))</span>
</span><span class='line'><span class="cp">#define CLR(a, i) ((a)[(i)»SHIFT] &amp;amp;= ~(1«((i) &amp;amp; MASK)))</span>
</span><span class='line'><span class="cp">#define TEST(a, i) ((a)[(i)»SHIFT] &amp;amp; (1«((i) &amp;amp; MASK)))&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="kr">inline</span> <span class="kt">void</span> <span class="n">test_block</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="n">blacklist</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">ip</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>     <span class="k">if</span> <span class="p">(</span><span class="n">TEST</span><span class="p">(</span><span class="n">blacklist</span><span class="p">,</span> <span class="n">inet_addr</span><span class="p">(</span><span class="n">ip</span><span class="p">)))</span>
</span><span class='line'>	  <span class="n">printf</span><span class="p">(</span><span class="err">“</span><span class="o">%</span><span class="n">s</span> <span class="n">is</span> <span class="n">blocked</span><span class="p">.</span><span class="err">\</span><span class="n">n</span><span class="err">”</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
</span><span class='line'>     <span class="k">else</span>
</span><span class='line'>	  <span class="n">printf</span><span class="p">(</span><span class="err">“</span><span class="o">%</span><span class="n">s</span> <span class="n">is</span> <span class="n">pass</span><span class="p">.</span><span class="err">\</span><span class="n">n</span><span class="err">”</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>     <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">4294967295</span><span class="p">;</span>
</span><span class='line'>     <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">SIZE</span> <span class="o">=</span> <span class="n">N</span> <span class="o">/</span> <span class="n">BITSPERWORD</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>     <span class="kt">int</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">blacklist</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span> <span class="n">memset</span><span class="p">(</span><span class="n">blacklist</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
</span><span class='line'> <span class="n">SET</span><span class="p">(</span><span class="n">blacklist</span><span class="p">,</span> <span class="n">inet_addr</span><span class="p">(</span><span class="s">&quot;243.185.187.39&quot;</span><span class="p">));</span>
</span><span class='line'> <span class="n">SET</span><span class="p">(</span><span class="n">blacklist</span><span class="p">,</span> <span class="n">inet_addr</span><span class="p">(</span><span class="s">&quot;8.8.4.4&quot;</span><span class="p">));</span>
</span><span class='line'> <span class="n">SET</span><span class="p">(</span><span class="n">blacklist</span><span class="p">,</span> <span class="n">inet_addr</span><span class="p">(</span><span class="s">&quot;202.84.125.66&quot;</span><span class="p">));</span>
</span><span class='line'> <span class="n">SET</span><span class="p">(</span><span class="n">blacklist</span><span class="p">,</span> <span class="n">inet_addr</span><span class="p">(</span><span class="s">&quot;222.221.31.55&quot;</span><span class="p">));</span>
</span><span class='line'> <span class="n">SET</span><span class="p">(</span><span class="n">blacklist</span><span class="p">,</span> <span class="n">inet_addr</span><span class="p">(</span><span class="s">&quot;183.182.44.111&quot;</span><span class="p">));</span>
</span><span class='line'> <span class="n">SET</span><span class="p">(</span><span class="n">blacklist</span><span class="p">,</span> <span class="n">inet_addr</span><span class="p">(</span><span class="s">&quot;255.255.255.156&quot;</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'> <span class="n">test_block</span><span class="p">(</span><span class="n">blacklist</span><span class="p">,</span> <span class="s">&quot;8.8.4.4&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="n">test_block</span><span class="p">(</span><span class="n">blacklist</span><span class="p">,</span> <span class="s">&quot;222.222.222.222&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="n">test_block</span><span class="p">(</span><span class="n">blacklist</span><span class="p">,</span> <span class="s">&quot;202.84.125.66&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="n">test_block</span><span class="p">(</span><span class="n">blacklist</span><span class="p">,</span> <span class="s">&quot;88.54.32.156&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="n">test_block</span><span class="p">(</span><span class="n">blacklist</span><span class="p">,</span> <span class="s">&quot;255.255.255.156&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'> <span class="n">free</span><span class="p">(</span><span class="n">blacklist</span><span class="p">);</span>
</span><span class='line'> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>当然可能还有更好的方法，请赐教～</p>

<h2 id="section-3">内容过滤</h2>

<p>曾经在一个人博客看到程序员的工作环境怎样为好，里面有一句让我影响无比深刻“<a href="http://timyang.net/misc/work-environment-productivity/">访问Google的服务没有障碍</a>”。这个真滴非常重要呀，虽然现在Google的https可以用了，不过好慢好慢，受不了啊。</p>

<p>像我们如果在Google搜索某些关键词后，我们从Google打开了某些网址后，不仅那些网站访问不了，而且Google就会被怪兽吃了。</p>

<p>Google不作恶啊，为什么要对Google那么狠……</p>

<p>例如我们在Google中搜索</p>

<p><a href="http://everet.org/wp-content/uploads/2012/05/fq.png"><img src="http://everet.org/wp-content/uploads/2012/05/fq.png" alt="" /></a></p>

<p>然后就会发现Google被吃了。</p>

<p>怪兽做了什么？</p>

<p>怪兽首先伪造Google的ip发了许多RST包给镇民的浏览器，然后怪兽也可能伪造镇民的ip发了很多RST给Google，挑拨离间，最后镇民和Google在经过一段努力后发现还是无法沟通就不再继续通信了。</p>

<p><a href="http://everet.org/wp-content/uploads/2012/05/gfw.png"><img src="http://everet.org/wp-content/uploads/2012/05/gfw.png" alt="" /></a></p>

<p>怪兽应该对http包进行了扫描，看看有没有什么敏感词，有的话就伪装成对方开始卑鄙地发送RST，来挑拨离间最终实现断开连接。</p>

<h2 id="dns">DNS劫持</h2>

<p>有一部分怪兽应该会专门负责污染国内DNS服务器的缓存，导致我们解析到了错误的ip。有一部分怪兽会篡改国外DNS发回的响应，导致镇民获得了错误的ip。</p>

<h2 id="section-4">结言</h2>

<p>防民之口，甚于防川。过度地压制景德镇的镇民似乎并不太好，希望未来的祖国会更加开放、更加发达。</p>

<p>天朝威武～</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[“反盗链”与反“反盗链”]]></title>
    <link href="http://everet.org/2012/04/anti-hotlink.html"/>
    <updated>2012-04-11T10:19:17+08:00</updated>
    <id>http://everet.org/2012/04/anti-hotlink</id>
    <content type="html"><![CDATA[<p>现在很多大网站都有了图片反盗链，于是有时候在某些论坛或者博客就会遇到些“此图片仅限于…用户之间交流与沟通”的图片，这真是无法理喻。</p>

<h2 id="section">反盗链</h2>

<p>引用一段话：来自<a href="http://www.ningoo.net/html/2007/get_away_from_photo_defense.html">http://www.ningoo.net/html/2007/get_away_from_photo_defense.html</a></p>

<blockquote>
  <p>这里忍不住再次提起这茬，是在<a href="http://9.douban.com/">豆瓣九点</a>看blog的时候，时不时冒出一副“此图片仅限于…用户之间交流与沟通”的图片出来，一个字，烦。不让看你干脆将所有的img直接过滤掉不显示就好了，还TMD放这么恶心的一个东西来刺激我的眼睛，要知道我眼睛本来就不太灵光，还好心脏不错，不然搞不好弄出人命官司。Blog和网页有啥区别？我想区别就在于我可以通过rss聚合阅读而不必要跑到blogger的网站上去吧。要是你输出的东西这不能看，那仅限于，那还搞个屁的rss。</p>
</blockquote>

<p>图片防盗链，请离blog远点。呼吁所有的blogger，离图片防盗链的XX网站远点，不然，你们的内容再好，也只能敬而远之了。</p>

<p>这个我深有同感。</p>

<!-- more -->

<p>基本大部分网站的反盗链都是通过HTTP Headers里面的Referer属性来判断是否盗链。</p>

<p>如果Referer来源不是他们的网站，他们会直接返回一个意思类似“你盗我链”的图片，或者直接404。</p>

<p>有的网站还算有的人性，如果Referer为空的话，他们会放过这个请求。</p>

<p>像在Apache下，我们可以轻松用rewrite模块来实现图片的反盗链。</p>

<blockquote>
  <p>RewriteEngine on
RewriteCond %{HTTP_REFERER} !^$
RewriteCond %{HTTP_REFERER} !^[http://(www.)?EverET.org(/)?.<em>](http://(www.)?EverET.org(/)?.</em>)$     [NC]
RewriteCond %{HTTP_REFERER} !^[http://(www.)?EverET.org(/)?.<em>](http://(www.)?EverET.org(/)?.</em>)$     [NC]
RewriteRule .*.(gif|jpg|jpeg|bmp|png)$ <a href="http://www.EverET.org/nohotlink.xjpg">http://www.EverET.org/nohotlink.xjpg</a> [R,NC]</p>
</blockquote>

<p>也就是看看HTTP Headers中Referer是不是自己的网站，不是就返回一个nohotlinks.xjpg的图片。</p>

<h2 id="section-1">反“反盗链”</h2>

<p>下面我们来看看百度的图片。</p>

<p>页面源代码如下：</p>

<p><a href="http://everet.org/wp-content/uploads/2012/04/image2.png"><img src="http://everet.org/wp-content/uploads/2012/04/image_thumb2.png" alt="image" /></a></p>

<p>打开页面后会发现img标签的图片是一张“仅供XX交流的图片”， 而在iframe里面的img可以正确显示：</p>

<p><a href="http://everet.org/wp-content/uploads/2012/04/image3.png"><img src="http://everet.org/wp-content/uploads/2012/04/image_thumb3.png" alt="image" /></a></p>

<p>对于上面那张“该图片仅供XX用户交流使用”的HTTP请求的Headers如下图：</p>

<p><a href="http://everet.org/wp-content/uploads/2012/04/image4.png"><img src="http://everet.org/wp-content/uploads/2012/04/image_thumb4.png" alt="image" /></a></p>

<p>它直接返回了一个“仅供XX交流的”</p>

<p>对于下图显示出来的周总理的照片，它的请求如下，很明显可以看到少了Referer这个属性。<a href="http://everet.org/wp-content/uploads/2012/04/image5.png"><img src="http://everet.org/wp-content/uploads/2012/04/image_thumb5.png" alt="image" /></a></p>

<h3 id="section-2">进化</h3>

<p>现在，我们可以通过javascript来让图片显得更美观，我们将iframe的大小设置到和图片大小一致，然后去掉边框，于是就看不出图片是在一个iframe里面了。于是我们就可以看到我们敬爱的周总理而不是“仅供XX用户交流使用”。</p>

<p><a href="http://everet.org/wp-content/uploads/2012/04/image6.png"><img src="http://everet.org/wp-content/uploads/2012/04/image_thumb6.png" alt="image" /></a></p>

<p>页面源码：</p>

<p><a href="http://everet.org/wp-content/uploads/2012/04/image7.png"><img src="http://everet.org/wp-content/uploads/2012/04/image_thumb7.png" alt="image" /></a></p>

<p>hotlink_under_id这个函数可以将在某个id的标签下的所有的图片自动变成iframe，实现突破允许referer为空的反盗链。</p>

<p>javascript代码：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>javascript  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="nb">window</span><span class="p">.</span><span class="nx">img_array</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="c1">// create a img frame</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">create_img_iframe</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">frameid</span> <span class="o">=</span> <span class="err">‘</span><span class="nx">frameimg</span><span class="err">’</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">();</span>
</span><span class='line'>    <span class="nb">window</span><span class="p">.</span><span class="nx">img</span> <span class="o">=</span> <span class="err">‘</span><span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span><span class="nx">img</span> <span class="nx">id</span><span class="o">=</span><span class="err">”</span><span class="nx">img</span><span class="err">”</span> <span class="nx">src</span><span class="o">=</span><span class="s1">&#39;‘+url+’?’+Math.random()+’&#39;</span> <span class="o">/&amp;</span><span class="nx">gt</span><span class="p">;</span><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span><span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">parent</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="err">\</span><span class="s1">&#39;&#39;</span><span class="o">+</span><span class="nx">frameid</span><span class="o">+</span><span class="s1">&#39;\&#39;).height = document.getElementById(\&#39;img\&#39;).height+\&#39;px\&#39;; }&amp;lt;&#39;</span><span class="o">+</span><span class="s1">&#39;/script&amp;gt;&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="nb">window</span><span class="p">.</span><span class="nx">img_array</span><span class="p">[</span><span class="nx">count</span><span class="p">]</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">img</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">ifr</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;iframe&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">ifr</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s2">&quot;javascript:parent.img_array[&quot;</span> <span class="o">+</span> <span class="nx">count</span> <span class="o">+</span> <span class="s2">&quot;];&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">ifr</span><span class="p">.</span><span class="nx">frameBorder</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">ifr</span><span class="p">.</span><span class="nx">scrolling</span><span class="o">=</span><span class="s2">&quot;no&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">ifr</span><span class="p">.</span><span class="nx">width</span><span class="o">=</span><span class="s2">&quot;100%&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">ifr</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">frameid</span><span class="p">;</span><span class="o">&lt;</span><span class="err">/script&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="nx">count</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'><span class="k">return</span> <span class="nx">ifr</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="c1">// hotlink, param id is the img parent id</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">hotlink_under_id</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">imgs</span> <span class="o">=</span> <span class="nx">div</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="err">‘</span><span class="nx">img</span><span class="err">’</span><span class="p">);</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="k">while</span> <span class="p">(</span><span class="nx">imgs</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;</span><span class="nx">gt</span><span class="p">;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nx">src</span> <span class="o">=</span> <span class="nx">imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">src</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">ifr</span> <span class="o">=</span> <span class="nx">create_img_iframe</span><span class="p">(</span><span class="nx">src</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">replaceChild</span><span class="p">(</span><span class="nx">ifr</span><span class="p">,</span> <span class="nx">imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'><span class="p">}</span> <span class="p">}</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>我们来看另一个网站的反盗链。它同样也是</p>

<p><a href="http://everet.org/wp-content/uploads/2012/04/image.png"><img src="http://everet.org/wp-content/uploads/2012/04/image_thumb.png" alt="image" /></a></p>

<p>我们可以在<a href="http://everet.org/2012/02/the-http-status-code.html">http://everet.org/2012/02/the-http-status-code.html</a>看到HTTP状态码是302Found：类似于301，但新的URL应该被视为临时性的替代，而不是永久性的。</p>

<p>而<strong>301</strong>是Moved Permanently。客户请求的文档在其他地方，新的URL在Location头中给出，浏览器应该自动地访问新的URL。</p>

<p>看报文是被Apache重定向了。</p>

<p><a href="http://everet.org/wp-content/uploads/2012/04/image1.png"><img src="http://everet.org/wp-content/uploads/2012/04/image_thumb1.png" alt="image" /></a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[我的FTP Server——ftp.py]]></title>
    <link href="http://everet.org/2012/03/ftp-server.html"/>
    <updated>2012-03-24T10:35:06+08:00</updated>
    <id>http://everet.org/2012/03/ftp-server</id>
    <content type="html"><![CDATA[<p>在上文中，我们简要地学习了下FTP协议，链接 <a href="http://everet.org/2012/03/ftp-protocol.html">http://everet.org/2012/03/ftp-protocol.html</a>。</p>

<p>有兴趣的同学们可以去围观下。</p>

<p>因为最近偶看了下FTP协议，所以决定写个FTP Server玩玩。毕竟一直写的都是应用程序，于是乎想写下服务器端的程序。</p>

<p>结果就有了ftp.py，名字灵感来源于web.py。</p>

<h2 id="ftppy">ftp.py</h2>

<p>ftp.py由Python 2.x实现。目前有部署到我的服务器上。支持Windows、Unix和类Unix系统。支持多线程模式和多进程模式，不过在Windows上仅支持多线程模式。支持虚拟用户。</p>

<p>其中多进程模式支持以其他用户身份运行，加强了安全性。</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>bash  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>usage: ftp.py <span class="o">[</span>-d<span class="o">]</span> <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>-p port<span class="o">]</span> <span class="o">[</span>-o<span class="o">]</span> <span class="o">[</span>-t<span class="o">]</span>
</span><span class='line'>    -d become a daemon
</span><span class='line'>    -h <span class="nb">help</span>
</span><span class='line'>    -p listen port
</span><span class='line'>    -o output log to stdout, by default, it outputs to a log file.
</span><span class='line'>    -t thread mode, fork model by default
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>其中用户设置写在ftp.py.config中，如果文件不存在则默认使用anonymous账户。</p>

<p>用户设置文件ftp.py.config格式如下：</p>

<blockquote>
  <p>account_info = {
‘et’:{‘pass’:’123456789’, ‘home_dir’:’/root/’},
‘lst’:{‘pass’:’987654321’, ‘home_dir’:’/tmp/’}
}</p>
</blockquote>

<p>也就是账户名+密码+家目录路径。</p>

<h2 id="ftppyconfig">ftp.py.config</h2>

<p>我们还可以在ftp.py的同级目录中通过ftp.py.config设置我们的FTP Server。</p>

<p>最大用户连接数 limit_connection_number </p>

<p>``超时时间（单位：秒）timeout</p>

<p>``默认家目录：default_home_dir</p>

<p>日志文件：logfile</p>

<p>运行的用户身份：runas_user</p>

<h3 id="section">默认值为：</h3>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>python  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">limit_connection_number</span> <span class="o">=</span> <span class="mi">5</span>     <span class="c"># max client number</span>
</span><span class='line'><span class="n">timeout</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">3</span>                <span class="c"># timeout in second</span>
</span><span class='line'><span class="n">default_home_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="err">‘</span>\<span class="err">’</span><span class="p">,</span> <span class="err">‘</span><span class="o">/</span><span class="err">’</span><span class="p">)</span>
</span><span class='line'><span class="n">logfile</span> <span class="o">=</span> <span class="err">‘</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">ftp</span><span class="o">.</span><span class="n">py</span><span class="o">.</span><span class="n">log</span><span class="err">’</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="err">‘</span><span class="n">posix</span><span class="err">’</span> <span class="k">else</span> <span class="n">default_home_dir</span> <span class="o">+</span> <span class="err">‘</span><span class="n">ftp</span><span class="o">.</span><span class="n">py</span><span class="o">.</span><span class="n">log</span><span class="err">’</span>
</span><span class='line'><span class="n">runas_user</span> <span class="o">=</span> <span class="err">‘</span><span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="err">’</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3 id="more---">源码如下：<!-- more --></h3>

<p>最新的源码请见Git: <a href="https://github.com/cedricporter/ftp.py">https://github.com/cedricporter/ftp.py</a></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>python  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
<span class='line-number'>375</span>
<span class='line-number'>376</span>
<span class='line-number'>377</span>
<span class='line-number'>378</span>
<span class='line-number'>379</span>
<span class='line-number'>380</span>
<span class='line-number'>381</span>
<span class='line-number'>382</span>
<span class='line-number'>383</span>
<span class='line-number'>384</span>
<span class='line-number'>385</span>
<span class='line-number'>386</span>
<span class='line-number'>387</span>
<span class='line-number'>388</span>
<span class='line-number'>389</span>
<span class='line-number'>390</span>
<span class='line-number'>391</span>
<span class='line-number'>392</span>
<span class='line-number'>393</span>
<span class='line-number'>394</span>
<span class='line-number'>395</span>
<span class='line-number'>396</span>
<span class='line-number'>397</span>
<span class='line-number'>398</span>
<span class='line-number'>399</span>
<span class='line-number'>400</span>
<span class='line-number'>401</span>
<span class='line-number'>402</span>
<span class='line-number'>403</span>
<span class='line-number'>404</span>
<span class='line-number'>405</span>
<span class='line-number'>406</span>
<span class='line-number'>407</span>
<span class='line-number'>408</span>
<span class='line-number'>409</span>
<span class='line-number'>410</span>
<span class='line-number'>411</span>
<span class='line-number'>412</span>
<span class='line-number'>413</span>
<span class='line-number'>414</span>
<span class='line-number'>415</span>
<span class='line-number'>416</span>
<span class='line-number'>417</span>
<span class='line-number'>418</span>
<span class='line-number'>419</span>
<span class='line-number'>420</span>
<span class='line-number'>421</span>
<span class='line-number'>422</span>
<span class='line-number'>423</span>
<span class='line-number'>424</span>
<span class='line-number'>425</span>
<span class='line-number'>426</span>
<span class='line-number'>427</span>
<span class='line-number'>428</span>
<span class='line-number'>429</span>
<span class='line-number'>430</span>
<span class='line-number'>431</span>
<span class='line-number'>432</span>
<span class='line-number'>433</span>
<span class='line-number'>434</span>
<span class='line-number'>435</span>
<span class='line-number'>436</span>
<span class='line-number'>437</span>
<span class='line-number'>438</span>
<span class='line-number'>439</span>
<span class='line-number'>440</span>
<span class='line-number'>441</span>
<span class='line-number'>442</span>
<span class='line-number'>443</span>
<span class='line-number'>444</span>
<span class='line-number'>445</span>
<span class='line-number'>446</span>
<span class='line-number'>447</span>
<span class='line-number'>448</span>
<span class='line-number'>449</span>
<span class='line-number'>450</span>
<span class='line-number'>451</span>
<span class='line-number'>452</span>
<span class='line-number'>453</span>
<span class='line-number'>454</span>
<span class='line-number'>455</span>
<span class='line-number'>456</span>
<span class='line-number'>457</span>
<span class='line-number'>458</span>
<span class='line-number'>459</span>
<span class='line-number'>460</span>
<span class='line-number'>461</span>
<span class='line-number'>462</span>
<span class='line-number'>463</span>
<span class='line-number'>464</span>
<span class='line-number'>465</span>
<span class='line-number'>466</span>
<span class='line-number'>467</span>
<span class='line-number'>468</span>
<span class='line-number'>469</span>
<span class='line-number'>470</span>
<span class='line-number'>471</span>
<span class='line-number'>472</span>
<span class='line-number'>473</span>
<span class='line-number'>474</span>
<span class='line-number'>475</span>
<span class='line-number'>476</span>
<span class='line-number'>477</span>
<span class='line-number'>478</span>
<span class='line-number'>479</span>
<span class='line-number'>480</span>
<span class='line-number'>481</span>
<span class='line-number'>482</span>
<span class='line-number'>483</span>
<span class='line-number'>484</span>
<span class='line-number'>485</span>
<span class='line-number'>486</span>
<span class='line-number'>487</span>
<span class='line-number'>488</span>
<span class='line-number'>489</span>
<span class='line-number'>490</span>
<span class='line-number'>491</span>
<span class='line-number'>492</span>
<span class='line-number'>493</span>
<span class='line-number'>494</span>
<span class='line-number'>495</span>
<span class='line-number'>496</span>
<span class='line-number'>497</span>
<span class='line-number'>498</span>
<span class='line-number'>499</span>
<span class='line-number'>500</span>
<span class='line-number'>501</span>
<span class='line-number'>502</span>
<span class='line-number'>503</span>
<span class='line-number'>504</span>
<span class='line-number'>505</span>
<span class='line-number'>506</span>
<span class='line-number'>507</span>
<span class='line-number'>508</span>
<span class='line-number'>509</span>
<span class='line-number'>510</span>
<span class='line-number'>511</span>
<span class='line-number'>512</span>
<span class='line-number'>513</span>
<span class='line-number'>514</span>
<span class='line-number'>515</span>
<span class='line-number'>516</span>
<span class='line-number'>517</span>
<span class='line-number'>518</span>
<span class='line-number'>519</span>
<span class='line-number'>520</span>
<span class='line-number'>521</span>
<span class='line-number'>522</span>
<span class='line-number'>523</span>
<span class='line-number'>524</span>
<span class='line-number'>525</span>
<span class='line-number'>526</span>
<span class='line-number'>527</span>
<span class='line-number'>528</span>
<span class='line-number'>529</span>
<span class='line-number'>530</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;usrbinenv-python&quot;</span><span class="o">&gt;</span><span class="err">!</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">env</span> <span class="n">python</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c"># author:  Hua Liang [ Stupid ET ]</span>
</span><span class='line'><span class="c"># email:   et@everet.org</span>
</span><span class='line'><span class="c"># website: http://EverET.org</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">socket</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">stat</span><span class="o">,</span> <span class="nn">threading</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">struct</span><span class="o">,</span> <span class="nn">getopt</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">signal</span><span class="o">,</span> <span class="nn">select</span><span class="o">,</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">logging.handlers</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="err">‘</span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="err">’</span>
</span><span class='line'><span class="n">port</span> <span class="o">=</span> <span class="mi">21</span>
</span><span class='line'><span class="n">limit_connection_number</span> <span class="o">=</span> <span class="mi">5</span>     <span class="c"># max client number</span>
</span><span class='line'><span class="n">timeout</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">3</span>                <span class="c"># timeout in second</span>
</span><span class='line'><span class="n">default_home_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="err">‘</span>\<span class="err">’</span><span class="p">,</span> <span class="err">‘</span><span class="o">/</span><span class="err">’</span><span class="p">)</span>
</span><span class='line'><span class="n">logfile</span> <span class="o">=</span> <span class="err">‘</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">ftp</span><span class="o">.</span><span class="n">py</span><span class="o">.</span><span class="n">log</span><span class="err">’</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="err">‘</span><span class="n">posix</span><span class="err">’</span> <span class="k">else</span> <span class="n">default_home_dir</span> <span class="o">+</span> <span class="err">‘</span><span class="n">ftp</span><span class="o">.</span><span class="n">py</span><span class="o">.</span><span class="n">log</span><span class="err">’</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">runas_user</span> <span class="o">=</span> <span class="err">‘</span><span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="err">’</span>
</span><span class='line'><span class="n">global_options</span> <span class="o">=</span> <span class="p">{</span><span class="err">‘</span><span class="n">run_mode</span><span class="err">’</span><span class="p">:</span><span class="err">’</span><span class="n">fork</span><span class="err">’</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;current-working-directory&quot;</span><span class="o">&gt;</span><span class="n">current</span> <span class="n">working</span> <span class="n">directory</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">account_info</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="err">‘</span><span class="n">anonymous</span><span class="err">’</span><span class="p">:{</span><span class="err">‘</span><span class="k">pass</span><span class="err">’</span><span class="p">:</span><span class="err">’’</span><span class="p">,</span> <span class="err">‘</span><span class="n">home_dir</span><span class="err">’</span><span class="p">:</span><span class="n">default_home_dir</span><span class="p">,</span> <span class="err">‘</span><span class="n">runas_user</span><span class="err">’</span><span class="p">:</span><span class="n">runas_user</span><span class="p">},</span>
</span><span class='line'>    <span class="p">}</span> <span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">runas</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="err">‘</span><span class="n">posix</span><span class="err">’</span><span class="p">:</span> <span class="k">return</span>
</span><span class='line'>    <span class="n">uid</span> <span class="o">=</span> <span class="n">get_uid</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
</span><span class='line'>    <span class="n">os</span><span class="o">.</span><span class="n">setgid</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
</span><span class='line'>    <span class="n">os</span><span class="o">.</span><span class="n">setuid</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">class</span> <span class="nc">FTPConnection</span><span class="p">:</span>
</span><span class='line'>    <span class="err">‘</span><span class="s">&#39;’You can add handle func by startswith handle_ prefix.</span>
</span><span class='line'>    <span class="n">When</span> <span class="n">the</span> <span class="n">connection</span> <span class="n">receives</span> <span class="n">CWD</span> <span class="n">command</span><span class="p">,</span> <span class="n">it</span><span class="err">’</span><span class="n">ll</span> <span class="n">use</span> <span class="n">handle_CWD</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">it</span><span class="o">.</span>
</span><span class='line'>    <span class="err">‘’’</span>
</span><span class='line'>    <span class="k">def</span> <span class="err">&lt;</span><span class="nf">strong</span><span class="o">&gt;</span><span class="n">init</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">remote_ip</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">fd</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="err">‘</span><span class="n">pasv</span><span class="err">’</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="err">‘</span><span class="n">utf8</span><span class="err">’</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">data_host</span> <span class="o">=</span> <span class="err">‘’</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">data_port</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">localhost</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">home_dir</span> <span class="o">=</span> <span class="n">default_home_dir</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">curr_dir</span> <span class="o">=</span> <span class="err">‘</span><span class="o">/</span><span class="err">’</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">handler</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span class='line'>            <span class="p">[(</span><span class="n">method</span><span class="p">[</span><span class="mi">7</span><span class="p">:],</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">))</span> \
</span><span class='line'>            <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> \
</span><span class='line'>            <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="err">“</span><span class="n">handle_</span><span class="err">”</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">))])</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">say_welcome</span><span class="p">()</span>
</span><span class='line'>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
</span><span class='line'>            <span class="n">success</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">arg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span><span class='line'>            <span class="n">command</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span class='line'>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;utf8&#39;</span><span class="p">]:</span>
</span><span class='line'>                <span class="n">arg</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&#39;utf8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">())</span>
</span><span class='line'>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;[ &#39;</span> <span class="o">+</span> <span class="n">command</span> <span class="o">+</span> <span class="s">&#39; ] &#39;</span> <span class="o">+</span> <span class="n">arg</span><span class="p">)</span>
</span><span class='line'>            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&quot;Failed&quot;</span><span class="p">)</span>
</span><span class='line'>                <span class="k">continue</span>
</span><span class='line'>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&quot;Command Not Found&quot;</span><span class="p">)</span>
</span><span class='line'>                <span class="k">continue</span>
</span><span class='line'>            <span class="k">try</span><span class="p">:</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="p">[</span><span class="n">command</span><span class="p">](</span><span class="n">arg</span><span class="p">)</span>
</span><span class='line'>            <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class='line'>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;in start&quot;</span><span class="p">)</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&#39;Permission denied&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">say_bye</span><span class="p">()</span>
</span><span class='line'>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class='line'>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class='line'>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;in start&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">finally</span><span class="p">:</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;FTP connnection done.&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="bp">True</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">send_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span class='line'>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;utf8&#39;</span><span class="p">]:</span>
</span><span class='line'>        <span class="n">msg</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">())</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">msg</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">fd</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">recv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&#39;&#39;&#39;returns 3 tuples, success, command, arg&#39;&#39;&#39;</span>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="n">success</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">arg</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span>
</span><span class='line'>        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fd</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
</span><span class='line'>            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span> <span class="ow">or</span> <span class="n">data</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">=</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class='line'>                <span class="n">success</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class='line'>                <span class="k">break</span>
</span><span class='line'>            <span class="n">buf</span> <span class="o">+=</span> <span class="n">data</span>
</span><span class='line'>            <span class="k">if</span> <span class="n">buf</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">:</span> <span class="k">break</span>
</span><span class='line'>        <span class="n">split</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">command</span><span class="p">,</span> <span class="n">arg</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[:</span><span class="n">split</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="n">split</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">if</span> <span class="n">split</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class='line'>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;in recv&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class='line'>        <span class="n">success</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">success</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">arg</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">say_welcome</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">220</span><span class="p">,</span> <span class="s">&quot;Welcome to EverET.org FTP&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">say_bye</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">handle_BYE</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">data_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&#39;&#39;&#39;establish data connection&#39;&#39;&#39;</span>
</span><span class='line'>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&quot;no data connection&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="bp">False</span>
</span><span class='line'>    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;pasv&#39;</span><span class="p">]:</span>
</span><span class='line'>        <span class="n">fd</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span> <span class="o">=</span> <span class="n">fd</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="k">try</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_port</span><span class="p">))</span>
</span><span class='line'>        <span class="k">except</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&quot;failed to connect&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="k">return</span> <span class="bp">False</span>
</span><span class='line'>    <span class="k">return</span> <span class="bp">True</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">close_data_fd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">parse_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span> <span class="n">path</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;/&#39;</span><span class="p">:</span> <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_dir</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">path</span>
</span><span class='line'>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;parse_path &#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
</span><span class='line'>    <span class="n">split_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">remote</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class='line'>    <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">home_dir</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">split_path</span><span class="p">:</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;..&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">item</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span> <span class="k">continue</span> <span class="c"># ignore parent directory</span>
</span><span class='line'>        <span class="n">remote</span> <span class="o">+=</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">item</span>
</span><span class='line'>        <span class="n">local</span> <span class="o">+=</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">item</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">remote</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span> <span class="n">remote</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span>
</span><span class='line'>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">split_path</span><span class="p">)</span>
</span><span class='line'>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;remote: </span><span class="si">%s</span><span class="s">  local: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="n">local</span><span class="p">))</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">remote</span><span class="p">,</span> <span class="n">local</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Command Handlers</span>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_USER</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">account_info</span><span class="p">:</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">arg</span>
</span><span class='line'>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s">&#39;anonymous&#39;</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">230</span><span class="p">,</span> <span class="s">&#39;OK&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">else</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">331</span><span class="p">,</span> <span class="s">&quot;Need password&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&quot;Invalid User&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_PASS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">arg</span> <span class="o">==</span> <span class="n">account_info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">][</span><span class="s">&#39;pass&#39;</span><span class="p">]:</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">home_dir</span> <span class="o">=</span> <span class="n">account_info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">][</span><span class="s">&#39;home_dir&#39;</span><span class="p">]</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">account_info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">]</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;runas_user&#39;</span><span class="p">):</span>
</span><span class='line'>            <span class="n">user</span> <span class="o">=</span> <span class="n">account_info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">][</span><span class="s">&#39;runas_user&#39;</span><span class="p">]</span>
</span><span class='line'>        <span class="k">else</span><span class="p">:</span>
</span><span class='line'>            <span class="n">user</span> <span class="o">=</span> <span class="s">&#39;www-data&#39;</span>
</span><span class='line'>        <span class="n">runas</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">home_dir</span><span class="p">):</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">230</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="k">return</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">530</span><span class="p">,</span> <span class="s">&quot;Password is not corrected&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_QUIT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">handle_BYE</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_BYE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_CDUP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">handle_CWD</span><span class="p">(</span><span class="s">&#39;..&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_XPWD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">handle_PWD</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_PWD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="n">remote</span><span class="p">,</span> <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_dir</span><span class="p">)</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">257</span><span class="p">,</span> <span class="s">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">remote</span> <span class="o">+</span> <span class="s">&#39;&quot;&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_CWD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="n">remote</span><span class="p">,</span> <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_path</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">curr_dir</span> <span class="o">=</span> <span class="n">remote</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class='line'>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;in cwd&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&quot;Change directory failed!&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_SIZE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="n">remote</span><span class="p">,</span> <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_dir</span><span class="p">)</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">231</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">local</span><span class="p">)))</span>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_SYST</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">215</span><span class="p">,</span> <span class="s">&quot;UNIX&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_STOR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="n">remote</span><span class="p">,</span> <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_path</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_connect</span><span class="p">():</span> <span class="k">return</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">125</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">8192</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">break</span>
</span><span class='line'>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">close_data_fd</span><span class="p">()</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">226</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_RETR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="n">remote</span><span class="p">,</span> <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_path</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_connect</span><span class="p">():</span> <span class="k">return</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">125</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8192</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">break</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">close_data_fd</span><span class="p">()</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">226</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_TYPE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">220</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_RNFR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="n">remote</span><span class="p">,</span> <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_path</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">rename_tmp_path</span> <span class="o">=</span> <span class="n">local</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">350</span><span class="p">,</span> <span class="s">&#39;rename from &#39;</span> <span class="o">+</span> <span class="n">remote</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_RNTO</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="n">remote</span><span class="p">,</span> <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_path</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class='line'>    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rename_tmp_path</span><span class="p">,</span> <span class="n">local</span><span class="p">)</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="s">&#39;rename to &#39;</span> <span class="o">+</span> <span class="n">remote</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_NLST</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_connect</span><span class="p">():</span> <span class="k">return</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">125</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">remote</span><span class="p">,</span> <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_dir</span><span class="p">)</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">local</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">226</span><span class="p">,</span> <span class="s">&quot;Limit&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">close_data_fd</span><span class="p">()</span>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_XMKD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">handle_MKD</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_MKD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="n">remote</span><span class="p">,</span> <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_path</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&quot;Folder is already existed&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span>
</span><span class='line'>    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">257</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_XRMD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">handle_RMD</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_RMD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="n">remote</span><span class="p">,</span> <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_path</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&quot;Folder is not existed&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span>
</span><span class='line'>    <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_LIST</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_connect</span><span class="p">():</span> <span class="k">return</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">125</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">template</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s%s%s</span><span class="s">------- </span><span class="si">%04u</span><span class="s"> </span><span class="si">%8s</span><span class="s"> </span><span class="si">%8s</span><span class="s"> </span><span class="si">%8lu</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="se">\r\n</span><span class="s">&quot;</span>
</span><span class='line'>    <span class="n">remote</span><span class="p">,</span> <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_dir</span><span class="p">)</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">local</span><span class="p">):</span>
</span><span class='line'>        <span class="n">path</span> <span class="o">=</span> <span class="n">local</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">filename</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="c"># ignores link or block file</span>
</span><span class='line'>            <span class="n">status</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>            <span class="n">msg</span> <span class="o">=</span> <span class="n">template</span> <span class="o">%</span> <span class="p">(</span>
</span><span class='line'>                <span class="s">&#39;d&#39;</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">else</span> <span class="s">&#39;-&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;0&#39;</span><span class="p">,</span> <span class="s">&#39;0&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">status</span><span class="p">[</span><span class="n">stat</span><span class="o">.</span><span class="n">ST_SIZE</span><span class="p">],</span>
</span><span class='line'>                <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%b </span><span class="si">%d</span><span class="s">  %Y&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="n">stat</span><span class="o">.</span><span class="n">ST_MTIME</span><span class="p">])),</span>
</span><span class='line'>                <span class="n">filename</span><span class="p">)</span>
</span><span class='line'>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;utf8&#39;</span><span class="p">]:</span> <span class="n">msg</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">())</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">226</span><span class="p">,</span> <span class="s">&quot;Limit&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">close_data_fd</span><span class="p">()</span>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_PASV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;pasv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">localhost</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>        <span class="n">ip</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">227</span><span class="p">,</span> <span class="s">&#39;Enter Passive Mode (</span><span class="si">%s</span><span class="s">,</span><span class="si">%u</span><span class="s">,</span><span class="si">%u</span><span class="s">).&#39;</span> <span class="o">%</span>
</span><span class='line'>                <span class="p">(</span><span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ip</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)),</span> <span class="p">(</span><span class="n">port</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">8</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="p">(</span><span class="n">port</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="mh">0xff</span><span class="p">)))</span>
</span><span class='line'>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class='line'>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;in pasv&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&#39;passive mode failed&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_PORT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>        <span class="n">t</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">data_host</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">data_port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">data_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>    <span class="k">except</span><span class="p">:</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&quot;PORT failed&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_DELE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="n">remote</span><span class="p">,</span> <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_path</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">450</span><span class="p">,</span> <span class="s">&quot;File not exist&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span>
</span><span class='line'>    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="s">&#39;File deleted&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_OPTS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;UTF8 ON&quot;</span><span class="p">:</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;utf8&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">elif</span> <span class="n">arg</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;UTF8 OFF&quot;</span><span class="p">:</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;utf8&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&quot;Invalid argument&quot;</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">class</span> <span class="nc">FTPThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
</span><span class='line'>    <span class="err">‘</span><span class="s">&#39;’FTPConnection Thread Wrapper’’’</span>
</span><span class='line'>    <span class="k">def</span> <span class="err">&lt;</span><span class="nf">strong</span><span class="o">&gt;</span><span class="n">init</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">remote_ip</span><span class="p">):</span>
</span><span class='line'>        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">init</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span> <span class="o">=</span> <span class="n">FTPConnection</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">remote_ip</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span class='line'>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Thread done&quot;</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">class</span> <span class="nc">FTPThreadServer</span><span class="p">:</span>
</span><span class='line'>    <span class="err">‘</span><span class="s">&#39;’FTP Server which is using thread’’’</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">serve_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="n">listen_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
</span><span class='line'>        <span class="n">listen_fd</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>        <span class="n">listen_fd</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span><span class='line'>        <span class="n">listen_fd</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'>        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="err">‘</span><span class="n">new</span> <span class="n">server</span><span class="err">’</span><span class="p">)</span>
</span><span class='line'>            <span class="n">client_fd</span><span class="p">,</span> <span class="n">client_addr</span> <span class="o">=</span> <span class="n">listen_fd</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
</span><span class='line'>            <span class="n">handler</span> <span class="o">=</span> <span class="n">FTPThread</span><span class="p">(</span><span class="n">client_fd</span><span class="p">,</span> <span class="n">client_addr</span><span class="p">)</span>
</span><span class='line'>            <span class="n">handler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">class</span> <span class="nc">FTPForkServer</span><span class="p">:</span>
</span><span class='line'>    <span class="err">‘</span><span class="s">&#39;’FTP Fork Server, use process per user’’’</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">child_main</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_fd</span><span class="p">,</span> <span class="n">client_addr</span><span class="p">,</span> <span class="n">write_end</span><span class="p">):</span>
</span><span class='line'>        <span class="err">‘</span><span class="s">&#39;’never return’’’</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_fds</span><span class="p">:</span>
</span><span class='line'>            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">read_fds</span> <span class="o">=</span> <span class="p">[]</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="n">handler</span> <span class="o">=</span> <span class="n">FTPConnection</span><span class="p">(</span><span class="n">client_fd</span><span class="p">,</span> <span class="n">client_addr</span><span class="p">)</span>
</span><span class='line'>        <span class="n">handler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span class='line'>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class='line'>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;in child_main&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">write_end</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">write_end</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">serve_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>    <span class="n">listen_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>    <span class="n">listen_fd</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="n">listen_fd</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span><span class='line'>    <span class="n">listen_fd</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">read_fds</span> <span class="o">=</span> <span class="p">[</span><span class="n">listen_fd</span><span class="p">]</span>
</span><span class='line'>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>        <span class="n">rlist</span><span class="p">,</span> <span class="n">wlist</span><span class="p">,</span> <span class="n">xlist</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_fds</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[])</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="n">listen_fd</span> <span class="ow">in</span> <span class="n">rlist</span><span class="p">:</span>
</span><span class='line'>            <span class="n">client_fd</span><span class="p">,</span> <span class="n">client_addr</span> <span class="o">=</span> <span class="n">listen_fd</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
</span><span class='line'>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_fds</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">limit_connection_number</span><span class="p">:</span>
</span><span class='line'>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;reject client: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">client_addr</span><span class="p">))</span>
</span><span class='line'>                <span class="n">client_fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>                <span class="k">continue</span>
</span><span class='line'>            <span class="k">try</span><span class="p">:</span>
</span><span class='line'>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;new client: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">client_addr</span><span class="p">))</span>
</span><span class='line'>                <span class="n">read_end</span><span class="p">,</span> <span class="n">write_end</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">read_fds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">read_end</span><span class="p">)</span>
</span><span class='line'>                <span class="n">fork_result</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">fork_result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># child process</span>
</span><span class='line'>                    <span class="n">listen_fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>                    <span class="bp">self</span><span class="o">.</span><span class="n">read_fds</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">)</span>
</span><span class='line'>                    <span class="bp">self</span><span class="o">.</span><span class="n">child_main</span><span class="p">(</span><span class="n">client_fd</span><span class="p">,</span> <span class="n">client_addr</span><span class="p">,</span> <span class="n">write_end</span><span class="p">)</span> <span class="c"># never return</span>
</span><span class='line'>                <span class="k">else</span><span class="p">:</span>
</span><span class='line'>                    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">write_end</span><span class="p">)</span>
</span><span class='line'>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class='line'>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Fork failed&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">for</span> <span class="n">read_fd</span> <span class="ow">in</span> <span class="n">rlist</span><span class="p">:</span>
</span><span class='line'>            <span class="k">if</span> <span class="n">read_fd</span> <span class="o">==</span> <span class="n">listen_fd</span><span class="p">:</span> <span class="k">continue</span>
</span><span class='line'>            <span class="n">data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">read_fd</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">read_fds</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">read_fd</span><span class="p">)</span>
</span><span class='line'>            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">read_fd</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">get_uid</span><span class="p">(</span><span class="n">username</span> <span class="o">=</span> <span class="err">‘</span><span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="err">’</span><span class="p">):</span>
</span><span class='line'>    <span class="err">‘</span><span class="s">&#39;’get uid by username, I don’t know whether there’s a</span>
</span><span class='line'>    <span class="n">function</span> <span class="n">can</span> <span class="n">get</span> <span class="n">it</span><span class="p">,</span> <span class="n">so</span> <span class="n">I</span> <span class="n">wrote</span> <span class="n">this</span> <span class="n">function</span><span class="o">.</span><span class="err">’’’</span>
</span><span class='line'>    <span class="n">pwd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="err">‘</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span><span class="err">’</span><span class="p">,</span> <span class="err">‘</span><span class="n">r</span><span class="err">’</span><span class="p">)</span>
</span><span class='line'>    <span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">username</span> <span class="o">+</span> <span class="err">‘</span><span class="p">:</span><span class="o">.&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="err">?</span><span class="p">:(</span><span class="o">.&lt;/</span><span class="n">em</span><span class="o">&gt;</span><span class="err">?</span><span class="p">):</span><span class="o">.*</span><span class="err">?’</span><span class="p">)</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">pwd</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
</span><span class='line'>        <span class="k">try</span><span class="p">:</span>
</span><span class='line'>            <span class="n">uid</span> <span class="o">=</span> <span class="n">pat</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>        <span class="k">except</span><span class="p">:</span> <span class="k">continue</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">get_logger</span><span class="p">(</span><span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()):</span>
</span><span class='line'>    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
</span><span class='line'>    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="err">‘</span><span class="o">%</span><span class="p">(</span><span class="n">asctime</span><span class="p">)</span><span class="n">s</span> <span class="o">%</span><span class="p">(</span><span class="n">levelname</span><span class="p">)</span><span class="n">s</span> <span class="o">%</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="n">s</span><span class="err">’</span><span class="p">)</span>
</span><span class='line'>    <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
</span><span class='line'>    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
</span><span class='line'>    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">logger</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">daemonize</span><span class="p">(</span><span class="n">stdin</span><span class="o">=</span><span class="err">’</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span><span class="err">’</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="err">’</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span><span class="err">’</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="err">’</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span><span class="err">’</span><span class="p">):</span>
</span><span class='line'>    <span class="err">‘</span><span class="s">&#39;’becomes a daemon’’’</span>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">pid</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="err">“</span><span class="n">fork</span> <span class="c">#1 failed\n”)</span>
</span><span class='line'>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="n">os</span><span class="o">.</span><span class="n">setsid</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">try</span><span class="p">:</span>
</span><span class='line'>    <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">pid</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;fork #2 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span class='line'><span class="n">si</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">so</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&#39;a+&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">se</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;a+&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>  <span class="c"># 0</span>
</span><span class='line'><span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">so</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span> <span class="c"># 1</span>
</span><span class='line'><span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">se</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span> <span class="c"># 2</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">serve_forever</span><span class="p">():</span>
</span><span class='line'>    <span class="k">global</span> <span class="n">global_options</span>
</span><span class='line'>    <span class="k">print</span> <span class="n">global_options</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">global_options</span><span class="p">[</span><span class="err">‘</span><span class="n">run_mode</span><span class="err">’</span><span class="p">]</span> <span class="o">==</span> <span class="err">‘</span><span class="n">fork</span><span class="err">’</span><span class="p">:</span>
</span><span class='line'>        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGCHLD</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_IGN</span><span class="p">)</span>
</span><span class='line'>        <span class="n">server</span> <span class="o">=</span> <span class="n">FTPForkServer</span><span class="p">()</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="n">server</span> <span class="o">=</span> <span class="n">FTPThreadServer</span><span class="p">()</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">usage</span><span class="p">():</span>
</span><span class='line'>    <span class="k">print</span> <span class="err">‘</span><span class="s">&#39;’usage: </span><span class="si">%s</span><span class="s"> [-d] [-h] [-p port] [-o] [-t]</span>
</span><span class='line'>    <span class="o">-</span><span class="n">d</span> <span class="n">become</span> <span class="n">a</span> <span class="n">daemon</span>
</span><span class='line'>    <span class="o">-</span><span class="n">h</span> <span class="n">help</span>
</span><span class='line'>    <span class="o">-</span><span class="n">p</span> <span class="n">listen</span> <span class="n">port</span>
</span><span class='line'>    <span class="o">-</span><span class="n">o</span> <span class="n">output</span> <span class="n">log</span> <span class="n">to</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">by</span> <span class="n">default</span><span class="p">,</span> <span class="n">it</span> <span class="n">outputs</span> <span class="n">to</span> <span class="n">a</span> <span class="n">log</span> <span class="nb">file</span><span class="o">.</span>
</span><span class='line'>    <span class="o">-</span><span class="n">t</span> <span class="n">thread</span> <span class="n">mode</span><span class="p">,</span> <span class="n">fork</span> <span class="n">model</span> <span class="n">by</span> <span class="n">default</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">Waring</span><span class="p">:</span>
</span><span class='line'>    <span class="n">The</span> <span class="n">Thread</span> <span class="n">Mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">complete</span><span class="o">.&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">Author</span><span class="p">:</span>
</span><span class='line'>    <span class="n">Hua</span> <span class="n">Liang</span> <span class="p">[</span> <span class="n">Stupid</span> <span class="n">ET</span> <span class="p">]</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;&amp;#109;&amp;#097;&amp;#105;&amp;#108;&amp;#116;&amp;#111;:&amp;#101;&amp;#116;&amp;#064;&amp;#101;&amp;#118;&amp;#101;&amp;#114;&amp;#101;&amp;#116;&amp;#046;&amp;#111;&amp;#114;&amp;#103;&quot;</span><span class="o">&gt;&amp;</span><span class="c">#101;&amp;#116;&amp;#064;&amp;#101;&amp;#118;&amp;#101;&amp;#114;&amp;#101;&amp;#116;&amp;#046;&amp;#111;&amp;#114;&amp;#103;&lt;/a&gt;</span>
</span><span class='line'>    <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">EverET</span><span class="o">.</span><span class="n">org</span>
</span><span class='line'><span class="err">‘’’</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">param_handler</span><span class="p">(</span><span class="n">opts</span><span class="p">):</span>
</span><span class='line'>    <span class="k">global</span> <span class="n">port</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">global_options</span>
</span><span class='line'>    <span class="n">be_daemon</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class='line'>    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">logfile</span><span class="p">))</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">o</span> <span class="o">==</span> <span class="err">‘</span><span class="o">-</span><span class="n">h</span><span class="err">’</span><span class="p">:</span>
</span><span class='line'>            <span class="n">usage</span><span class="p">()</span>
</span><span class='line'>            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="err">‘</span><span class="o">-</span><span class="n">d</span><span class="err">’</span><span class="p">:</span>
</span><span class='line'>            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="err">‘</span><span class="n">posix</span><span class="err">’</span><span class="p">:</span>
</span><span class='line'>                <span class="k">print</span> <span class="err">‘</span><span class="n">Only</span> <span class="n">support</span> <span class="n">the</span> <span class="n">os</span> <span class="k">with</span> <span class="n">posix</span> <span class="n">specifications</span><span class="o">.</span><span class="err">’</span>
</span><span class='line'>                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>            <span class="n">be_daemon</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class='line'>        <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="err">‘</span><span class="o">-</span><span class="n">o</span><span class="err">’</span><span class="p">:</span>
</span><span class='line'>            <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>
</span><span class='line'>        <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="err">‘</span><span class="o">-</span><span class="n">p</span><span class="err">’</span><span class="p">:</span>
</span><span class='line'>            <span class="k">try</span><span class="p">:</span> <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span class='line'>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>                <span class="n">usage</span><span class="p">()</span>
</span><span class='line'>                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="err">‘</span><span class="o">-</span><span class="n">t</span><span class="err">’</span><span class="p">:</span>
</span><span class='line'>            <span class="n">global_options</span><span class="p">[</span><span class="err">‘</span><span class="n">run_mode</span><span class="err">’</span><span class="p">]</span> <span class="o">=</span> <span class="err">‘</span><span class="n">thread</span><span class="err">’</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s">&#39;posix&#39;</span> <span class="ow">and</span> <span class="n">global_options</span><span class="p">[</span><span class="s">&#39;run_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;fork&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;You can NOT run fork mode in a non posix os,\  please use -t options to run in thread mode&quot;</span>
</span><span class='line'>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="k">if</span> <span class="n">be_daemon</span><span class="p">:</span> <span class="n">daemonize</span><span class="p">()</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">if</span> <span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">name</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span> <span class="o">==</span> <span class="err">‘</span><span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">main</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span><span class="err">’</span><span class="p">:</span>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="n">opts</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">getopt</span><span class="o">.</span><span class="n">getopt</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="err">‘</span><span class="n">hdp</span><span class="p">:</span><span class="n">ot</span><span class="err">’</span><span class="p">)</span>
</span><span class='line'>    <span class="k">except</span> <span class="n">getopt</span><span class="o">.</span><span class="n">GetoptError</span><span class="p">:</span>
</span><span class='line'>        <span class="n">usage</span><span class="p">()</span>
</span><span class='line'>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">param_handler</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="sd">&#39;&#39;&#39;You can write your account_info in ftp.py.config&#39;&#39;&#39;</span>
</span><span class='line'><span class="k">try</span><span class="p">:</span> <span class="nb">execfile</span><span class="p">(</span><span class="s">&#39;ftp.py.config&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">serve_forever</span><span class="p">()</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Python端口转发及重定向实现Eclipse的TCP/IP Monitor]]></title>
    <link href="http://everet.org/2012/03/python-forwarding-redirecting-tcp-monitor.html"/>
    <updated>2012-03-23T22:41:54+08:00</updated>
    <id>http://everet.org/2012/03/python-forwarding-redirecting-tcp-monitor</id>
    <content type="html"><![CDATA[<p>记得在上个学期的时候选了徐扬老师的《Web服务与面向服务的体系结构》，讲了SOA之类的一堆东西。然后实验就是要4个下午做完IBM一个星期的培训课程……</p>

<p>于是偶们便开始无脑地照着下面这本手册来狂做实验。记得要做10多个实验，算一下一个下午要做2-3个实验，所以当场做的话只能无脑操作鸟。不能不说是教育的悲哀啊。</p>

<p><a href="http://everet.org/wp-content/uploads/2012/03/QQ20120323140703.png"><img src="http://everet.org/wp-content/uploads/2012/03/QQ20120323140703_thumb.png" alt="QQ截图20120323140703" /></a></p>

<p>记得在做“<strong>Exercise 7. Creating Web service clients</strong>”，有一小节是使用TCP/IP Monitor来检查SOAP消息。</p>

<p>也就是在Eclipse的TCP/IP Monitor中，设置监听一个端口如9081，然后设置你的SOA服务器的端口9080。然后你和9081端口的通信就会重定向到了9080.然后你就可以看到他们的数据传输。</p>

<!-- more -->

<p><a href="http://everet.org/wp-content/uploads/2012/03/image4.png"><img src="http://everet.org/wp-content/uploads/2012/03/image_thumb4.png" alt="image" /></a></p>

<p>当我们发送SOAP消息时候，就可以在TCP/IP Monitor中看到我们的SOAP消息了。</p>

<p><a href="http://everet.org/wp-content/uploads/2012/03/image5.png"><img src="http://everet.org/wp-content/uploads/2012/03/image_thumb5.png" alt="image" /></a></p>

<h2 id="section"></h2>

<h2 id="python">Python出场</h2>

<p>其实上述功能，其原理就是端口的转发和重定向，再加上把中间的信息输出罢了。</p>

<p>首先，我们用webpy写一个简单的网站，监听8080端口，返回“Hello, EverET.org”的页面。</p>

<p>然后我们使用我们的forwarding.py，在80端口和8080端口中间建立两条通信管道用于双向通信。</p>

<p>此时，我们通过80端口访问我们的服务器。</p>

<p>浏览器得到：</p>

<p><a href="http://everet.org/wp-content/uploads/2012/03/image6.png"><img src="http://everet.org/wp-content/uploads/2012/03/image_thumb6.png" alt="image" /></a></p>

<p>然后，我们在forwarding.py的输出结果中可以看到浏览器和webpy之间的通信内容。</p>

<p><a href="http://everet.org/wp-content/uploads/2012/03/image7.png"><img src="http://everet.org/wp-content/uploads/2012/03/image_thumb7.png" alt="image" /></a></p>

<h3 id="section-1">代码：</h3>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>python  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;usrbinenv-python&quot;</span><span class="o">&gt;</span><span class="err">!</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">env</span> <span class="n">python</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">socket</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">threading</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">loglock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
</span><span class='line'><span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
</span><span class='line'>    <span class="n">loglock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="err">‘</span><span class="p">[</span><span class="o">%</span><span class="n">s</span><span class="p">]:</span> \<span class="n">n</span><span class="o">%</span><span class="n">s</span>\<span class="n">n</span><span class="err">’</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(),</span> <span class="n">msg</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span class='line'>        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span class='line'>    <span class="k">finally</span><span class="p">:</span>
</span><span class='line'>        <span class="n">loglock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">class</span> <span class="nc">PipeThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
</span><span class='line'>    <span class="k">def</span> <span class="err">&lt;</span><span class="nf">strong</span><span class="o">&gt;</span><span class="n">init</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
</span><span class='line'>        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">init</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>        <span class="k">try</span><span class="p">:</span>
</span><span class='line'>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span><span class='line'>            <span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span> <span class="k">break</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>        <span class="k">except</span><span class="p">:</span>
</span><span class='line'>            <span class="k">break</span>
</span><span class='line'>    <span class="n">log</span><span class="p">(</span><span class="s">&#39;PipeThread done&#39;</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">class</span> <span class="nc">Forwarding</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
</span><span class='line'>    <span class="k">def</span> <span class="err">&lt;</span><span class="nf">strong</span><span class="o">&gt;</span><span class="n">init</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">targethost</span><span class="p">,</span> <span class="n">targetport</span><span class="p">):</span>
</span><span class='line'>        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">init</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">targethost</span> <span class="o">=</span> <span class="n">targethost</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">targetport</span> <span class="o">=</span> <span class="n">targetport</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="err">‘</span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="err">’</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>            <span class="n">client_fd</span><span class="p">,</span> <span class="n">client_addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
</span><span class='line'>            <span class="n">target_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>            <span class="n">target_fd</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">targethost</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetport</span><span class="p">))</span>
</span><span class='line'>            <span class="n">log</span><span class="p">(</span><span class="err">‘</span><span class="n">new</span> <span class="n">connect</span><span class="err">’</span><span class="p">)</span>
</span><span class='line'>            <span class="c"># two direct pipe</span>
</span><span class='line'>            <span class="n">PipeThread</span><span class="p">(</span><span class="n">target_fd</span><span class="p">,</span> <span class="n">client_fd</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span class='line'>            <span class="n">PipeThread</span><span class="p">(</span><span class="n">client_fd</span><span class="p">,</span> <span class="n">target_fd</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">if</span> <span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">name</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span> <span class="o">==</span> <span class="err">‘</span><span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">main</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span><span class="err">’</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="err">‘</span><span class="n">Starting</span><span class="err">’</span>
</span><span class='line'>    <span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'>        <span class="n">targethost</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span class='line'>        <span class="k">try</span><span class="p">:</span> <span class="n">targetport</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span class='line'>        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span> <span class="n">targetport</span> <span class="o">=</span> <span class="n">port</span>
</span><span class='line'>    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
</span><span class='line'>        <span class="k">print</span> <span class="err">‘</span><span class="n">Usage</span><span class="p">:</span> <span class="o">%</span><span class="n">s</span> <span class="n">port</span> <span class="n">targethost</span> <span class="p">[</span><span class="n">targetport</span><span class="p">]</span><span class="err">’</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="c">#sys.stdout = open(&#39;forwaring.log&#39;, &#39;w&#39;)</span>
</span><span class='line'><span class="n">Forwarding</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">targethost</span><span class="p">,</span> <span class="n">targetport</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>更多我的Python代码请见：<a href="https://github.com/cedricporter/et-python">https://github.com/cedricporter/et-python</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Mission: FTP Protocol]]></title>
    <link href="http://everet.org/2012/03/ftp-protocol.html"/>
    <updated>2012-03-18T08:54:17+08:00</updated>
    <id>http://everet.org/2012/03/ftp-protocol</id>
    <content type="html"><![CDATA[<p>FTP协议以前我用得挺少的，网络课上刘孜文老师曰FTP协议过时也就跳过了。不过现在FTP用得还是挺多的，所以决定围观下FTP。</p>

<p>刘孜文老师的经典名言是：我所学到的东西都不是从课堂上得来的。这点我挺赞同的。</p>

<p>刘孜文老师超强悍，中科院的博士，2个月看完了Linux内核的代码。</p>

<p>记得第一节课他说可以不用去上课，只要自己学就好了，于是偶深入贯彻刘老师的话，所以就一学期也没去上网络课了。</p>

<p>课下的时间都花在Scar上，网络也没仔细研究过，悲剧了，现在开始要好好补下才行了。</p>

<h2 id="ftp">以下的内容是关于FTP协议的。</h2>

<p>HTTP和FTP都是文件传输协议,他们都运行在TCP之上.</p>

<p>最显著的区别在于FTP使用两个并行的TCP连接,一个是控制连接(control connection),一个是数据连接(data connection).通常控制连接使用21端口.</p>

<p>因为FTP协议使用一个分离的控制连接,所以我们也称FTP的控制信息是带外(out-of-band)传送的。而HTTP协议在TCP连接中发送请求和响应首部行来控制，所以HTTP也可以说是带内（in-band)发送控制信息。</p>

<p>FTP服务器必须在整个会话中保存用户的状态信息，也就是说要保存用户的权限信息，远程目录树的当前位置。而HTTP协议则是无状态的，要通过cookie来保存用户状态。</p>

<!-- more -->

<h3 id="ftp-1">FTP协议的控制连接和数据连接如下图。</h3>

<p><a href="http://everet.org/wp-content/uploads/2012/03/image.png"><img src="http://everet.org/wp-content/uploads/2012/03/image_thumb.png" alt="image" /></a></p>

<p>FTP协议的定义：<a href="http://www.w3.org/Protocols/rfc959/">http://www.w3.org/Protocols/rfc959/</a></p>

<p><a href="http://everet.org/wp-content/uploads/2012/03/image1.png"><img src="http://everet.org/wp-content/uploads/2012/03/image_thumb1.png" alt="image" /></a></p>

<h2 id="section">两种模式</h2>

<p>FTP协议的数据传输存在两种模式：主动模式( Active mode ) 和被动模式( Passive mode ) 。这两种模式发起连接的方向截然相反，主动模式是从服务器端向客户端发起；被动模式是客户端向服务器端发起连接。</p>

<p>如果采用被动模式，由于FTP服务器完全随机的选择一个端口，并告知客户，然后客户进行主动连接，这就意味着在服务器上，你要让所有的端口都允许动态入站连接才行，这样肯定不行，因为太危险了，等于打开了所有的端口连接。
如果采用主动模式（PORT Mode)，FTP服务器选择好端口后，主动与客户进行连接，这时候不需要像PASV模式那样打开所有的动态入站连接，而且正好相反，我们需要打开所有的动态出站连接即可，安全性增加很多。联机模式</p>

<h3 id="active-mode-">主动模式 ( Active mode )</h3>

<p>FTP Client 跟 FTP Server 联机后，会主动利用 PORT 指令提出 DATA Channel 联机的要求，如下：</p>

<blockquote>
  <p>指令: PORT 10,18,53,171,17,114</p>
</blockquote>

<p>回应: 200 Port command successful.</p>

<p>这里的 PORT 指令是由 FTP Client 送出的，当需要建立 DATA Channel 时，FTP Server 会主动利用 Server 主机的 Port 20 发出联机到 FTP Client 的主机，而 PORT 指令后的参数说明如下：</p>

<p>前四个数字是 FTP Client 的 IP 地址：10.18.53.171</p>

<p>后两个数字是 FTP Client 接受联机的 Port 埠号，埠号的计算方式是 (第五个数字 * 256 + 第六个数字)，以此范例来说，FTP Client 接受的联机埠号是 17 * 256 + 114 = 4,466</p>

<p>由此可知，如果 FTP Client 处于 NAT 的环境下的话，FTP Server 几乎无法正常的联机到 FTP Client 的主机，所以现在大部分的联机模式几乎都建议用户使用被动模式(Passive mode)。</p>

<h3 id="passive-mode-">被动模式 ( Passive mode )</h3>

<p>FTP Client 跟 FTP Server 联机后，会主动利用 PASV 指令提出 DATA Channel 联机的要求，如下：</p>

<blockquote>
  <p>指令: PASV</p>
</blockquote>

<p>回应: 227 Entering Passive Mode (59,37,124,43,158,251)</p>

<p>你可以看到由 FTP Client 送出的 PASV 指令并没有送出其他的参数，而是在 FTP Server 响应的时候出现了 (59,37,124,43,158,251) 字符串，当需要建立 DATA Channel 时，这时就会由 FTP Client 主动连接至 FTP Server 动态开放的 Port 供 FTP Client 连接，其中 (59,37,124,43,158,251) 的说明如下：</p>

<p>前四个数字是 FTP Server 的 IP 地址：59.37.124.43</p>

<p>后两个数字是 FTP Server 接受联机的 Port 端口号，端口号的计算方式是 (第五个数字 * 256 + 第六个数字)，以此范例来说，FTP Server 可接受的联机端口号是 158 * 256 + 251 = 40,699</p>

<p>由此可知，使用被动模式(Passive mode)对 FTP Server 的系统管理员来说，可掌控的部分是比较多的，因为 FTP Server 无法决定用户是否可使用主动模式联机，但若改使用被动模式联机的话，就几乎能让所有人正常的使用 FTP 服务。</p>

<h2 id="section-1">其他</h2>

<p>FTP协议的命令和应答：<a href="http://www.w3.org/Protocols/rfc959/4_FileTransfer.html">http://www.w3.org/Protocols/rfc959/4_FileTransfer.html</a></p>

<h3 id="ftp-commands-ftp">FTP COMMANDS [FTP命令]</h3>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;strong>USER&lt;/strong> &lt;sp> &lt;username> &lt;crlf>
</span><span class='line'>**PASS** &lt;sp> &lt;password> &lt;crlf>
</span><span class='line'>**ACCT** &lt;sp> &lt;account-information> &lt;crlf>
</span><span class='line'>**CWD**  &lt;sp> &lt;pathname> &lt;crlf>
</span><span class='line'>**CDUP** &lt;crlf>
</span><span class='line'>**SMNT** &lt;sp> &lt;pathname> &lt;crlf>
</span><span class='line'>**QUIT** &lt;crlf>
</span><span class='line'>**REIN** &lt;crlf>
</span><span class='line'>**PORT** &lt;sp> &lt;host-port> &lt;crlf>
</span><span class='line'>**PASV** &lt;crlf>
</span><span class='line'>**TYPE** &lt;sp> &lt;type-code> &lt;crlf>
</span><span class='line'>**STRU** &lt;sp> &lt;structure-code> &lt;crlf>
</span><span class='line'>**MODE** &lt;sp> &lt;mode-code> &lt;crlf>
</span><span class='line'>**RETR** &lt;sp> &lt;pathname> &lt;crlf>
</span><span class='line'>**STOR** &lt;sp> &lt;pathname> &lt;crlf>
</span><span class='line'>**STOU** &lt;crlf>
</span><span class='line'>**APPE** &lt;sp> &lt;pathname> &lt;crlf>
</span><span class='line'>**ALLO** &lt;sp> &lt;decimal-integer>
</span><span class='line'>    [&lt;sp> R &lt;sp> &lt;decimal-integer>] &lt;crlf>
</span><span class='line'>**REST** &lt;sp> &lt;marker> &lt;crlf>
</span><span class='line'>**RNFR** &lt;sp> &lt;pathname> &lt;crlf>
</span><span class='line'>**RNTO** &lt;sp> &lt;pathname> &lt;crlf>
</span><span class='line'>**ABOR** &lt;crlf>
</span><span class='line'>**DELE** &lt;sp> &lt;pathname> &lt;crlf>
</span><span class='line'>**RMD**  &lt;sp> &lt;pathname> &lt;crlf>
</span><span class='line'>**MKD**  &lt;sp> &lt;pathname> &lt;crlf>
</span><span class='line'>**PWD**  &lt;crlf>
</span><span class='line'>**LIST** [&lt;sp> &lt;pathname>] &lt;crlf>
</span><span class='line'>**NLST** [&lt;sp> &lt;pathname>] &lt;crlf>
</span><span class='line'>**SITE** &lt;sp> &lt;string> &lt;crlf>
</span><span class='line'>**SYST** &lt;crlf>
</span><span class='line'>**STAT** [&lt;sp> &lt;pathname>] &lt;crlf>
</span><span class='line'>**HELP** [&lt;sp> &lt;string>] &lt;crlf>
</span><span class='line'>**NOOP** &lt;crlf></span></code></pre></td></tr></table></div></figure></notextile></div></crlf></crlf></string></sp></crlf></pathname></sp></crlf></crlf></string></sp></crlf></pathname></sp></crlf></pathname></sp></crlf></crlf></pathname></sp></crlf></pathname></sp></crlf></pathname></sp></crlf></crlf></pathname></sp></crlf></pathname></sp></crlf></marker></sp></crlf></decimal-integer></sp></sp></decimal-integer></sp></crlf></pathname></sp></crlf></crlf></pathname></sp></crlf></pathname></sp></crlf></mode-code></sp></crlf></structure-code></sp></crlf></type-code></sp></crlf></crlf></host-port></sp></crlf></crlf></crlf></pathname></sp></crlf></crlf></pathname></sp></crlf></account-information></sp></crlf></password></sp></crlf></username></sp></p>

<h3 id="reply-code-by-function-groups-">Reply Code By Function Groups [返回码]</h3>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;strong>110&lt;/strong> Restart marker reply.
</span><span class='line'>    In this case, the text is exact and not left to the
</span><span class='line'>    particular implementation; it must read:
</span><span class='line'>         MARK yyyy = mmmm
</span><span class='line'>    Where yyyy is User-process data stream marker, and mmmm
</span><span class='line'>    server’s equivalent marker (note the spaces between markers
</span><span class='line'>    and “=”).
</span><span class='line'>&lt;strong>120&lt;/strong> Service ready in nnn minutes.
</span><span class='line'>&lt;strong>125&lt;/strong> Data connection already open; transfer starting.
</span><span class='line'>&lt;strong>150&lt;/strong> File status okay; about to open data connection.
</span><span class='line'>&lt;strong>200&lt;/strong> Command okay.
</span><span class='line'>&lt;strong>202&lt;/strong> Command not implemented, superfluous at this site.
</span><span class='line'>&lt;strong>211&lt;/strong> System status, or system help reply.
</span><span class='line'>&lt;strong>212&lt;/strong> Directory status.
</span><span class='line'>&lt;strong>213&lt;/strong> File status.
</span><span class='line'>&lt;strong>214&lt;/strong> Help message.
</span><span class='line'>    On how to use the server or the meaning of a particular
</span><span class='line'>    non-standard command.  This reply is useful only to the
</span><span class='line'>    human user.
</span><span class='line'>&lt;strong>215&lt;/strong> NAME system type.
</span><span class='line'>    Where NAME is an official system name from the list in the
</span><span class='line'>    Assigned Numbers document.
</span><span class='line'>&lt;strong>220&lt;/strong> Service ready for new user.
</span><span class='line'>&lt;strong>221&lt;/strong> Service closing control connection.
</span><span class='line'>    Logged out if appropriate.
</span><span class='line'>&lt;strong>225&lt;/strong> Data connection open; no transfer in progress.
</span><span class='line'>&lt;strong>226&lt;/strong> Closing data connection.
</span><span class='line'>    Requested file action successful (for example, file
</span><span class='line'>    transfer or file abort).
</span><span class='line'>&lt;strong>227&lt;/strong> Entering Passive Mode (h1,h2,h3,h4,p1,p2).
</span><span class='line'>&lt;strong>230&lt;/strong> User logged in, proceed.
</span><span class='line'>&lt;strong>250&lt;/strong> Requested file action okay, completed.
</span><span class='line'>&lt;strong>257&lt;/strong> “PATHNAME” created.&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>&lt;strong>331&lt;/strong> User name okay, need password.
</span><span class='line'>&lt;strong>332&lt;/strong> Need account for login.
</span><span class='line'>&lt;strong>350&lt;/strong> Requested file action pending further information.&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>&lt;strong>421&lt;/strong> Service not available, closing control connection.
</span><span class='line'>    This may be a reply to any command if the service knows it
</span><span class='line'>    must shut down.
</span><span class='line'>&lt;strong>425&lt;/strong> Can’t open data connection.
</span><span class='line'>&lt;strong>426&lt;/strong> Connection closed; transfer aborted.
</span><span class='line'>&lt;strong>450&lt;/strong> Requested file action not taken.
</span><span class='line'>    File unavailable (e.g., file busy).
</span><span class='line'>&lt;strong>451&lt;/strong> Requested action aborted: local error in processing.
</span><span class='line'>&lt;strong>452&lt;/strong> Requested action not taken.
</span><span class='line'>    Insufficient storage space in system.
</span><span class='line'>&lt;strong>500&lt;/strong> Syntax error, command unrecognized.
</span><span class='line'>    This may include errors such as command line too long.
</span><span class='line'>&lt;strong>501&lt;/strong> Syntax error in parameters or arguments.
</span><span class='line'>&lt;strong>502&lt;/strong> Command not implemented.
</span><span class='line'>&lt;strong>503&lt;/strong> Bad sequence of commands.
</span><span class='line'>&lt;strong>504&lt;/strong> Command not implemented for that parameter.
</span><span class='line'>&lt;strong>530&lt;/strong> Not logged in.
</span><span class='line'>&lt;strong>532&lt;/strong> Need account for storing files.
</span><span class='line'>&lt;strong>550&lt;/strong> Requested action not taken.
</span><span class='line'>    File unavailable (e.g., file not found, no access).
</span><span class='line'>&lt;strong>551&lt;/strong> Requested action aborted: page type unknown.
</span><span class='line'>&lt;strong>552&lt;/strong> Requested file action aborted.
</span><span class='line'>    Exceeded storage allocation (for current directory or
</span><span class='line'>    dataset).
</span><span class='line'>&lt;strong>553&lt;/strong> Requested action not taken.
</span><span class='line'>    File name not allowed.</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3 id="section-2">文法</h3>

<p>The syntax of the above argument fields (using BNF notation where applicable) is:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>php  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;username&gt; ::= &lt;string&gt;</span>
</span><span class='line'><span class="x">&lt;password&gt; ::= &lt;string&gt;</span>
</span><span class='line'><span class="x">&lt;account-information&gt; ::= &lt;string&gt;</span>
</span><span class='line'><span class="x">&lt;string&gt; ::= &lt;char&gt; | &lt;char&gt;&lt;string&gt;</span>
</span><span class='line'><span class="x">&lt;char&gt; ::= any of the 128 ASCII characters except &lt;cr&gt; and</span>
</span><span class='line'><span class="x">&lt;lf&gt;</span>
</span><span class='line'><span class="x">&lt;marker&gt; ::= &lt;pr-string&gt;</span>
</span><span class='line'><span class="x">&lt;pr-string&gt; ::= &lt;pr-char&gt; | &lt;pr-char&gt;&lt;pr-string&gt;</span>
</span><span class='line'><span class="x">&lt;pr-char&gt; ::= printable characters, any</span>
</span><span class='line'><span class="x">              ASCII code 33 through 126</span>
</span><span class='line'><span class="x">&lt;byte-size&gt; ::= &lt;number&gt;</span>
</span><span class='line'><span class="x">&lt;host-port&gt; ::= &lt;host-number&gt;,&lt;port-number&gt;</span>
</span><span class='line'><span class="x">&lt;host-number&gt; ::= &lt;number&gt;,&lt;number&gt;,&lt;number&gt;,&lt;number&gt;</span>
</span><span class='line'><span class="x">&lt;port-number&gt; ::= &lt;number&gt;,&lt;number&gt;</span>
</span><span class='line'><span class="x">&lt;number&gt; ::= any decimal integer 1 through 255</span>
</span><span class='line'><span class="x">&lt;form-code&gt; ::= N | T | C</span>
</span><span class='line'><span class="x">&lt;type-code&gt; ::= A [&lt;sp&gt; &lt;form-code&gt;]</span>
</span><span class='line'><span class="x">              | E [&lt;sp&gt; &lt;form-code&gt;]</span>
</span><span class='line'><span class="x">              | I</span>
</span><span class='line'><span class="x">              | L &lt;sp&gt; &lt;byte-size&gt;</span>
</span><span class='line'><span class="x">&lt;structure-code&gt; ::= F | R | P</span>
</span><span class='line'><span class="x">&lt;mode-code&gt; ::= S | B | C</span>
</span><span class='line'><span class="x">&lt;pathname&gt; ::= &lt;string&gt;</span>
</span><span class='line'><span class="x">&lt;decimal-integer&gt; ::= any decimal integer</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

                             



### 各种命令的各种返回码



<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>python  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">Connection</span> <span class="n">Establishment</span>
</span><span class='line'>   <span class="mi">120</span>
</span><span class='line'>      <span class="mi">220</span>
</span><span class='line'>   <span class="mi">220</span>
</span><span class='line'>   <span class="mi">421</span>
</span><span class='line'><span class="n">Login</span>
</span><span class='line'>   <span class="n">USER</span>
</span><span class='line'>      <span class="mi">230</span>
</span><span class='line'>      <span class="mi">530</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">421</span>
</span><span class='line'>      <span class="mi">331</span><span class="p">,</span> <span class="mi">332</span>
</span><span class='line'>   <span class="n">PASS</span>
</span><span class='line'>      <span class="mi">230</span>
</span><span class='line'>      <span class="mi">202</span>
</span><span class='line'>      <span class="mi">530</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">503</span><span class="p">,</span> <span class="mi">421</span>
</span><span class='line'>      <span class="mi">332</span>
</span><span class='line'>   <span class="n">ACCT</span>
</span><span class='line'>      <span class="mi">230</span>
</span><span class='line'>      <span class="mi">202</span>
</span><span class='line'>      <span class="mi">530</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">503</span><span class="p">,</span> <span class="mi">421</span>
</span><span class='line'>   <span class="n">CWD</span>
</span><span class='line'>      <span class="mi">250</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">421</span><span class="p">,</span> <span class="mi">530</span><span class="p">,</span> <span class="mi">550</span>
</span><span class='line'>   <span class="n">CDUP</span>
</span><span class='line'>      <span class="mi">200</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">421</span><span class="p">,</span> <span class="mi">530</span><span class="p">,</span> <span class="mi">550</span>
</span><span class='line'>   <span class="n">SMNT</span>
</span><span class='line'>      <span class="mi">202</span><span class="p">,</span> <span class="mi">250</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">421</span><span class="p">,</span> <span class="mi">530</span><span class="p">,</span> <span class="mi">550</span>
</span><span class='line'><span class="n">Logout</span>
</span><span class='line'>   <span class="n">REIN</span>
</span><span class='line'>      <span class="mi">120</span>
</span><span class='line'>         <span class="mi">220</span>
</span><span class='line'>      <span class="mi">220</span>
</span><span class='line'>      <span class="mi">421</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">502</span>
</span><span class='line'>   <span class="n">QUIT</span>
</span><span class='line'>      <span class="mi">221</span>
</span><span class='line'>      <span class="mi">500</span>
</span><span class='line'>
</span><span class='line'><span class="n">Transfer</span> <span class="n">parameters</span>
</span><span class='line'>   <span class="n">PORT</span>
</span><span class='line'>      <span class="mi">200</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">421</span><span class="p">,</span> <span class="mi">530</span>
</span><span class='line'>   <span class="n">PASV</span>
</span><span class='line'>      <span class="mi">227</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">421</span><span class="p">,</span> <span class="mi">530</span>
</span><span class='line'>   <span class="n">MODE</span>
</span><span class='line'>      <span class="mi">200</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">504</span><span class="p">,</span> <span class="mi">421</span><span class="p">,</span> <span class="mi">530</span>
</span><span class='line'>   <span class="n">TYPE</span>
</span><span class='line'>      <span class="mi">200</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">504</span><span class="p">,</span> <span class="mi">421</span><span class="p">,</span> <span class="mi">530</span>
</span><span class='line'>   <span class="n">STRU</span>
</span><span class='line'>      <span class="mi">200</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">504</span><span class="p">,</span> <span class="mi">421</span><span class="p">,</span> <span class="mi">530</span>
</span><span class='line'><span class="n">File</span> <span class="n">action</span> <span class="n">commands</span>
</span><span class='line'>   <span class="n">ALLO</span>
</span><span class='line'>      <span class="mi">200</span>
</span><span class='line'>      <span class="mi">202</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">504</span><span class="p">,</span> <span class="mi">421</span><span class="p">,</span> <span class="mi">530</span>
</span><span class='line'>   <span class="n">REST</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">421</span><span class="p">,</span> <span class="mi">530</span>
</span><span class='line'>      <span class="mi">350</span>
</span><span class='line'>   <span class="n">STOR</span>
</span><span class='line'>      <span class="mi">125</span><span class="p">,</span> <span class="mi">150</span>
</span><span class='line'>         <span class="p">(</span><span class="mi">110</span><span class="p">)</span>
</span><span class='line'>         <span class="mi">226</span><span class="p">,</span> <span class="mi">250</span>
</span><span class='line'>         <span class="mi">425</span><span class="p">,</span> <span class="mi">426</span><span class="p">,</span> <span class="mi">451</span><span class="p">,</span> <span class="mi">551</span><span class="p">,</span> <span class="mi">552</span>
</span><span class='line'>      <span class="mi">532</span><span class="p">,</span> <span class="mi">450</span><span class="p">,</span> <span class="mi">452</span><span class="p">,</span> <span class="mi">553</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">421</span><span class="p">,</span> <span class="mi">530</span>
</span><span class='line'>   <span class="n">STOU</span>
</span><span class='line'>      <span class="mi">125</span><span class="p">,</span> <span class="mi">150</span>
</span><span class='line'>         <span class="p">(</span><span class="mi">110</span><span class="p">)</span>
</span><span class='line'>         <span class="mi">226</span><span class="p">,</span> <span class="mi">250</span>
</span><span class='line'>         <span class="mi">425</span><span class="p">,</span> <span class="mi">426</span><span class="p">,</span> <span class="mi">451</span><span class="p">,</span> <span class="mi">551</span><span class="p">,</span> <span class="mi">552</span>
</span><span class='line'>      <span class="mi">532</span><span class="p">,</span> <span class="mi">450</span><span class="p">,</span> <span class="mi">452</span><span class="p">,</span> <span class="mi">553</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">421</span><span class="p">,</span> <span class="mi">530</span>
</span><span class='line'>   <span class="n">RETR</span>
</span><span class='line'>      <span class="mi">125</span><span class="p">,</span> <span class="mi">150</span>
</span><span class='line'>         <span class="p">(</span><span class="mi">110</span><span class="p">)</span>
</span><span class='line'>         <span class="mi">226</span><span class="p">,</span> <span class="mi">250</span>
</span><span class='line'>         <span class="mi">425</span><span class="p">,</span> <span class="mi">426</span><span class="p">,</span> <span class="mi">451</span>
</span><span class='line'>      <span class="mi">450</span><span class="p">,</span> <span class="mi">550</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">421</span><span class="p">,</span> <span class="mi">530</span>
</span><span class='line'>   <span class="n">LIST</span>
</span><span class='line'>      <span class="mi">125</span><span class="p">,</span> <span class="mi">150</span>
</span><span class='line'>         <span class="mi">226</span><span class="p">,</span> <span class="mi">250</span>
</span><span class='line'>         <span class="mi">425</span><span class="p">,</span> <span class="mi">426</span><span class="p">,</span> <span class="mi">451</span>
</span><span class='line'>      <span class="mi">450</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">421</span><span class="p">,</span> <span class="mi">530</span>
</span><span class='line'>   <span class="n">NLST</span>
</span><span class='line'>      <span class="mi">125</span><span class="p">,</span> <span class="mi">150</span>
</span><span class='line'>         <span class="mi">226</span><span class="p">,</span> <span class="mi">250</span>
</span><span class='line'>         <span class="mi">425</span><span class="p">,</span> <span class="mi">426</span><span class="p">,</span> <span class="mi">451</span>
</span><span class='line'>      <span class="mi">450</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">421</span><span class="p">,</span> <span class="mi">530</span>
</span><span class='line'>   <span class="n">APPE</span>
</span><span class='line'>      <span class="mi">125</span><span class="p">,</span> <span class="mi">150</span>
</span><span class='line'>         <span class="p">(</span><span class="mi">110</span><span class="p">)</span>
</span><span class='line'>         <span class="mi">226</span><span class="p">,</span> <span class="mi">250</span>
</span><span class='line'>         <span class="mi">425</span><span class="p">,</span> <span class="mi">426</span><span class="p">,</span> <span class="mi">451</span><span class="p">,</span> <span class="mi">551</span><span class="p">,</span> <span class="mi">552</span>
</span><span class='line'>      <span class="mi">532</span><span class="p">,</span> <span class="mi">450</span><span class="p">,</span> <span class="mi">550</span><span class="p">,</span> <span class="mi">452</span><span class="p">,</span> <span class="mi">553</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">421</span><span class="p">,</span> <span class="mi">530</span>
</span><span class='line'>   <span class="n">RNFR</span>
</span><span class='line'>      <span class="mi">450</span><span class="p">,</span> <span class="mi">550</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">421</span><span class="p">,</span> <span class="mi">530</span>
</span><span class='line'>      <span class="mi">350</span>
</span><span class='line'>   <span class="n">RNTO</span>
</span><span class='line'>      <span class="mi">250</span>
</span><span class='line'>      <span class="mi">532</span><span class="p">,</span> <span class="mi">553</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">503</span><span class="p">,</span> <span class="mi">421</span><span class="p">,</span> <span class="mi">530</span>
</span><span class='line'>   <span class="n">DELE</span>
</span><span class='line'>      <span class="mi">250</span>
</span><span class='line'>      <span class="mi">450</span><span class="p">,</span> <span class="mi">550</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">421</span><span class="p">,</span> <span class="mi">530</span>
</span><span class='line'>   <span class="n">RMD</span>
</span><span class='line'>      <span class="mi">250</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">421</span><span class="p">,</span> <span class="mi">530</span><span class="p">,</span> <span class="mi">550</span>
</span><span class='line'>   <span class="n">MKD</span>
</span><span class='line'>      <span class="mi">257</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">421</span><span class="p">,</span> <span class="mi">530</span><span class="p">,</span> <span class="mi">550</span>
</span><span class='line'>   <span class="n">PWD</span>
</span><span class='line'>      <span class="mi">257</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">421</span><span class="p">,</span> <span class="mi">550</span>
</span><span class='line'>   <span class="n">ABOR</span>
</span><span class='line'>      <span class="mi">225</span><span class="p">,</span> <span class="mi">226</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">421</span>
</span><span class='line'>
</span><span class='line'><span class="n">Informational</span> <span class="n">commands</span>
</span><span class='line'>   <span class="n">SYST</span>
</span><span class='line'>      <span class="mi">215</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">421</span>
</span><span class='line'>   <span class="n">STAT</span>
</span><span class='line'>      <span class="mi">211</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span> <span class="mi">213</span>
</span><span class='line'>      <span class="mi">450</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">421</span><span class="p">,</span> <span class="mi">530</span>
</span><span class='line'>   <span class="n">HELP</span>
</span><span class='line'>      <span class="mi">211</span><span class="p">,</span> <span class="mi">214</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">421</span>
</span><span class='line'><span class="n">Miscellaneous</span> <span class="n">commands</span>
</span><span class='line'>   <span class="n">SITE</span>
</span><span class='line'>      <span class="mi">200</span>
</span><span class='line'>      <span class="mi">202</span>
</span><span class='line'>      <span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">530</span>
</span><span class='line'>   <span class="n">NOOP</span>
</span><span class='line'>      <span class="mi">200</span>
</span><span class='line'>      <span class="mi">500</span> <span class="mi">421</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>



### 参考文章：

 * [http://www.w3.org/Protocols/rfc959/](http://www.w3.org/Protocols/rfc959)
 * [http://vod.sjtu.edu.cn/help/Article_Show.asp?ArticleID=137](http://vod.sjtu.edu.cn/help/Article_Show.asp?ArticleID=137)
 * [http://blog.miniasp.com/post/2008/06/29/FTP-Protocol-Definitive-Explanation.aspx](http://blog.miniasp.com/post/2008/06/29/FTP-Protocol-Definitive-Explanation.aspx)
 * Images come from Computer Networking: A Top Down Approach, 4th edition. Jim Kurose, Keith Ross Addison-Wesley, July 2007.
</decimal-integer></string></pathname></mode-code></structure-code></byte-size></sp></form-code></sp></form-code></sp></type-code></form-code></number></number></number></port-number></number></number></number></number></host-number></port-number></host-number></host-port></number></byte-size></pr-char></pr-string></pr-char></pr-char></pr-string></pr-string></marker></lf></cr></char></string></char></char></string></string></account-information></string></password></string></username>
]]></content>
  </entry>
  
</feed>
